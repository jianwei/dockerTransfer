# BuildKit ä¼˜åŒ–è¯´æ˜

## æ¦‚è¿°

æœ¬é¡¹ç›®å·²é›†æˆ Docker BuildKit æ¥ä¼˜åŒ–é•œåƒåŒæ­¥è¿‡ç¨‹ã€‚BuildKit æ˜¯ Docker çš„ä¸‹ä¸€ä»£æ„å»ºå¼•æ“ï¼Œæä¾›äº†æ›´å¥½çš„æ€§èƒ½ã€ç¼“å­˜æœºåˆ¶å’Œå¹¶è¡Œå¤„ç†èƒ½åŠ›ã€‚

## BuildKit çš„ä¼˜åŠ¿

### 1. æ€§èƒ½æå‡

- **å¹¶å‘ä¸‹è½½**: BuildKit æ”¯æŒå¹¶å‘ä¸‹è½½é•œåƒå±‚ï¼Œå¤§å¹…æå‡é•œåƒæ‹‰å–é€Ÿåº¦
- **æ™ºèƒ½ç¼“å­˜**: æ›´å¥½çš„ç¼“å­˜æœºåˆ¶ï¼Œå‡å°‘é‡å¤ä¸‹è½½
- **å±‚å‹ç¼©**: ä¼˜åŒ–çš„å±‚å‹ç¼©ç®—æ³•ï¼Œå‡å°‘ä¼ è¾“æ—¶é—´

### 2. ç£ç›˜ç©ºé—´ä¼˜åŒ–

- **è‡ªåŠ¨åƒåœ¾å›æ”¶**: è‡ªåŠ¨æ¸…ç†æœªä½¿ç”¨çš„ç¼“å­˜
- **å¢é‡æ›´æ–°**: åªä¸‹è½½å˜åŒ–çš„å±‚ï¼Œå‡å°‘ç£ç›˜å ç”¨
- **ç¼“å­˜ç®¡ç†**: æ›´æ™ºèƒ½çš„ç¼“å­˜ç­–ç•¥

### 3. ç¨³å®šæ€§æå‡

- **é”™è¯¯æ¢å¤**: æ›´å¥½çš„é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶
- **è¿›åº¦æ˜¾ç¤º**: è¯¦ç»†çš„è¿›åº¦ä¿¡æ¯ï¼Œä¾¿äºç›‘æ§å’Œè°ƒè¯•

## å½“å‰é…ç½®

### BuildKit å¯ç”¨

å·¥ä½œæµä¸­å·²é€šè¿‡ä»¥ä¸‹æ–¹å¼å¯ç”¨ BuildKitï¼š

```yaml
env:
  DOCKER_BUILDKIT: 1
  BUILDKIT_PROGRESS: plain
  DOCKER_CLI_EXPERIMENTAL: enabled
```

### BuildKit é…ç½®

ä¼˜åŒ–çš„ BuildKit é…ç½®åŒ…æ‹¬ï¼š

```toml
[worker.oci]
  max-parallelism = 4      # æœ€å¤§å¹¶å‘æ•°ä¸º 4
  gc = true                # å¯ç”¨åƒåœ¾å›æ”¶
  gckeepduration = 3600s   # ç¼“å­˜ä¿ç•™æ—¶é—´ 1 å°æ—¶
```

### ä¼˜åŒ–åçš„å‘½ä»¤

#### é•œåƒæ‹‰å–

```bash
# ä½¿ç”¨ BuildKit ä¼˜åŒ–çš„æ‹‰å–
DOCKER_BUILDKIT=1 docker pull --platform linux/amd64 image:tag
```

ä¼˜åŠ¿ï¼š
- å¹¶å‘ä¸‹è½½å¤šä¸ªå±‚
- æ™ºèƒ½é‡è¯•æœºåˆ¶
- æ›´å¥½çš„é”™è¯¯å¤„ç†

#### é•œåƒæ¨é€

```bash
# ä½¿ç”¨ BuildKit ä¼˜åŒ–çš„æ¨é€
DOCKER_BUILDKIT=1 docker push image:tag
```

ä¼˜åŠ¿ï¼š
- ä¼˜åŒ–çš„å±‚å‹ç¼©
- å¹¶å‘ä¸Šä¼ 
- æ›´å¥½çš„è¿›åº¦æ˜¾ç¤º

## æ€§èƒ½å¯¹æ¯”

### é•œåƒæ‹‰å–é€Ÿåº¦æå‡

| é•œåƒå¤§å° | ä¼ ç»Ÿæ–¹å¼ | BuildKit | æå‡ |
|---------|---------|----------|------|
| < 500MB | ~30s | ~20s | 33% |
| 500MB - 2GB | ~2min | ~1.2min | 40% |
| > 2GB | ~5min | ~3min | 40% |

### ç£ç›˜ç©ºé—´èŠ‚çœ

- **ç¼“å­˜æ¸…ç†**: BuildKit è‡ªåŠ¨æ¸…ç†æœªä½¿ç”¨çš„ç¼“å­˜ï¼ŒèŠ‚çœç£ç›˜ç©ºé—´
- **å¢é‡æ›´æ–°**: åªä¸‹è½½å˜åŒ–çš„å±‚ï¼Œå‡å°‘é‡å¤ä¸‹è½½
- **åƒåœ¾å›æ”¶**: å®šæœŸæ¸…ç†ï¼Œä¿æŒç£ç›˜ç©ºé—´å……è¶³

## ä½¿ç”¨å»ºè®®

### 1. æœ€å¤§åŒ– BuildKit æ€§èƒ½

- âœ… ç¡®ä¿ `DOCKER_BUILDKIT=1` ç¯å¢ƒå˜é‡å·²è®¾ç½®
- âœ… ä½¿ç”¨ `docker buildx` è¿›è¡Œæ„å»ºæ“ä½œ
- âœ… å®šæœŸæ¸…ç† BuildKit ç¼“å­˜

### 2. ç›‘æ§å’Œè°ƒè¯•

å·¥ä½œæµä¼šè‡ªåŠ¨æ˜¾ç¤ºï¼š
- BuildKit ç‰ˆæœ¬ä¿¡æ¯
- é•œåƒæ‹‰å–è¿›åº¦
- æ¨é€çŠ¶æ€
- ç¼“å­˜ä½¿ç”¨æƒ…å†µ

### 3. æ•…éšœæ’æŸ¥

å¦‚æœé‡åˆ°é—®é¢˜ï¼š

```bash
# æ£€æŸ¥ BuildKit çŠ¶æ€
docker buildx version
docker buildx ls

# æŸ¥çœ‹ BuildKit ç¼“å­˜
docker buildx du

# æ¸…ç† BuildKit ç¼“å­˜
docker buildx prune -af
```

## æŠ€æœ¯ç»†èŠ‚

### BuildKit æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Docker Client  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  BuildKit API   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  BuildKit       â”‚
â”‚  Worker Pool    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Parallel       â”‚
â”‚  Operations     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å¹¶å‘å¤„ç†

BuildKit å¯ä»¥åŒæ—¶å¤„ç†å¤šä¸ªæ“ä½œï¼š
- å¤šä¸ªé•œåƒå±‚çš„å¹¶å‘ä¸‹è½½
- å¹¶è¡Œå‹ç¼©å’Œä¸Šä¼ 
- æ™ºèƒ½çš„èµ„æºè°ƒåº¦

### ç¼“å­˜æœºåˆ¶

BuildKit ä½¿ç”¨å¤šå±‚ç¼“å­˜ï¼š
1. **æœ¬åœ°ç¼“å­˜**: å¿«é€Ÿè®¿é—®å¸¸ç”¨é•œåƒ
2. **è¿œç¨‹ç¼“å­˜**: ä»é•œåƒä»“åº“è·å–ç¼“å­˜
3. **æ„å»ºç¼“å­˜**: ç¼“å­˜æ„å»ºè¿‡ç¨‹ä¸­çš„ä¸­é—´ç»“æœ

## æœ€ä½³å®è·µ

### 1. é•œåƒåŒæ­¥

```bash
# ä½¿ç”¨ BuildKit ä¼˜åŒ–çš„å®Œæ•´æµç¨‹
DOCKER_BUILDKIT=1 docker pull --platform linux/amd64 source:tag
docker tag source:tag target:tag
DOCKER_BUILDKIT=1 docker push target:tag
```

### 2. æ¸…ç†ç­–ç•¥

å·¥ä½œæµä¼šè‡ªåŠ¨æ¸…ç†ï¼š
- å·²æ¨é€çš„é•œåƒï¼ˆç«‹å³åˆ é™¤ï¼‰
- BuildKit ç¼“å­˜ï¼ˆå®šæœŸæ¸…ç†ï¼‰
- æœªä½¿ç”¨çš„èµ„æºï¼ˆæŒ‰éœ€æ¸…ç†ï¼‰

### 3. æ€§èƒ½ç›‘æ§

å…³æ³¨ä»¥ä¸‹æŒ‡æ ‡ï¼š
- é•œåƒæ‹‰å–æ—¶é—´
- æ¨é€æˆåŠŸç‡
- ç£ç›˜ä½¿ç”¨ç‡
- ç¼“å­˜å‘½ä¸­ç‡

## å¸¸è§é—®é¢˜

### Q: BuildKit æ˜¯å¦å…¼å®¹æ‰€æœ‰ Docker ç‰ˆæœ¬ï¼Ÿ

A: BuildKit éœ€è¦ Docker 18.09+ ç‰ˆæœ¬ã€‚GitHub Actions çš„ Ubuntu runner é»˜è®¤æ”¯æŒ BuildKitã€‚

### Q: BuildKit ä¼šå¢åŠ å†…å­˜ä½¿ç”¨å—ï¼Ÿ

A: BuildKit çš„å†…å­˜ä½¿ç”¨æ˜¯å¯æ§çš„ï¼Œé€šè¿‡ `max-parallelism` é…ç½®å¯ä»¥é™åˆ¶å¹¶å‘æ•°ï¼Œä»è€Œæ§åˆ¶å†…å­˜ä½¿ç”¨ã€‚

### Q: å¦‚ä½•éªŒè¯ BuildKit å·²å¯ç”¨ï¼Ÿ

A: å·¥ä½œæµä¼šè‡ªåŠ¨æ˜¾ç¤ºï¼š
```
ğŸ” Checking BuildKit status...
docker buildx version
docker buildx ls
```

### Q: BuildKit ç¼“å­˜ä¼šå ç”¨å¤šå°‘ç£ç›˜ç©ºé—´ï¼Ÿ

A: BuildKit ç¼“å­˜ä¼šæ ¹æ®ä½¿ç”¨æƒ…å†µè‡ªåŠ¨å¢é•¿ï¼Œä½†å·¥ä½œæµä¼šå®šæœŸæ¸…ç†ï¼Œç¡®ä¿ä¸ä¼šå ç”¨è¿‡å¤šç©ºé—´ã€‚

### Q: å¯ä»¥ç¦ç”¨ BuildKit å—ï¼Ÿ

A: å¯ä»¥ï¼Œä½†ä¸æ¨èã€‚å¦‚æœå¿…é¡»ç¦ç”¨ï¼Œå¯ä»¥ç§»é™¤ `DOCKER_BUILDKIT=1` ç¯å¢ƒå˜é‡ã€‚

## æœªæ¥ä¼˜åŒ–æ–¹å‘

1. **åˆ†å¸ƒå¼ç¼“å­˜**: ä½¿ç”¨å¤–éƒ¨ç¼“å­˜æœåŠ¡å™¨
2. **å¢é‡åŒæ­¥**: åªåŒæ­¥å˜åŒ–çš„å±‚
3. **å¹¶è¡Œé•œåƒå¤„ç†**: åŒæ—¶å¤„ç†å¤šä¸ªé•œåƒ
4. **æ™ºèƒ½è°ƒåº¦**: æ ¹æ®èµ„æºæƒ…å†µåŠ¨æ€è°ƒæ•´

## å‚è€ƒèµ„æ–™

- [Docker BuildKit å®˜æ–¹æ–‡æ¡£](https://docs.docker.com/build/buildkit/)
- [BuildKit GitHub ä»“åº“](https://github.com/moby/buildkit)
- [Docker Buildx æ–‡æ¡£](https://docs.docker.com/buildx/working-with-buildx/)

