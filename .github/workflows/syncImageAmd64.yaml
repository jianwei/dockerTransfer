name: Sync Image to Aliyun Amd64 Only

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *'

jobs:
  sync-images:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Setup Docker and dependencies
      run: |
        echo "=== Initial disk space ==="
        df -h

        sudo apt-get update
        sudo apt-get install -y jq skopeo

        # è®¾ç½® Docker buildx ç”¨äºåˆ›å»º manifest
        docker buildx create --use --name mybuilder --driver docker-container 2>/dev/null || docker buildx use mybuilder

        echo "=== Disk space after install ==="
        df -h

    - name: Login to Alibaba Cloud Container Registry
      run: |
        # Docker login
        echo "${{ secrets.ALIYUN_PASSWORD }}" | docker login \
          --username "${{ secrets.ALIYUN_USERNAME }}" \
          --password-stdin \
          registry.cn-hangzhou.aliyuncs.com

        # Skopeo login
        skopeo login \
          --username "${{ secrets.ALIYUN_USERNAME }}" \
          --password "${{ secrets.ALIYUN_PASSWORD }}" \
          registry.cn-hangzhou.aliyuncs.com

    - name: Process images
      run: |
        set +e
        set -x

        count=$(jq 'length' images-small.json)
        echo "Found $count images to process"

        for i in $(seq 0 $((count-1))); do
          echo "=== Processing image $((i+1))/$count ==="

          source=$(jq -r ".[$i].source" images-small.json)
          target=$(jq -r ".[$i].target" images-small.json)
          tag_count=$(jq ".[$i].tags | length" images-small.json)

          if [ "$source" = "null" ] || [ "$target" = "null" ]; then
            echo "âŒ Invalid data at index $i"
            continue
          fi

          # æ£€æŸ¥æ˜¯å¦åŒ…å« amd64 æ¶æ„
          has_amd64=$(jq -r ".[$i].architectures[]" images-small.json | grep -q "amd64" && echo "true" || echo "false")

          if [ "$has_amd64" != "true" ]; then
            echo "â­ï¸  Skipping image $target (no amd64 architecture)"
            continue
          fi

          for j in $(seq 0 $((tag_count-1))); do
            tag=$(jq -r ".[$i].tags[$j]" images-small.json)

            # æ„å»ºæºé•œåƒåç§°
            if echo "$source" | grep -q ":"; then
              source_image="$source"
            else
              source_image="${source}:${tag}"
            fi

            target_image="registry.cn-hangzhou.aliyuncs.com/${{ secrets.ALIYUN_NAMESPACE_GITHUB_BYE_BYE }}/${target}:${tag}"

            echo "ğŸ“¥ Syncing $source_image (amd64) to $target_image"

            # æ£€æŸ¥æºé•œåƒçš„ manifest
            echo "ğŸ“‹ Inspecting source image manifest..."
            source_manifest=$(skopeo inspect --raw "docker://$source_image" 2>/dev/null || echo "")

            if [ -z "$source_manifest" ]; then
              echo "âŒ Failed to inspect source image: $source_image"
              continue
            fi

            # æ£€æŸ¥æ˜¯å¦æ˜¯å¤šæ¶æ„é•œåƒ
            if echo "$source_manifest" | jq -e '.manifests' > /dev/null 2>&1; then
              echo "ğŸ“Š Source is a multi-arch image, extracting amd64 digest..."

              # è·å– amd64 æ¶æ„çš„ digest
              amd64_digest=$(echo "$source_manifest" | jq -r '.manifests[] | select(.platform.architecture == "amd64" and .platform.os == "linux") | .digest' | head -n1)

              if [ -z "$amd64_digest" ] || [ "$amd64_digest" = "null" ]; then
                echo "âŒ No amd64 architecture found in manifest"
                continue
              fi

              echo "âœ… Found amd64 digest: $amd64_digest"

              # æå–é•œåƒåç§°ï¼ˆå»æ‰æ ‡ç­¾ï¼‰
              if echo "$source_image" | grep -q ":"; then
                image_name=$(echo "$source_image" | sed 's/:[^@]*$//')
              else
                image_name="$source_image"
              fi

              # ä½¿ç”¨ skopeo ç›´æ¥å¤åˆ¶ç‰¹å®šæ¶æ„çš„é•œåƒåˆ°ä¸´æ—¶æ ‡ç­¾
              temp_target="registry.cn-hangzhou.aliyuncs.com/${{ secrets.ALIYUN_NAMESPACE_GITHUB_BYE_BYE }}/${target}:${tag}-amd64-temp"
              echo "ğŸ“¤ Copying amd64 image to temp tag..."

              if timeout 3600 skopeo copy \
                --src-tls-verify=false \
                --dest-tls-verify=false \
                --retry-times 5 \
                "docker://${image_name}@${amd64_digest}" \
                "docker://$temp_target" 2>&1; then
                echo "âœ… Successfully copied amd64 version to temp tag"
              else
                copy_exit_code=$?
                if [ $copy_exit_code -eq 124 ]; then
                  echo "â±ï¸  Copy timed out after 60 minutes"
                else
                  echo "âŒ Failed to copy amd64 version (exit code: $copy_exit_code)"
                fi
                continue
              fi

              # ä½¿ç”¨ docker buildx imagetools åˆ›å»ºå¸¦æœ‰æ­£ç¡® manifest çš„é•œåƒ
              echo "ğŸ”— Creating manifest list for proper display..."
              if docker buildx imagetools create -t "$target_image" "$temp_target" 2>&1; then
                echo "âœ… Successfully created manifest list"
              else
                echo "âš ï¸  Failed to create manifest list, using temp image directly"
                # å¦‚æœåˆ›å»ºå¤±è´¥ï¼Œç›´æ¥å¤åˆ¶åˆ°æœ€ç»ˆç›®æ ‡
                skopeo copy --dest-tls-verify=false "docker://$temp_target" "docker://$target_image" 2>&1 || true
              fi

            else
              echo "ğŸ“Š Source is a single-arch image, copying directly..."

              # å•æ¶æ„é•œåƒï¼Œç›´æ¥å¤åˆ¶
              if timeout 3600 skopeo copy \
                --src-tls-verify=false \
                --dest-tls-verify=false \
                --retry-times 5 \
                "docker://$source_image" \
                "docker://$target_image" 2>&1; then
                echo "âœ… Successfully synced image via skopeo"
              else
                copy_exit_code=$?
                echo "âŒ Failed to copy image (exit code: $copy_exit_code)"
                continue
              fi
            fi

            # éªŒè¯ç›®æ ‡é•œåƒ
            echo "ğŸ” Verifying target image..."
            if skopeo inspect "docker://$target_image" >/dev/null 2>&1; then
              echo "âœ… Target image verified successfully"

              # æ˜¾ç¤ºé•œåƒä¿¡æ¯
              image_layers=$(skopeo inspect "docker://$target_image" 2>/dev/null | jq -r '.Layers // [] | length')
              image_digest=$(skopeo inspect "docker://$target_image" 2>/dev/null | jq -r '.Digest // "unknown"')
              echo "ğŸ“Š Image has $image_layers layers, digest: $image_digest"
            else
              echo "âš ï¸  Warning: Target image verification failed"
            fi
          done

          # æ¸…ç†ç£ç›˜ç©ºé—´
          echo "ğŸ§¹ Cleaning up after image $((i+1))..."
          docker system prune -af >/dev/null 2>&1 || true
          echo "=== Disk space after cleanup ==="
          df -h
        done

    - name: Summary
      if: always()
      run: |
        echo "ğŸ Processing completed"
        echo "=== Final disk space ==="
        df -h