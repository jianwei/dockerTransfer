name: Optimize and Push Docker Images to GitHub Container Registry

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * *'  # æ¯å¤©å‡Œæ™¨3ç‚¹æ‰§è¡Œ

env:
  REGISTRY: ghcr.io
  # ä½¿ç”¨ ${{ github.repository_owner }} è‡ªåŠ¨è·å–ä»“åº“æ‰€æœ‰è€…ä½œä¸ºå‘½åç©ºé—´

jobs:
  optimize-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y jq python3-pip
        pip3 install docker-squash || echo "docker-squashå®‰è£…å¤±è´¥ï¼Œå°†ä½¿ç”¨å…¶ä»–ä¼˜åŒ–æ–¹æ³•"

    - name: Make optimize script executable
      run: chmod +x scripts/optimizeDockerImage.sh

    - name: Clean Docker system before processing
      run: |
        echo "ğŸ§¹ æ¸…ç†Dockerç³»ç»Ÿ..."
        docker system prune -af --volumes || true
        echo "ğŸ’¾ å¤„ç†å‰ç£ç›˜ç©ºé—´:"
        df -h

    - name: Process and optimize images
      run: |
        set -euo pipefail
        
        # å®šä¹‰æ¸…ç†å‡½æ•°
        cleanup_docker() {
          echo "ğŸ§¹ æ‰§è¡ŒDockeræ¸…ç†..."
          docker system prune -af --volumes || true
          echo "ğŸ’¾ æ¸…ç†åç£ç›˜ç©ºé—´:"
          df -h
        }
        
        # è·å–GitHubä»“åº“å‘½åç©ºé—´
        GITHUB_NAMESPACE="${{ github.repository_owner }}"
        
        # è¯»å–images.jsoné…ç½®
        count=$(jq 'length' images.json)
        echo "æ‰¾åˆ° $count ä¸ªé•œåƒéœ€è¦å¤„ç†"
        
        # å¤„ç†æ¯ä¸ªé•œåƒ
        for i in $(seq 0 $((count-1))); do
          echo "=== å¤„ç†é•œåƒ $((i+1))/$count ==="
          
          source=$(jq -r ".[$i].source" images.json)
          target=$(jq -r ".[$i].target" images.json)
          
          if [ "$source" = "null" ] || [ "$target" = "null" ]; then
            echo "âŒ ç´¢å¼• $i å¤„çš„æ•°æ®æ— æ•ˆ"
            continue
          fi
          
          tag_count=$(jq ".[$i].tags | length" images.json)
          arch_count=$(jq ".[$i].architectures | length" images.json)
          
          echo "æºé•œåƒ: $source"
          echo "ç›®æ ‡é•œåƒ: $target"
          echo "æ ‡ç­¾æ•°é‡: $tag_count"
          echo "æ¶æ„æ•°é‡: $arch_count"
          
          # æå–åŸºç¡€é•œåƒåç§°
          base_image=$(echo "$source" | cut -d: -f1)
          
          # å¤„ç†æ¯ä¸ªæ ‡ç­¾
          for j in $(seq 0 $((tag_count-1))); do
            tag=$(jq -r ".[$i].tags[$j]" images.json)
            echo "ğŸ·ï¸  å¤„ç†æ ‡ç­¾: $tag"
            
            image_ref="${base_image}:${tag}"
            
            # å¤„ç†æ¯ä¸ªæ¶æ„
            for k in $(seq 0 $((arch_count-1))); do
              arch=$(jq -r ".[$i].architectures[$k]" images.json)
              
              # æ˜ å°„æ¶æ„åˆ°å¹³å°
              case "$arch" in
                "amd64") platform="linux/amd64"; suffix="amd64" ;;
                "arm64") platform="linux/arm64"; suffix="arm64" ;;
                "arm/v7"|"arm") platform="linux/arm/v7"; suffix="armv7" ;;
                *) platform="linux/$arch"; suffix="$arch" ;;
              esac
              
              # æ„å»ºç›®æ ‡é•œåƒåœ°å€
              final_target="${{ env.REGISTRY }}/${GITHUB_NAMESPACE}/${target}-${suffix}:${tag}"
              echo "ğŸ–¥ï¸  å¤„ç†æ¶æ„: $arch ($platform)"
              
              # æ£€æŸ¥ç£ç›˜ç©ºé—´
              usage_percent=$(df / | tail -1 | awk '{print $5}' | sed 's/%//')
              available_gb=$(df / | tail -1 | awk '{print int($4/1024/1024)}')
              echo "ğŸ“Š å½“å‰ç£ç›˜ä½¿ç”¨ç‡: ${usage_percent}%, å¯ç”¨ç©ºé—´: ${available_gb}GB"
              
              # å¦‚æœç£ç›˜ä½¿ç”¨ç‡è¶…è¿‡60%ï¼Œæ‰§è¡Œæ¸…ç†
              if [ "$usage_percent" -gt 60 ]; then
                echo "âš ï¸  ç£ç›˜ä½¿ç”¨ç‡è¿‡é«˜ï¼Œæ‰§è¡Œæ¸…ç†..."
                cleanup_docker
              fi
              
              # æ‹‰å–æºé•œåƒ
              echo "ğŸ“¥ æ‹‰å– $image_ref ($arch)..."
              pull_success=false
              for retry in 1 2 3; do
                if docker pull --platform "$platform" "$image_ref"; then
                  pull_success=true
                  break
                else
                  if [ $retry -lt 3 ]; then
                    echo "âš ï¸  æ‹‰å–å¤±è´¥ (å°è¯• $retry)ï¼Œæ¸…ç†åé‡è¯•..."
                    cleanup_docker
                    sleep 3
                  fi
                fi
              done
              
              if [ "$pull_success" = true ]; then
                echo "âœ… $arch æ‹‰å–æˆåŠŸ"
                
                # ä½¿ç”¨ä¼˜åŒ–è„šæœ¬ä¼˜åŒ–é•œåƒå¤§å°
                echo "ğŸ”§ ä½¿ç”¨ä¼˜åŒ–è„šæœ¬ä¼˜åŒ–é•œåƒå¤§å°..."
                if ./scripts/optimizeDockerImage.sh "$image_ref" "$final_target" --compress --platform "$platform"; then
                  echo "âœ… é•œåƒä¼˜åŒ–æˆåŠŸ"
                else
                  echo "âš ï¸  ä¼˜åŒ–å¤±è´¥ï¼Œä½¿ç”¨åŸå§‹é•œåƒ"
                  docker tag "$image_ref" "$final_target"
                fi
                
                # æ¨é€åˆ°GitHub Container Registry
                echo "ğŸ“¤ æ¨é€åˆ° $final_target..."
                if docker push "$final_target"; then
                  echo "âœ… $arch ç‰ˆæœ¬æ¨é€æˆåŠŸ: $final_target"
                else
                  echo "âŒ æ¨é€ $arch ç‰ˆæœ¬å¤±è´¥"
                fi
                
                # æ¸…ç†æœ¬åœ°é•œåƒ
                docker rmi "$final_target" || true
                docker rmi "$image_ref" || true
              else
                echo "â­ï¸  $arch åœ¨3æ¬¡å°è¯•åä»ä¸å¯ç”¨ï¼Œè·³è¿‡"
              fi
              
              # æ¯ä¸ªæ¶æ„å¤„ç†å®Œåæ¸…ç†
              echo "ğŸ§¹ æ¶æ„å¤„ç†å®Œæˆåæ¸…ç†..."
              docker image prune -f || true
            done
            
            # æ¯ä¸ªæ ‡ç­¾å¤„ç†å®Œåæ¸…ç†
            echo "ğŸ§¹ æ ‡ç­¾å¤„ç†å®Œæˆåæ¸…ç†..."
            cleanup_docker
          done
          
          # æ¯ä¸ªé•œåƒå¤„ç†å®Œåæ¸…ç†
          echo "ğŸ§¹ é•œåƒå¤„ç†å®Œæˆåæ¸…ç†..."
          cleanup_docker
        done

    - name: Summary
      if: always()
      run: |
        echo "ğŸ å¤„ç†å®Œæˆ"
        echo "=== æœ€ç»ˆDockeré•œåƒ ==="
        docker images | head -20 || echo "æœªæ‰¾åˆ°é•œåƒ"
        echo ""
        echo "ğŸ’¾ æœ€ç»ˆç£ç›˜ä½¿ç”¨æƒ…å†µ:"
        df -h
        echo ""
        echo "ğŸ³ Dockerç³»ç»Ÿä½¿ç”¨æƒ…å†µ:"
        docker system df || true

