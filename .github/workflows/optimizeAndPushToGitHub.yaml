name: Optimize and Push Docker Images to GitHub Container Registry

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * *'  # æ¯å¤©å‡Œæ™¨3ç‚¹æ‰§è¡Œ

env:
  REGISTRY: ghcr.io
  # ä½¿ç”¨ ${{ github.repository_owner }} è‡ªåŠ¨è·å–ä»“åº“æ‰€æœ‰è€…ä½œä¸ºå‘½åç©ºé—´

jobs:
  optimize-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y jq python3-pip
        pip3 install docker-squash || echo "docker-squashå®‰è£…å¤±è´¥ï¼Œå°†ä½¿ç”¨å…¶ä»–ä¼˜åŒ–æ–¹æ³•"

    - name: Make optimize script executable
      run: chmod +x scripts/optimizeDockerImage.sh

    - name: Clean Docker system before processing
      run: |
        echo "ğŸ§¹ æ¸…ç†Dockerç³»ç»Ÿ..."
        docker system prune -af --volumes || true
        echo "ğŸ’¾ å¤„ç†å‰ç£ç›˜ç©ºé—´:"
        df -h

    - name: Process and optimize images
      run: |
        set -euo pipefail
        
        # å®šä¹‰æ¸…ç†å‡½æ•°
        cleanup_docker() {
          echo "ğŸ§¹ æ‰§è¡ŒDockeræ¸…ç†..."
          docker system prune -af --volumes || true
          echo "ğŸ’¾ æ¸…ç†åç£ç›˜ç©ºé—´:"
          df -h
        }
        
        # å¼ºåˆ¶æ¸…ç†å‡½æ•°ï¼Œç”¨äºå¤§é•œåƒå¤„ç†
        force_cleanup() {
          echo "ğŸ§¹ æ‰§è¡Œå¼ºåˆ¶æ¸…ç†..."
          # åœæ­¢æ‰€æœ‰è¿è¡Œä¸­çš„å®¹å™¨
          running_containers=$(docker ps -q)
          if [ -n "$running_containers" ]; then
            echo "$running_containers" | xargs docker stop || true
          fi
          # åˆ é™¤æ‰€æœ‰å®¹å™¨
          container_ids=$(docker ps -aq)
          if [ -n "$container_ids" ]; then
            echo "$container_ids" | xargs docker rm -f || true
          fi
          # åˆ é™¤æ‰€æœ‰é•œåƒ
          image_ids=$(docker images -q)
          if [ -n "$image_ids" ]; then
            echo "$image_ids" | xargs docker rmi -f || true
          fi
          # æ¸…ç†æ‰€æœ‰èµ„æº
          docker volume prune -f || true
          docker network prune -f || true
          docker builder prune -af || true
          docker system prune -af --volumes || true
          echo "ğŸ’¾ å¼ºåˆ¶æ¸…ç†åç£ç›˜ç©ºé—´:"
          df -h
        }
        
        # æ£€æŸ¥æ˜¯å¦ä¸ºå¤§é•œåƒ
        is_large_image() {
          local image_name="$1"
          # æ£€æµ‹å¸¸è§çš„å¤§é•œåƒåç§°æ¨¡å¼
          if echo "$image_name" | grep -qiE "(vllm|pytorch|tensorflow|large|big|ml|ai|gpu|cuda)"; then
            return 0
          fi
          return 1
        }
        
        # ç¡®ä¿æœ‰è¶³å¤Ÿç©ºé—´ï¼ˆå¯¹å¤§é•œåƒéœ€è¦æ›´å¤šç©ºé—´ï¼‰
        ensure_space() {
          local image_name="$1"
          local min_space_gb=15  # é»˜è®¤æœ€å°‘éœ€è¦15GB
          
          if is_large_image "$image_name"; then
            min_space_gb=25  # å¤§é•œåƒéœ€è¦è‡³å°‘25GB
            echo "âš ï¸  æ£€æµ‹åˆ°å¤§é•œåƒï¼Œéœ€è¦è‡³å°‘ ${min_space_gb}GB å¯ç”¨ç©ºé—´"
          fi
          
          usage_percent=$(df / | tail -1 | awk '{print $5}' | sed 's/%//')
          available_gb=$(df / | tail -1 | awk '{print int($4/1024/1024)}')
          
          echo "ğŸ“Š ç£ç›˜çŠ¶æ€: ä½¿ç”¨ç‡ ${usage_percent}%, å¯ç”¨ç©ºé—´ ${available_gb}GB"
          
          # å¦‚æœä½¿ç”¨ç‡è¶…è¿‡65%æˆ–å¯ç”¨ç©ºé—´ä¸è¶³ï¼Œæ‰§è¡Œæ¸…ç†
          if [ "$usage_percent" -gt 65 ] || [ "$available_gb" -lt "$min_space_gb" ]; then
            echo "âš ï¸  ç©ºé—´ä¸è¶³ï¼Œæ‰§è¡Œæ¸…ç†..."
            if [ "$usage_percent" -gt 70 ] || [ "$available_gb" -lt "$min_space_gb" ]; then
              force_cleanup
            else
              cleanup_docker
            fi
            
            # æ¸…ç†åå†æ¬¡æ£€æŸ¥
            usage_percent=$(df / | tail -1 | awk '{print $5}' | sed 's/%//')
            available_gb=$(df / | tail -1 | awk '{print int($4/1024/1024)}')
            echo "ğŸ“Š æ¸…ç†åç£ç›˜çŠ¶æ€: ä½¿ç”¨ç‡ ${usage_percent}%, å¯ç”¨ç©ºé—´ ${available_gb}GB"
            
            # å¦‚æœä»ç„¶ä¸è¶³ï¼Œè¿”å›å¤±è´¥
            if [ "$available_gb" -lt "$min_space_gb" ]; then
              echo "âŒ æ¸…ç†åä»ç„¶ç©ºé—´ä¸è¶³ï¼Œéœ€è¦è‡³å°‘ ${min_space_gb}GB"
              return 1
            fi
          fi
          
          return 0
        }
        
        # è·å–GitHubä»“åº“å‘½åç©ºé—´
        GITHUB_NAMESPACE="${{ github.repository_owner }}"
        
        # è¯»å–images.jsoné…ç½®
        count=$(jq 'length' images.json)
        echo "æ‰¾åˆ° $count ä¸ªé•œåƒéœ€è¦å¤„ç†"
        
        # å¤„ç†æ¯ä¸ªé•œåƒ
        for i in $(seq 0 $((count-1))); do
          echo "=== å¤„ç†é•œåƒ $((i+1))/$count ==="
          
          source=$(jq -r ".[$i].source" images.json)
          target=$(jq -r ".[$i].target" images.json)
          
          if [ "$source" = "null" ] || [ "$target" = "null" ]; then
            echo "âŒ ç´¢å¼• $i å¤„çš„æ•°æ®æ— æ•ˆ"
            continue
          fi
          
          tag_count=$(jq ".[$i].tags | length" images.json)
          arch_count=$(jq ".[$i].architectures | length" images.json)
          
          echo "æºé•œåƒ: $source"
          echo "ç›®æ ‡é•œåƒ: $target"
          echo "æ ‡ç­¾æ•°é‡: $tag_count"
          echo "æ¶æ„æ•°é‡: $arch_count"
          
          # æå–åŸºç¡€é•œåƒåç§°
          base_image=$(echo "$source" | cut -d: -f1)
          
          # å¤„ç†æ¯ä¸ªæ ‡ç­¾
          for j in $(seq 0 $((tag_count-1))); do
            tag=$(jq -r ".[$i].tags[$j]" images.json)
            echo "ğŸ·ï¸  å¤„ç†æ ‡ç­¾: $tag"
            
            image_ref="${base_image}:${tag}"
            
            # å¤„ç†æ¯ä¸ªæ¶æ„
            for k in $(seq 0 $((arch_count-1))); do
              arch=$(jq -r ".[$i].architectures[$k]" images.json)
              
              # æ˜ å°„æ¶æ„åˆ°å¹³å°
              case "$arch" in
                "amd64") platform="linux/amd64"; suffix="amd64" ;;
                "arm64") platform="linux/arm64"; suffix="arm64" ;;
                "arm/v7"|"arm") platform="linux/arm/v7"; suffix="armv7" ;;
                *) platform="linux/$arch"; suffix="$arch" ;;
              esac
              
              # æ„å»ºç›®æ ‡é•œåƒåœ°å€
              final_target="${{ env.REGISTRY }}/${GITHUB_NAMESPACE}/${target}-${suffix}:${tag}"
              echo "ğŸ–¥ï¸  å¤„ç†æ¶æ„: $arch ($platform)"
              
              # æ£€æŸ¥å¹¶ç¡®ä¿æœ‰è¶³å¤Ÿç©ºé—´
              if ! ensure_space "$source"; then
                echo "âŒ ç©ºé—´ä¸è¶³ï¼Œè·³è¿‡æ­¤é•œåƒ"
                continue
              fi
              
              # æ‹‰å–æºé•œåƒ
              echo "ğŸ“¥ æ‹‰å– $image_ref ($arch)..."
              pull_success=false
              for retry in 1 2 3; do
                # æ‹‰å–å‰å†æ¬¡æ£€æŸ¥ç©ºé—´
                if ! ensure_space "$source"; then
                  echo "âŒ æ‹‰å–å‰ç©ºé—´æ£€æŸ¥å¤±è´¥ï¼Œè·³è¿‡"
                  break
                fi
                
                if docker pull --platform "$platform" "$image_ref"; then
                  pull_success=true
                  break
                else
                  if [ $retry -lt 3 ]; then
                    echo "âš ï¸  æ‹‰å–å¤±è´¥ (å°è¯• $retry)ï¼Œæ‰§è¡Œå¼ºåˆ¶æ¸…ç†åé‡è¯•..."
                    force_cleanup
                    sleep 5
                  fi
                fi
              done
              
              if [ "$pull_success" = true ]; then
                echo "âœ… $arch æ‹‰å–æˆåŠŸ"
                
                # æ‹‰å–åç«‹å³æ¸…ç†æœªä½¿ç”¨çš„é•œåƒï¼Œé‡Šæ”¾ç©ºé—´
                echo "ğŸ§¹ æ‹‰å–åæ¸…ç†æœªä½¿ç”¨çš„é•œåƒ..."
                docker image prune -f || true
                
                # æ£€æŸ¥é•œåƒå¤§å°
                image_size=$(docker image inspect "$image_ref" --format='{{.Size}}' 2>/dev/null || echo "0")
                image_size_gb=$((image_size / 1073741824))
                echo "ğŸ“¦ é•œåƒå¤§å°: ${image_size_gb}GB"
                
                # ä½¿ç”¨ä¼˜åŒ–è„šæœ¬ä¼˜åŒ–é•œåƒå¤§å°
                echo "ğŸ”§ ä½¿ç”¨ä¼˜åŒ–è„šæœ¬ä¼˜åŒ–é•œåƒå¤§å°..."
                if ./scripts/optimizeDockerImage.sh "$image_ref" "$final_target" --compress --platform "$platform"; then
                  echo "âœ… é•œåƒä¼˜åŒ–æˆåŠŸ"
                else
                  echo "âš ï¸  ä¼˜åŒ–å¤±è´¥ï¼Œä½¿ç”¨åŸå§‹é•œåƒ"
                  docker tag "$image_ref" "$final_target"
                fi
                
                # æ¨é€åˆ°GitHub Container Registry
                echo "ğŸ“¤ æ¨é€åˆ° $final_target..."
                push_success=false
                for push_retry in 1 2 3; do
                  if docker push "$final_target"; then
                    push_success=true
                    echo "âœ… $arch ç‰ˆæœ¬æ¨é€æˆåŠŸ: $final_target"
                    break
                  else
                    if [ $push_retry -lt 3 ]; then
                      echo "âš ï¸  æ¨é€å¤±è´¥ (å°è¯• $push_retry)ï¼Œé‡è¯•..."
                      sleep 3
                    fi
                  fi
                done
                
                if [ "$push_success" = false ]; then
                  echo "âŒ æ¨é€ $arch ç‰ˆæœ¬å¤±è´¥"
                fi
                
                # ç«‹å³æ¸…ç†æœ¬åœ°é•œåƒï¼Œé‡Šæ”¾ç©ºé—´
                echo "ğŸ§¹ ç«‹å³æ¸…ç†æœ¬åœ°é•œåƒ..."
                docker rmi "$final_target" || true
                docker rmi "$image_ref" || true
                docker image prune -f || true
                
                # æ˜¾ç¤ºæ¸…ç†åçš„ç©ºé—´
                usage_percent=$(df / | tail -1 | awk '{print $5}' | sed 's/%//')
                available_gb=$(df / | tail -1 | awk '{print int($4/1024/1024)}')
                echo "ğŸ“Š æ¸…ç†åç£ç›˜çŠ¶æ€: ä½¿ç”¨ç‡ ${usage_percent}%, å¯ç”¨ç©ºé—´ ${available_gb}GB"
              else
                echo "â­ï¸  $arch åœ¨3æ¬¡å°è¯•åä»ä¸å¯ç”¨ï¼Œè·³è¿‡"
              fi
              
              # æ¯ä¸ªæ¶æ„å¤„ç†å®Œåæ¸…ç†
              echo "ğŸ§¹ æ¶æ„å¤„ç†å®Œæˆåæ¸…ç†..."
              docker image prune -f || true
            done
            
            # æ¯ä¸ªæ ‡ç­¾å¤„ç†å®Œåæ¸…ç†
            echo "ğŸ§¹ æ ‡ç­¾å¤„ç†å®Œæˆåæ¸…ç†..."
            cleanup_docker
          done
          
          # æ¯ä¸ªé•œåƒå¤„ç†å®Œåæ¸…ç†
          echo "ğŸ§¹ é•œåƒå¤„ç†å®Œæˆåæ¸…ç†..."
          cleanup_docker
        done

    - name: Summary
      if: always()
      run: |
        echo "ğŸ å¤„ç†å®Œæˆ"
        echo "=== æœ€ç»ˆDockeré•œåƒ ==="
        docker images | head -20 || echo "æœªæ‰¾åˆ°é•œåƒ"
        echo ""
        echo "ğŸ’¾ æœ€ç»ˆç£ç›˜ä½¿ç”¨æƒ…å†µ:"
        df -h
        echo ""
        echo "ğŸ³ Dockerç³»ç»Ÿä½¿ç”¨æƒ…å†µ:"
        docker system df || true

