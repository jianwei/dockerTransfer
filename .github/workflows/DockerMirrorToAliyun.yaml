name: Sync Multi-Arch Docker Images to Alibaba Cloud

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *'

jobs:
  sync-images:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Login to Alibaba Cloud Container Registry
      uses: docker/login-action@v2
      with:
        registry: registry.cn-hangzhou.aliyuncs.com
        username: ${{ secrets.ALIYUN_USERNAME }}
        password: ${{ secrets.ALIYUN_PASSWORD }}

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y jq

    - name: Clean Docker system before processing
      run: |
        echo "ğŸ§¹ Cleaning Docker system before processing..."
        docker system prune -af --volumes || true
        echo "ğŸ’¾ Disk space before processing:"
        df -h

    - name: Process images
      run: |
        echo "=== Starting image processing ==="
        
        # å®šä¹‰æ¸…ç†å‡½æ•°ï¼Œç”¨äºå½»åº•æ¸…ç† Docker ç³»ç»Ÿ
        cleanup_docker() {
          echo "ğŸ§¹ Performing aggressive Docker cleanup..."
          # ç§»é™¤æ‰€æœ‰åœæ­¢çš„å®¹å™¨ï¼ˆä¸ä½¿ç”¨ -aï¼Œå› ä¸º -a ä¸æ˜¯æœ‰æ•ˆå‚æ•°ï¼‰
          docker container prune -f || true
          # ç§»é™¤æ‰€æœ‰æœªä½¿ç”¨çš„é•œåƒï¼ˆåŒ…æ‹¬ danglingï¼‰
          docker image prune -af || true
          # ç§»é™¤æ‰€æœ‰æœªä½¿ç”¨çš„å·ï¼ˆä¸ä½¿ç”¨ -aï¼Œå› ä¸º -a ä¸æ˜¯æœ‰æ•ˆå‚æ•°ï¼‰
          docker volume prune -f || true
          # ç§»é™¤æ‰€æœ‰æœªä½¿ç”¨çš„ç½‘ç»œï¼ˆä¸ä½¿ç”¨ -aï¼Œå› ä¸º -a ä¸æ˜¯æœ‰æ•ˆå‚æ•°ï¼‰
          docker network prune -f || true
          # æ¸…ç†æ„å»ºç¼“å­˜
          docker builder prune -af || true
          # ç³»ç»Ÿçº§æ¸…ç†ï¼Œç§»é™¤æ‰€æœ‰æœªä½¿ç”¨çš„èµ„æº
          docker system prune -af --volumes || true
          echo "ğŸ’¾ Disk space after cleanup:"
          df -h
        }
        
        # æ£€æŸ¥ç£ç›˜ç©ºé—´å‡½æ•°ï¼Œå¦‚æœå¯ç”¨ç©ºé—´å°äºé˜ˆå€¼åˆ™æ¸…ç†
        check_and_cleanup_if_needed() {
          # è·å–æ ¹åˆ†åŒºä½¿ç”¨ç‡ç™¾åˆ†æ¯”ï¼ˆå»æ‰ç™¾åˆ†å·ï¼‰
          usage_percent=$(df / | tail -1 | awk '{print $5}' | sed 's/%//')
          # å¦‚æœä½¿ç”¨ç‡è¶…è¿‡ 65%ï¼Œæ‰§è¡Œå¼ºåˆ¶æ¸…ç†ï¼ˆé™ä½é˜ˆå€¼ä»¥æå‰æ¸…ç†ï¼‰
          if [ "$usage_percent" -gt 65 ]; then
            echo "âš ï¸  Disk usage is ${usage_percent}%, performing force cleanup..."
            force_cleanup
          elif [ "$usage_percent" -gt 60 ]; then
            echo "âš ï¸  Disk usage is ${usage_percent}%, performing cleanup..."
            cleanup_docker
          fi
        }
        
        # å¼ºåˆ¶æ¸…ç†å‡½æ•°ï¼Œåœ¨å¤„ç†å¤§é•œåƒå‰ä½¿ç”¨
        force_cleanup() {
          echo "ğŸ§¹ Force cleaning Docker system before large image..."
          # åœæ­¢æ‰€æœ‰è¿è¡Œä¸­çš„å®¹å™¨ï¼ˆå…¼å®¹æ€§å¤„ç†ï¼‰
          running_containers=$(docker ps -q)
          if [ -n "$running_containers" ]; then
            echo "$running_containers" | xargs docker stop || true
          fi
          # åˆ é™¤æ‰€æœ‰å®¹å™¨ï¼ˆåŒ…æ‹¬è¿è¡Œä¸­çš„ï¼‰
          container_ids=$(docker ps -aq)
          if [ -n "$container_ids" ]; then
            echo "$container_ids" | xargs docker rm -f || true
          fi
          # åˆ é™¤æ‰€æœ‰é•œåƒï¼ˆåŒ…æ‹¬æ­£åœ¨ä½¿ç”¨çš„ï¼‰
          image_ids=$(docker images -q)
          if [ -n "$image_ids" ]; then
            echo "$image_ids" | xargs docker rmi -f || true
          fi
          # æ¸…ç†æ‰€æœ‰å·
          docker volume prune -f || true
          # æ¸…ç†ç½‘ç»œ
          docker network prune -f || true
          # æ¸…ç†æ„å»ºç¼“å­˜
          docker builder prune -af || true
          # ç³»ç»Ÿçº§å½»åº•æ¸…ç†
          docker system prune -af --volumes || true
          # æ˜¾ç¤º Docker ç£ç›˜ä½¿ç”¨æƒ…å†µ
          echo "ğŸ§¹ Docker disk usage:"
          docker system df -v || true
          echo "ğŸ’¾ Disk space after force cleanup:"
          df -h
        }
        
        # Read the JSON file directly in the shell
        count=$(jq 'length' images.json)
        echo "Found $count images to process"
        
        # Simple loop with proper error handling
        for i in $(seq 0 $((count-1))); do
          echo "=== Processing image $((i+1))/$count ==="
          
          # Extract values one by one with error checking
          source=$(jq -r ".[$i].source" images.json)
          target=$(jq -r ".[$i].target" images.json)
          
          if [ "$source" = "null" ] || [ "$target" = "null" ]; then
            echo "âŒ Invalid data at index $i"
            continue
          fi
          
          # æ£€æŸ¥æ˜¯å¦ä¸ºå¤§é•œåƒï¼ˆå¦‚ vllm, pytorch ç­‰ï¼‰ï¼Œå¦‚æœæ˜¯åˆ™å¼ºåˆ¶æ¸…ç†
          if echo "$source" | grep -qiE "(vllm|pytorch|tensorflow|large|big)"; then
            echo "âš ï¸  Detected large image (~11GB+), performing aggressive cleanup..."
            force_cleanup
            # å¯¹äºå¤§é•œåƒï¼Œæ£€æŸ¥å¯ç”¨ç©ºé—´ï¼ˆè€Œä¸æ˜¯ä½¿ç”¨ç‡ï¼‰
            available_gb=$(df / | tail -1 | awk '{print int($4/1024/1024)}')
            usage_percent=$(df / | tail -1 | awk '{print $5}' | sed 's/%//')
            echo "ğŸ“Š Disk usage: ${usage_percent}%, Available: ${available_gb}GB"
            
            # å¦‚æœå¯ç”¨ç©ºé—´è¶³å¤Ÿï¼ˆ>=15GBï¼‰æˆ–è€…ä½¿ç”¨ç‡å·²ç»åˆç†ï¼ˆ<75%ï¼‰ï¼Œåˆ™ç»§ç»­
            if [ "$available_gb" -ge 15 ] || [ "$usage_percent" -lt 75 ]; then
              echo "âœ… Sufficient space available (${available_gb}GB free), proceeding with large image"
            else
              # å°è¯•æœ€å¤šæ¸…ç† 3 æ¬¡
              max_cleanup_attempts=3
              cleanup_attempt=0
              previous_usage=$usage_percent
              
              while [ "$cleanup_attempt" -lt "$max_cleanup_attempts" ] && [ "$usage_percent" -gt 75 ] && [ "$available_gb" -lt 15 ]; do
                cleanup_attempt=$((cleanup_attempt + 1))
                echo "âš ï¸  Attempt $cleanup_attempt/$max_cleanup_attempts: Disk usage ${usage_percent}% still high, cleaning again..."
                force_cleanup
                
                # æ£€æŸ¥æ¸…ç†åçš„çŠ¶æ€
                new_usage_percent=$(df / | tail -1 | awk '{print $5}' | sed 's/%//')
                new_available_gb=$(df / | tail -1 | awk '{print int($4/1024/1024)}')
                
                # å¦‚æœæ¸…ç†åæ²¡æœ‰æ”¹å–„ï¼Œåœæ­¢æ¸…ç†
                if [ "$new_usage_percent" -ge "$previous_usage" ] && [ "$new_available_gb" -le "$available_gb" ]; then
                  echo "âš ï¸  No improvement after cleanup, stopping cleanup attempts"
                  break
                fi
                
                usage_percent=$new_usage_percent
                available_gb=$new_available_gb
                previous_usage=$usage_percent
                sleep 2
              done
              
              echo "ğŸ“Š Final disk status: ${usage_percent}% used, ${available_gb}GB available"
            fi
          else
            # åœ¨å¤„ç†æ¯ä¸ªé•œåƒä¹‹å‰æ£€æŸ¥å¹¶æ¸…ç†
            check_and_cleanup_if_needed
          fi
          
          tag_count=$(jq ".[$i].tags | length" images.json)
          
          # Get architectures (default to amd64,arm64)
          if jq -e ".[$i].architectures | type == \"array\"" images.json > /dev/null; then
            arch_count=$(jq ".[$i].architectures | length" images.json)
          else
            arch_count=2
          fi
          
          echo "Source: $source"
          echo "Target: $target"
          echo "Tag count: $tag_count"
          echo "Architecture count: $arch_count"
          
          # Extract base image name from source (remove tag)
          base_image=$(echo "$source" | cut -d: -f1)
          
          # Process tags - create separate images for each architecture
          for j in $(seq 0 $((tag_count-1))); do
            tag=$(jq -r ".[$i].tags[$j]" images.json)
            echo "ğŸ·ï¸  Processing tag: $tag"
            
            # Build image reference with current tag
            image_ref="${base_image}:${tag}"
            
            # Process each architecture
            for k in $(seq 0 $((arch_count-1))); do
              if jq -e ".[$i].architectures | type == \"array\"" images.json > /dev/null; then
                arch=$(jq -r ".[$i].architectures[$k]" images.json)
              else
                # Default architectures
                case $k in
                  0) arch="amd64" ;;
                  1) arch="arm64" ;;
                  *) continue ;;
                esac
              fi
              
              # Map arch to platform
              case "$arch" in
                "amd64") platform="linux/amd64"; suffix="amd64" ;;
                "arm64") platform="linux/arm64"; suffix="arm64" ;;
                "arm") platform="linux/arm/v7"; suffix="arm" ;;
                *) platform="linux/$arch"; suffix="$arch" ;;
              esac
              
              final_target="registry.cn-hangzhou.aliyuncs.com/${{ secrets.ALIYUN_NAMESPACE }}/${target}-${suffix}:${tag}"
              echo "ğŸ–¥ï¸  Processing architecture: $arch ($platform)"
              
              # åœ¨æ‹‰å–å‰æ£€æŸ¥ç£ç›˜ç©ºé—´
              usage_percent=$(df / | tail -1 | awk '{print $5}' | sed 's/%//')
              available_gb=$(df / | tail -1 | awk '{print int($4/1024/1024)}')
              echo "ğŸ“Š Current disk usage: ${usage_percent}%, Available: ${available_gb}GB"
              
              # æ£€æŸ¥æ˜¯å¦ä¸ºå¤§é•œåƒï¼ˆå¦‚ vllmï¼‰ï¼Œéœ€è¦æ›´å¤šç©ºé—´
              is_large_image=false
              if echo "$source" | grep -qiE "(vllm|pytorch|tensorflow|large|big)"; then
                is_large_image=true
                echo "âš ï¸  Large image detected, need at least 15GB free space"
                # å¯¹äºå¤§é•œåƒï¼Œéœ€è¦æ›´ä½çš„ä½¿ç”¨ç‡å’Œæ›´å¤šçš„å¯ç”¨ç©ºé—´
                if [ "$usage_percent" -gt 50 ] || [ "$available_gb" -lt 15 ]; then
                  echo "âš ï¸  Insufficient space for large image, performing force cleanup..."
                  force_cleanup
                  usage_percent=$(df / | tail -1 | awk '{print $5}' | sed 's/%//')
                  available_gb=$(df / | tail -1 | awk '{print int($4/1024/1024)}')
                  echo "ğŸ“Š Disk usage after cleanup: ${usage_percent}%, Available: ${available_gb}GB"
                fi
              else
                # æ™®é€šé•œåƒï¼Œä½¿ç”¨ç‡è¶…è¿‡ 60% åˆ™æ¸…ç†
                if [ "$usage_percent" -gt 60 ]; then
                  echo "âš ï¸  Disk usage is ${usage_percent}%, performing cleanup before pull..."
                  force_cleanup
                  usage_percent=$(df / | tail -1 | awk '{print $5}' | sed 's/%//')
                  available_gb=$(df / | tail -1 | awk '{print int($4/1024/1024)}')
                  echo "ğŸ“Š Disk usage after cleanup: ${usage_percent}%, Available: ${available_gb}GB"
                fi
              fi
              
              echo "ğŸ“¥ Pulling $image_ref for $arch..."
              
              # Try to pull with retry logic
              pull_success=false
              for retry in 1 2 3; do
                if docker pull --platform "$platform" "$image_ref"; then
                  pull_success=true
                  break
                else
                  if [ $retry -lt 3 ]; then
                    echo "âš ï¸  Pull failed (attempt $retry), performing force cleanup and retrying..."
                    force_cleanup
                    sleep 3
                  fi
                fi
              done
              
              if [ "$pull_success" = true ]; then
                echo "âœ… $arch pull successful"
                echo "ğŸ“¦ Tagging as $final_target"
                if docker tag "$image_ref" "$final_target"; then
                  echo "âœ… Tag successful"
                  echo "ğŸ“¤ Pushing to registry..."
                  if docker push "$final_target"; then
                    echo "âœ… $arch version pushed successfully: $final_target"
                  else
                    echo "âŒ Failed to push $arch version"
                  fi
                  # ç«‹å³åˆ é™¤ç›®æ ‡é•œåƒæ ‡ç­¾
                  docker rmi "$final_target" || true
                else
                  echo "âŒ Failed to tag $arch version"
                fi
                # ç«‹å³åˆ é™¤æºé•œåƒ
                docker rmi "$image_ref" || true
              else
                echo "â­ï¸  $arch not available after 3 attempts, skipping"
              fi
              
              # æ¯ä¸ªæ¶æ„å¤„ç†å®Œåç«‹å³æ¸…ç†
              echo "ğŸ§¹ Cleaning up after architecture processing..."
              docker image prune -f || true
            done
            
            # Clean up after each tag to save space
            echo "ğŸ§¹ Cleaning up after tag processing..."
            cleanup_docker
          done
          
          # Clean up after each image to save space
          echo "ğŸ§¹ Cleaning up after image processing..."
          cleanup_docker
        done

    - name: Summary
      if: always()
      run: |
        echo "ğŸ Processing completed"
        echo "=== Final Docker images ==="
        docker images | grep "${{ secrets.ALIYUN_NAMESPACE }}" || echo "No pushed images found"
