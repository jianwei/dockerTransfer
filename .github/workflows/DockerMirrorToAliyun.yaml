name: Optimize and Push Docker Images to GitHub Container Registry

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * *'  # æ¯å¤©å‡Œæ™¨3ç‚¹æ‰§è¡Œ

env:
  REGISTRY: ghcr.io
  # ä½¿ç”¨ ${{ github.repository_owner }} è‡ªåŠ¨è·å–ä»“åº“æ‰€æœ‰è€…ä½œä¸ºå‘½åç©ºé—´

jobs:
  optimize-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y jq python3-pip
        pip3 install docker-squash || echo "docker-squashå®‰è£…å¤±è´¥ï¼Œå°†ä½¿ç”¨å…¶ä»–ä¼˜åŒ–æ–¹æ³•"

    - name: Make optimize script executable
      run: chmod +x scripts/optimizeDockerImage.sh

    - name: Clean Docker system before processing
      run: |
        echo "ğŸ§¹ æ¸…ç†Dockerç³»ç»Ÿ..."
        docker system prune -af --volumes || true
        echo "ğŸ’¾ å¤„ç†å‰ç£ç›˜ç©ºé—´:"
        df -h

    - name: Process and optimize images
      run: |
        set -euo pipefail
        
        # å®šä¹‰æ¸…ç†å‡½æ•°
        cleanup_docker() {
          echo "ğŸ§¹ æ‰§è¡ŒDockeræ¸…ç†..."
          echo "ğŸ“Š æ¸…ç†å‰Dockerç³»ç»Ÿä½¿ç”¨æƒ…å†µ:"
          docker system df || true
          
          # æ¸…ç†buildxç¼“å­˜ï¼ˆå¯èƒ½å ç”¨å¤§é‡ç©ºé—´ï¼‰
          echo "ğŸ§¹ æ¸…ç†buildxæ„å»ºç¼“å­˜..."
          docker buildx prune -af || true
          
          # æ¸…ç†æœªä½¿ç”¨çš„é•œåƒï¼ˆåŒ…æ‹¬danglingé•œåƒï¼‰
          echo "ğŸ§¹ æ¸…ç†æœªä½¿ç”¨çš„é•œåƒ..."
          docker image prune -af || true
          
          # æ¸…ç†æœªä½¿ç”¨çš„å®¹å™¨
          echo "ğŸ§¹ æ¸…ç†æœªä½¿ç”¨çš„å®¹å™¨..."
          docker container prune -f || true
          
          # æ¸…ç†æœªä½¿ç”¨çš„å·
          echo "ğŸ§¹ æ¸…ç†æœªä½¿ç”¨çš„å·..."
          docker volume prune -f || true
          
          # æ¸…ç†æœªä½¿ç”¨çš„ç½‘ç»œ
          echo "ğŸ§¹ æ¸…ç†æœªä½¿ç”¨çš„ç½‘ç»œ..."
          docker network prune -f || true
          
          # æ¸…ç†æ‰€æœ‰æœªä½¿ç”¨çš„èµ„æº
          echo "ğŸ§¹ æ¸…ç†æ‰€æœ‰æœªä½¿ç”¨çš„èµ„æº..."
          docker system prune -af --volumes || true
          
          echo "ğŸ“Š æ¸…ç†åDockerç³»ç»Ÿä½¿ç”¨æƒ…å†µ:"
          docker system df || true
          echo "ğŸ’¾ æ¸…ç†åç£ç›˜ç©ºé—´:"
          df -h
        }
        
        # å¼ºåˆ¶æ¸…ç†å‡½æ•°ï¼Œç”¨äºå¤§é•œåƒå¤„ç†
        force_cleanup() {
          echo "ğŸ§¹ æ‰§è¡Œå¼ºåˆ¶æ¸…ç†..."
          echo "ğŸ“Š æ¸…ç†å‰Dockerç³»ç»Ÿä½¿ç”¨æƒ…å†µ:"
          docker system df || true
          
          # åœæ­¢æ‰€æœ‰è¿è¡Œä¸­çš„å®¹å™¨
          running_containers=$(docker ps -q)
          if [ -n "$running_containers" ]; then
            echo "ğŸ›‘ åœæ­¢è¿è¡Œä¸­çš„å®¹å™¨..."
            echo "$running_containers" | xargs docker stop || true
          fi
          
          # åˆ é™¤æ‰€æœ‰å®¹å™¨
          container_ids=$(docker ps -aq)
          if [ -n "$container_ids" ]; then
            echo "ğŸ—‘ï¸  åˆ é™¤æ‰€æœ‰å®¹å™¨..."
            echo "$container_ids" | xargs docker rm -f || true
          fi
          
          # åˆ é™¤æ‰€æœ‰é•œåƒ
          image_ids=$(docker images -q)
          if [ -n "$image_ids" ]; then
            echo "ğŸ—‘ï¸  åˆ é™¤æ‰€æœ‰é•œåƒ..."
            echo "$image_ids" | xargs docker rmi -f || true
          fi
          
          # æ¸…ç†buildxç¼“å­˜ï¼ˆå¯èƒ½å ç”¨å¤§é‡ç©ºé—´ï¼‰
          echo "ğŸ§¹ æ¸…ç†buildxæ„å»ºç¼“å­˜..."
          docker buildx prune -af || true
          
          # æ¸…ç†æ‰€æœ‰èµ„æº
          echo "ğŸ§¹ æ¸…ç†æ‰€æœ‰æœªä½¿ç”¨çš„èµ„æº..."
          docker volume prune -f || true
          docker network prune -f || true
          docker builder prune -af || true
          docker system prune -af --volumes || true
          
          echo "ğŸ“Š æ¸…ç†åDockerç³»ç»Ÿä½¿ç”¨æƒ…å†µ:"
          docker system df || true
          echo "ğŸ’¾ å¼ºåˆ¶æ¸…ç†åç£ç›˜ç©ºé—´:"
          df -h
        }
        
        # æ£€æŸ¥æ˜¯å¦ä¸ºå¤§é•œåƒ
        is_large_image() {
          local image_name="$1"
          # æ£€æµ‹å¸¸è§çš„å¤§é•œåƒåç§°æ¨¡å¼
          if echo "$image_name" | grep -qiE "(vllm|pytorch|tensorflow|large|big|ml|ai|gpu|cuda)"; then
            return 0
          fi
          return 1
        }
        
        # ç¡®ä¿æœ‰è¶³å¤Ÿç©ºé—´ï¼ˆå¯¹å¤§é•œåƒéœ€è¦æ›´å¤šç©ºé—´ï¼‰
        # å‚æ•°: $1=é•œåƒåç§°, $2=æ˜¯å¦å¼ºåˆ¶ç»§ç»­ï¼ˆtrue/falseï¼Œé»˜è®¤falseï¼‰
        ensure_space() {
          local image_name="$1"
          local force_continue="${2:-false}"  # é»˜è®¤ä¸å¼ºåˆ¶ç»§ç»­
          local min_space_gb=15  # é»˜è®¤æœ€å°‘éœ€è¦15GB
          
          if is_large_image "$image_name"; then
            # vllmç­‰å¤§é•œåƒå‹ç¼©å11GB+ï¼Œæœªå‹ç¼©å¯èƒ½éœ€è¦25-30GB
            # åŠ ä¸Šæ„å»ºç¼“å­˜å’Œä¸´æ—¶æ–‡ä»¶ï¼Œéœ€è¦è‡³å°‘35GBå®‰å…¨ç©ºé—´
            min_space_gb=35
            echo "âš ï¸  æ£€æµ‹åˆ°å¤§é•œåƒ ($image_name)ï¼Œéœ€è¦è‡³å°‘ ${min_space_gb}GB å¯ç”¨ç©ºé—´"
            echo "ğŸ’¡ å¤§é•œåƒå¤„ç†ç­–ç•¥ï¼šå°†ä½¿ç”¨å¼ºåˆ¶æ¸…ç†ç¡®ä¿è¶³å¤Ÿç©ºé—´"
          fi
          
          usage_percent=$(df / | tail -1 | awk '{print $5}' | sed 's/%//')
          available_gb=$(df / | tail -1 | awk '{print int($4/1024/1024)}')
          
          echo "ğŸ“Š ç£ç›˜çŠ¶æ€: ä½¿ç”¨ç‡ ${usage_percent}%, å¯ç”¨ç©ºé—´ ${available_gb}GB"
          
          # å¦‚æœä½¿ç”¨ç‡è¶…è¿‡60%æˆ–å¯ç”¨ç©ºé—´ä¸è¶³ï¼Œæ‰§è¡Œæ¸…ç†
          # å¯¹å¤§é•œåƒä½¿ç”¨æ›´ä¸¥æ ¼çš„æ ‡å‡†
          local cleanup_threshold=60
          if is_large_image "$image_name"; then
            cleanup_threshold=55  # å¤§é•œåƒä½¿ç”¨æ›´ä½çš„é˜ˆå€¼ï¼Œæå‰æ¸…ç†
          fi
          
          if [ "$usage_percent" -gt "$cleanup_threshold" ] || [ "$available_gb" -lt "$min_space_gb" ]; then
            echo "âš ï¸  ç©ºé—´ä¸è¶³ï¼ˆä½¿ç”¨ç‡ ${usage_percent}% > ${cleanup_threshold}% æˆ–å¯ç”¨ç©ºé—´ ${available_gb}GB < ${min_space_gb}GBï¼‰ï¼Œæ‰§è¡Œæ¸…ç†..."
            
            # å¯¹äºå¤§é•œåƒæˆ–ç©ºé—´ä¸¥é‡ä¸è¶³çš„æƒ…å†µï¼Œä½¿ç”¨å¼ºåˆ¶æ¸…ç†
            if [ "$usage_percent" -gt 70 ] || [ "$available_gb" -lt "$min_space_gb" ] || is_large_image "$image_name"; then
              force_cleanup
            else
              cleanup_docker
            fi
            
            # æ¸…ç†åå†æ¬¡æ£€æŸ¥
            usage_percent=$(df / | tail -1 | awk '{print $5}' | sed 's/%//')
            available_gb=$(df / | tail -1 | awk '{print int($4/1024/1024)}')
            echo "ğŸ“Š æ¸…ç†åç£ç›˜çŠ¶æ€: ä½¿ç”¨ç‡ ${usage_percent}%, å¯ç”¨ç©ºé—´ ${available_gb}GB"
            
            # å¦‚æœä»ç„¶ä¸è¶³
            if [ "$available_gb" -lt "$min_space_gb" ]; then
              if [ "$force_continue" = "true" ]; then
                echo "âš ï¸  æ¸…ç†åç©ºé—´ä»ç„¶ä¸è¶³ï¼ˆéœ€è¦è‡³å°‘ ${min_space_gb}GBï¼Œå½“å‰å¯ç”¨ ${available_gb}GBï¼‰"
                echo "ğŸ’¡ å¼ºåˆ¶ç»§ç»­æ¨¡å¼ï¼šå°†ç»§ç»­å°è¯•ï¼Œä½†å¯èƒ½å› ç©ºé—´ä¸è¶³è€Œå¤±è´¥"
                # å°è¯•å†æ¬¡å¼ºåˆ¶æ¸…ç†
                echo "ğŸ”„ æ‰§è¡Œæœ€åä¸€æ¬¡å¼ºåˆ¶æ¸…ç†..."
                force_cleanup
                sleep 2
                # å†æ¬¡æ£€æŸ¥
                available_gb=$(df / | tail -1 | awk '{print int($4/1024/1024)}')
                echo "ğŸ“Š æœ€ç»ˆå¯ç”¨ç©ºé—´: ${available_gb}GB"
                return 0  # å³ä½¿ç©ºé—´ä¸è¶³ä¹Ÿç»§ç»­
              else
                echo "âŒ æ¸…ç†åä»ç„¶ç©ºé—´ä¸è¶³ï¼Œéœ€è¦è‡³å°‘ ${min_space_gb}GBï¼Œå½“å‰å¯ç”¨ ${available_gb}GB"
                return 1
              fi
            fi
          fi
          
          return 0
        }
        
        # è·å–GitHubä»“åº“å‘½åç©ºé—´
        GITHUB_NAMESPACE="${{ github.repository_owner }}"
        
        # è¯»å–images.jsoné…ç½®
        count=$(jq 'length' images.json)
        echo "æ‰¾åˆ° $count ä¸ªé•œåƒéœ€è¦å¤„ç†"
        
        # å¤„ç†æ¯ä¸ªé•œåƒ
        for i in $(seq 0 $((count-1))); do
          echo "=== å¤„ç†é•œåƒ $((i+1))/$count ==="
          
          source=$(jq -r ".[$i].source" images.json)
          target=$(jq -r ".[$i].target" images.json)
          
          if [ "$source" = "null" ] || [ "$target" = "null" ]; then
            echo "âŒ ç´¢å¼• $i å¤„çš„æ•°æ®æ— æ•ˆ"
            continue
          fi
          
          tag_count=$(jq ".[$i].tags | length" images.json)
          arch_count=$(jq ".[$i].architectures | length" images.json)
          
          echo "æºé•œåƒ: $source"
          echo "ç›®æ ‡é•œåƒ: $target"
          echo "æ ‡ç­¾æ•°é‡: $tag_count"
          echo "æ¶æ„æ•°é‡: $arch_count"
          
          # æå–åŸºç¡€é•œåƒåç§°
          base_image=$(echo "$source" | cut -d: -f1)
          
          # å¤„ç†æ¯ä¸ªæ ‡ç­¾
          for j in $(seq 0 $((tag_count-1))); do
            tag=$(jq -r ".[$i].tags[$j]" images.json)
            echo "ğŸ·ï¸  å¤„ç†æ ‡ç­¾: $tag"
            
            image_ref="${base_image}:${tag}"
            
            # å¤„ç†æ¯ä¸ªæ¶æ„
            for k in $(seq 0 $((arch_count-1))); do
              arch=$(jq -r ".[$i].architectures[$k]" images.json)
              
              # æ˜ å°„æ¶æ„åˆ°å¹³å°
              case "$arch" in
                "amd64") platform="linux/amd64"; suffix="amd64" ;;
                "arm64") platform="linux/arm64"; suffix="arm64" ;;
                "arm/v7"|"arm") platform="linux/arm/v7"; suffix="armv7" ;;
                *) platform="linux/$arch"; suffix="$arch" ;;
              esac
              
              # æ„å»ºç›®æ ‡é•œåƒåœ°å€
              final_target="${{ env.REGISTRY }}/${GITHUB_NAMESPACE}/${target}-${suffix}:${tag}"
              echo "ğŸ–¥ï¸  å¤„ç†æ¶æ„: $arch ($platform)"
              
              # æ£€æŸ¥å¹¶ç¡®ä¿æœ‰è¶³å¤Ÿç©ºé—´ï¼ˆå¼ºåˆ¶ç»§ç»­æ¨¡å¼ï¼Œä¸è·³è¿‡ï¼‰
              echo "ğŸ” æ£€æŸ¥ç£ç›˜ç©ºé—´..."
              ensure_space "$source" "true" || {
                echo "âš ï¸  ç©ºé—´æ£€æŸ¥è­¦å‘Šï¼Œä½†å°†ç»§ç»­å°è¯•..."
              }
              
              # å¤§é•œåƒæ‹‰å–å‰çš„ç‰¹æ®Šå¤„ç†
              if is_large_image "$source"; then
                echo "ğŸ” æ£€æµ‹åˆ°å¤§é•œåƒï¼Œæ‹‰å–å‰è¿›è¡Œé¢„æ¸…ç†..."
                docker buildx prune -af || true
                docker image prune -af || true
                echo "âœ… é¢„æ¸…ç†å®Œæˆ"
              fi
              
              # æ‹‰å–æºé•œåƒ
              echo "ğŸ“¥ æ‹‰å– $image_ref ($arch)..."
              if is_large_image "$source"; then
                echo "ğŸ’¡ å¤§é•œåƒæ‹‰å–å¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…..."
              fi
              
              pull_success=false
              for retry in 1 2 3; do
                # æ‹‰å–å‰å†æ¬¡æ£€æŸ¥ç©ºé—´ï¼ˆå¼ºåˆ¶ç»§ç»­æ¨¡å¼ï¼‰
                ensure_space "$source" "true" || {
                  echo "âš ï¸  æ‹‰å–å‰ç©ºé—´æ£€æŸ¥è­¦å‘Šï¼Œä½†å°†ç»§ç»­å°è¯•..."
                }
                
                if docker pull --platform "$platform" "$image_ref"; then
                  pull_success=true
                  break
                else
                  if [ $retry -lt 3 ]; then
                    echo "âš ï¸  æ‹‰å–å¤±è´¥ (å°è¯• $retry/3)ï¼Œæ‰§è¡Œå¼ºåˆ¶æ¸…ç†åé‡è¯•..."
                    force_cleanup
                    sleep 5
                  fi
                fi
              done
              
              if [ "$pull_success" = true ]; then
                echo "âœ… $arch æ‹‰å–æˆåŠŸ"
                
                # æ‹‰å–åç«‹å³æ¸…ç†æœªä½¿ç”¨çš„é•œåƒï¼Œé‡Šæ”¾ç©ºé—´
                echo "ğŸ§¹ æ‹‰å–åæ¸…ç†æœªä½¿ç”¨çš„é•œåƒ..."
                docker image prune -f || true
                
                # æ£€æŸ¥é•œåƒå¤§å°
                image_size=$(docker image inspect "$image_ref" --format='{{.Size}}' 2>/dev/null || echo "0")
                image_size_gb=$((image_size / 1073741824))
                echo "ğŸ“¦ é•œåƒå¤§å°: ${image_size_gb}GB"
                
                # ä½¿ç”¨ä¼˜åŒ–è„šæœ¬ä¼˜åŒ–é•œåƒå¤§å°
                echo "ğŸ”§ ä½¿ç”¨ä¼˜åŒ–è„šæœ¬ä¼˜åŒ–é•œåƒå¤§å°..."
                if ./scripts/optimizeDockerImage.sh "$image_ref" "$final_target" --compress --platform "$platform"; then
                  echo "âœ… é•œåƒä¼˜åŒ–æˆåŠŸ"
                else
                  echo "âš ï¸  ä¼˜åŒ–å¤±è´¥ï¼Œä½¿ç”¨åŸå§‹é•œåƒ"
                  docker tag "$image_ref" "$final_target"
                fi
                
                # æ¨é€åˆ°GitHub Container Registry
                echo "ğŸ“¤ æ¨é€åˆ° $final_target..."
                push_success=false
                for push_retry in 1 2 3; do
                  if docker push "$final_target"; then
                    push_success=true
                    echo "âœ… $arch ç‰ˆæœ¬æ¨é€æˆåŠŸ: $final_target"
                    break
                  else
                    if [ $push_retry -lt 3 ]; then
                      echo "âš ï¸  æ¨é€å¤±è´¥ (å°è¯• $push_retry)ï¼Œé‡è¯•..."
                      sleep 3
                    fi
                  fi
                done
                
                if [ "$push_success" = false ]; then
                  echo "âŒ æ¨é€ $arch ç‰ˆæœ¬å¤±è´¥"
                fi
                
                # ç«‹å³æ¸…ç†æœ¬åœ°é•œåƒå’Œæ„å»ºç¼“å­˜ï¼Œé‡Šæ”¾ç©ºé—´
                echo "ğŸ§¹ ç«‹å³æ¸…ç†æœ¬åœ°é•œåƒ..."
                docker rmi "$final_target" || true
                docker rmi "$image_ref" || true
                docker image prune -f || true
                
                # æ¸…ç†buildxæ„å»ºç¼“å­˜ï¼ˆä¼˜åŒ–è¿‡ç¨‹ä¸­å¯èƒ½äº§ç”Ÿå¤§é‡ç¼“å­˜ï¼‰
                echo "ğŸ§¹ æ¸…ç†buildxæ„å»ºç¼“å­˜..."
                docker buildx prune -af || true
                
                # æ˜¾ç¤ºæ¸…ç†åçš„ç©ºé—´
                usage_percent=$(df / | tail -1 | awk '{print $5}' | sed 's/%//')
                available_gb=$(df / | tail -1 | awk '{print int($4/1024/1024)}')
                echo "ğŸ“Š æ¸…ç†åç£ç›˜çŠ¶æ€: ä½¿ç”¨ç‡ ${usage_percent}%, å¯ç”¨ç©ºé—´ ${available_gb}GB"
              else
                echo "â­ï¸  $arch åœ¨3æ¬¡å°è¯•åä»ä¸å¯ç”¨ï¼Œè·³è¿‡"
              fi
              
              # æ¯ä¸ªæ¶æ„å¤„ç†å®Œåæ¸…ç†
              echo "ğŸ§¹ æ¶æ„å¤„ç†å®Œæˆåæ¸…ç†..."
              docker image prune -f || true
              docker buildx prune -af || true
            done
            
            # æ¯ä¸ªæ ‡ç­¾å¤„ç†å®Œåæ¸…ç†
            echo "ğŸ§¹ æ ‡ç­¾å¤„ç†å®Œæˆåæ¸…ç†..."
            cleanup_docker
          done
          
          # æ¯ä¸ªé•œåƒå¤„ç†å®Œåæ¸…ç†
          echo "ğŸ§¹ é•œåƒå¤„ç†å®Œæˆåæ¸…ç†..."
          cleanup_docker
        done

    - name: Summary
      if: always()
      run: |
        echo "ğŸ å¤„ç†å®Œæˆ"
        echo "=== æœ€ç»ˆDockeré•œåƒ ==="
        docker images | head -20 || echo "æœªæ‰¾åˆ°é•œåƒ"
        echo ""
        echo "ğŸ’¾ æœ€ç»ˆç£ç›˜ä½¿ç”¨æƒ…å†µ:"
        df -h
        echo ""
        echo "ğŸ³ Dockerç³»ç»Ÿä½¿ç”¨æƒ…å†µ:"
        docker system df || true

