name: Mirror Images to Aliyun

on:
  workflow_dispatch:

jobs:
  mirror:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4.1.6

      - name: Install yq
        run: |
          sudo wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/local/bin/yq
          sudo chmod +x /usr/local/bin/yq

      - name: Enable Docker experimental
        run: |
          echo '{"experimental":true}' | sudo tee /etc/docker/daemon.json
          sudo service docker restart

      - name: Pull and push images
        env:
          ALIYUN_REGISTRY: ${{ secrets.ALIYUN_REGISTRY }}
          ALIYUN_NAMESPACE: ${{ secrets.ALIYUN_NAMESPACE }}
          ALIYUN_USERNAME: ${{ secrets.ALIYUN_USERNAME }}
          ALIYUN_PASSWORD: ${{ secrets.ALIYUN_PASSWORD }}
        run: |
          docker login --username=$ALIYUN_USERNAME --password=$ALIYUN_PASSWORD $ALIYUN_REGISTRY

          IMAGE_COUNT=$(yq e '.images | length' configs/ImagesConfig.yaml)
          for i in $(seq 0 $(($IMAGE_COUNT-1))); do
            REPO=$(yq e ".images[$i].repo" configs/ImagesConfig.yaml)
            TAG=$(yq e ".images[$i].tag" configs/ImagesConfig.yaml)
            SOURCE_IMAGE="$REPO:$TAG"
            TARGET_IMAGE="$ALIYUN_REGISTRY/$ALIYUN_NAMESPACE/$REPO:$TAG"

            # Pull AMD64
            docker pull --platform=linux/amd64 $SOURCE_IMAGE
            docker tag $SOURCE_IMAGE $TARGET_IMAGE-amd64
            docker push $TARGET_IMAGE-amd64

            # Pull ARM64
            docker pull --platform=linux/arm64 $SOURCE_IMAGE
            docker tag $SOURCE_IMAGE $TARGET_IMAGE-arm64
            docker push $TARGET_IMAGE-arm64

            # Create and push manifest
            docker manifest create $TARGET_IMAGE --amend $TARGET_IMAGE-amd64 --amend $TARGET_IMAGE-arm64
            docker manifest push $TARGET_IMAGE
          done
