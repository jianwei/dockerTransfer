name: Sync Multi-Arch Docker Images to Alibaba Cloud

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *'

jobs:
  sync-images:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Login to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Login to Alibaba Cloud Container Registry
      uses: docker/login-action@v2
      with:
        registry: registry.cn-hangzhou.aliyuncs.com
        username: ${{ secrets.ALIYUN_USERNAME }}
        password: ${{ secrets.ALIYUN_PASSWORD }}

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y jq

    - name: Sync images for both architectures
      run: |
        # Check if images.json exists
        if [ ! -f "images.json" ]; then
          echo "âŒ images.json not found"
          exit 1
        fi
        
        # Get all source images from JSON
        source_images=$(jq -r 'keys[]' images.json)
        
        for source_image in $source_images; do
          target_image=$(jq -r ".[\"$source_image\"].target" images.json)
          echo "ğŸ”„ Processing image: $source_image -> $target_image"
          
          # Pull images for both architectures
          echo "ğŸ“¥ Pulling amd64 version..."
          docker pull --platform linux/amd64 $source_image
          
          echo "ğŸ“¥ Pulling arm64 version..."
          docker pull --platform linux/arm64 $source_image
          
          # Get tags array
          tags=$(jq -r ".[\"$source_image\"].tags[]" images.json)
          
          # Tag and push for each tag
          for tag in $tags; do
            target_full_name="registry.cn-hangzhou.aliyuncs.com/${{ secrets.ALIYUN_NAMESPACE }}/$target_image:$tag"
            echo "ğŸ·ï¸  Tagging and pushing $target_full_name"
            
            docker tag $source_image $target_full_name
            
            # Push both architectures
            echo "ğŸ“¤ Pushing multi-arch image..."
            docker push $target_full_name
          done
          
          echo "âœ… Completed processing $source_image"
        done

    - name: Cleanup
      if: always()
      run: |
        echo "ğŸ§¹ Cleaning up Docker images..."
        # Add cleanup commands here if needed
        echo "âœ… Cleanup completed"
