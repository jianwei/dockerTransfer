name: Sync Multi-Arch Docker Images to Alibaba Cloud

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *'

jobs:
  sync-images:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Login to Alibaba Cloud Container Registry
      uses: docker/login-action@v2
      with:
        registry: registry.cn-hangzhou.aliyuncs.com
        username: ${{ secrets.ALIYUN_USERNAME }}
        password: ${{ secrets.ALIYUN_PASSWORD }}

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y jq

    - name: Process images
      run: |
        echo "=== Starting image processing ==="
        
        # Read the JSON file directly in the shell
        count=$(jq 'length' images.json)
        echo "Found $count images to process"
        
        # Simple loop with proper error handling
        for i in $(seq 0 $((count-1))); do
          echo "=== Processing image $((i+1)) ==="
          
          # Extract values one by one with error checking
          source=$(jq -r ".[$i].source" images.json)
          target=$(jq -r ".[$i].target" images.json)
          tag_count=$(jq ".[$i].tags | length" images.json)
          
          # Get architectures (default to amd64,arm64)
          if jq -e ".[$i].architectures | type == \"array\"" images.json > /dev/null; then
            arch_count=$(jq ".[$i].architectures | length" images.json)
          else
            arch_count=2
          fi
          
          echo "Source: $source"
          echo "Target: $target"
          echo "Tag count: $tag_count"
          echo "Architecture count: $arch_count"
          
          if [ "$source" = "null" ] || [ "$target" = "null" ]; then
            echo "‚ùå Invalid data at index $i"
            continue
          fi
          
          # Extract base image name from source (remove tag)
          base_image=$(echo "$source" | cut -d: -f1)
          
          # Process tags - create separate images for each architecture
          for j in $(seq 0 $((tag_count-1))); do
            tag=$(jq -r ".[$i].tags[$j]" images.json)
            echo "üè∑Ô∏è  Processing tag: $tag"
            
            # Build image reference with current tag
            image_ref="${base_image}:${tag}"
            
            # Process each architecture
            for k in $(seq 0 $((arch_count-1))); do
              if jq -e ".[$i].architectures | type == \"array\"" images.json > /dev/null; then
                arch=$(jq -r ".[$i].architectures[$k]" images.json)
              else
                # Default architectures
                case $k in
                  0) arch="amd64" ;;
                  1) arch="arm64" ;;
                  *) continue ;;
                esac
              fi
              
              # Map arch to platform
              case "$arch" in
                "amd64") platform="linux/amd64"; suffix="amd64" ;;
                "arm64") platform="linux/arm64"; suffix="arm64" ;;
                "arm") platform="linux/arm/v7"; suffix="arm" ;;
                *) platform="linux/$arch"; suffix="$arch" ;;
              esac
              
              final_target="registry.cn-hangzhou.aliyuncs.com/${{ secrets.ALIYUN_NAMESPACE }}/${target}-${suffix}:${tag}"
              echo "üñ•Ô∏è  Processing architecture: $arch ($platform)"
              echo "üì• Pulling $image_ref for $arch..."
              
              if docker pull --platform "$platform" "$image_ref"; then
                echo "‚úÖ $arch pull successful"
                echo "üì¶ Tagging as $final_target"
                if docker tag "$image_ref" "$final_target"; then
                  echo "‚úÖ Tag successful"
                  echo "üì§ Pushing to registry..."
                  if docker push "$final_target"; then
                    echo "‚úÖ $arch version pushed successfully: $final_target"
                  else
                    echo "‚ùå Failed to push $arch version"
                  fi
                  docker rmi "$final_target" || true
                else
                  echo "‚ùå Failed to tag $arch version"
                fi
                docker rmi "$image_ref" || true
              else
                echo "‚è≠Ô∏è  $arch not available, skipping"
              fi
            done
          done
        done

    - name: Summary
      if: always()
      run: |
        echo "üèÅ Processing completed"
        echo "=== Final Docker images ==="
        docker images | grep "${{ secrets.ALIYUN_NAMESPACE }}" || echo "No pushed images found"
