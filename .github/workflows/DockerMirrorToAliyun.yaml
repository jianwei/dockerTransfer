name: Sync Multi-Arch Docker Images to Alibaba Cloud

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *'

jobs:
  sync-images:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Login to Alibaba Cloud Container Registry
      uses: docker/login-action@v2
      with:
        registry: registry.cn-hangzhou.aliyuncs.com
        username: ${{ secrets.ALIYUN_USERNAME }}
        password: ${{ secrets.ALIYUN_PASSWORD }}

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y jq

    - name: Clean Docker system before processing
      run: |
        echo "ğŸ§¹ Cleaning Docker system before processing..."
        docker system prune -af --volumes || true
        echo "ğŸ’¾ Disk space before processing:"
        df -h

    - name: Process images
      run: |
        echo "=== Starting image processing ==="
        
        # å®šä¹‰æ¸…ç†å‡½æ•°ï¼Œç”¨äºå½»åº•æ¸…ç† Docker ç³»ç»Ÿ
        cleanup_docker() {
          echo "ğŸ§¹ Performing aggressive Docker cleanup..."
          # ç§»é™¤æ‰€æœ‰æœªä½¿ç”¨çš„å®¹å™¨
          docker container prune -af || true
          # ç§»é™¤æ‰€æœ‰æœªä½¿ç”¨çš„é•œåƒï¼ˆåŒ…æ‹¬ danglingï¼‰
          docker image prune -af || true
          # ç§»é™¤æ‰€æœ‰æœªä½¿ç”¨çš„å·
          docker volume prune -af || true
          # ç§»é™¤æ‰€æœ‰æœªä½¿ç”¨çš„ç½‘ç»œ
          docker network prune -af || true
          # æ¸…ç†æ„å»ºç¼“å­˜
          docker builder prune -af || true
          # ç³»ç»Ÿçº§æ¸…ç†
          docker system prune -af --volumes || true
          echo "ğŸ’¾ Disk space after cleanup:"
          df -h
        }
        
        # æ£€æŸ¥ç£ç›˜ç©ºé—´å‡½æ•°ï¼Œå¦‚æœå¯ç”¨ç©ºé—´å°äºé˜ˆå€¼åˆ™æ¸…ç†
        check_and_cleanup_if_needed() {
          # è·å–æ ¹åˆ†åŒºå¯ç”¨ç©ºé—´ç™¾åˆ†æ¯”ï¼ˆå»æ‰ç™¾åˆ†å·ï¼‰
          available_percent=$(df / | tail -1 | awk '{print $5}' | sed 's/%//')
          # å¦‚æœä½¿ç”¨ç‡è¶…è¿‡ 80%ï¼Œæ‰§è¡Œæ¸…ç†
          if [ "$available_percent" -gt 80 ]; then
            echo "âš ï¸  Disk usage is ${available_percent}%, performing cleanup..."
            cleanup_docker
          fi
        }
        
        # Read the JSON file directly in the shell
        count=$(jq 'length' images.json)
        echo "Found $count images to process"
        
        # Simple loop with proper error handling
        for i in $(seq 0 $((count-1))); do
          echo "=== Processing image $((i+1))/$count ==="
          
          # åœ¨å¤„ç†æ¯ä¸ªé•œåƒä¹‹å‰æ£€æŸ¥å¹¶æ¸…ç†
          check_and_cleanup_if_needed
          
          # Extract values one by one with error checking
          source=$(jq -r ".[$i].source" images.json)
          target=$(jq -r ".[$i].target" images.json)
          tag_count=$(jq ".[$i].tags | length" images.json)
          
          # Get architectures (default to amd64,arm64)
          if jq -e ".[$i].architectures | type == \"array\"" images.json > /dev/null; then
            arch_count=$(jq ".[$i].architectures | length" images.json)
          else
            arch_count=2
          fi
          
          echo "Source: $source"
          echo "Target: $target"
          echo "Tag count: $tag_count"
          echo "Architecture count: $arch_count"
          
          if [ "$source" = "null" ] || [ "$target" = "null" ]; then
            echo "âŒ Invalid data at index $i"
            continue
          fi
          
          # Extract base image name from source (remove tag)
          base_image=$(echo "$source" | cut -d: -f1)
          
          # Process tags - create separate images for each architecture
          for j in $(seq 0 $((tag_count-1))); do
            tag=$(jq -r ".[$i].tags[$j]" images.json)
            echo "ğŸ·ï¸  Processing tag: $tag"
            
            # Build image reference with current tag
            image_ref="${base_image}:${tag}"
            
            # Process each architecture
            for k in $(seq 0 $((arch_count-1))); do
              if jq -e ".[$i].architectures | type == \"array\"" images.json > /dev/null; then
                arch=$(jq -r ".[$i].architectures[$k]" images.json)
              else
                # Default architectures
                case $k in
                  0) arch="amd64" ;;
                  1) arch="arm64" ;;
                  *) continue ;;
                esac
              fi
              
              # Map arch to platform
              case "$arch" in
                "amd64") platform="linux/amd64"; suffix="amd64" ;;
                "arm64") platform="linux/arm64"; suffix="arm64" ;;
                "arm") platform="linux/arm/v7"; suffix="arm" ;;
                *) platform="linux/$arch"; suffix="$arch" ;;
              esac
              
              final_target="registry.cn-hangzhou.aliyuncs.com/${{ secrets.ALIYUN_NAMESPACE }}/${target}-${suffix}:${tag}"
              echo "ğŸ–¥ï¸  Processing architecture: $arch ($platform)"
              
              # åœ¨æ‹‰å–å‰æ£€æŸ¥ç£ç›˜ç©ºé—´
              check_and_cleanup_if_needed
              
              echo "ğŸ“¥ Pulling $image_ref for $arch..."
              
              # Try to pull with retry logic
              pull_success=false
              for retry in 1 2 3; do
                if docker pull --platform "$platform" "$image_ref"; then
                  pull_success=true
                  break
                else
                  if [ $retry -lt 3 ]; then
                    echo "âš ï¸  Pull failed (attempt $retry), performing aggressive cleanup and retrying..."
                    cleanup_docker
                    sleep 2
                  fi
                fi
              done
              
              if [ "$pull_success" = true ]; then
                echo "âœ… $arch pull successful"
                echo "ğŸ“¦ Tagging as $final_target"
                if docker tag "$image_ref" "$final_target"; then
                  echo "âœ… Tag successful"
                  echo "ğŸ“¤ Pushing to registry..."
                  if docker push "$final_target"; then
                    echo "âœ… $arch version pushed successfully: $final_target"
                  else
                    echo "âŒ Failed to push $arch version"
                  fi
                  # ç«‹å³åˆ é™¤ç›®æ ‡é•œåƒæ ‡ç­¾
                  docker rmi "$final_target" || true
                else
                  echo "âŒ Failed to tag $arch version"
                fi
                # ç«‹å³åˆ é™¤æºé•œåƒ
                docker rmi "$image_ref" || true
              else
                echo "â­ï¸  $arch not available after 3 attempts, skipping"
              fi
              
              # æ¯ä¸ªæ¶æ„å¤„ç†å®Œåç«‹å³æ¸…ç†
              echo "ğŸ§¹ Cleaning up after architecture processing..."
              docker image prune -f || true
            done
            
            # Clean up after each tag to save space
            echo "ğŸ§¹ Cleaning up after tag processing..."
            cleanup_docker
          done
          
          # Clean up after each image to save space
          echo "ğŸ§¹ Cleaning up after image processing..."
          cleanup_docker
        done

    - name: Summary
      if: always()
      run: |
        echo "ğŸ Processing completed"
        echo "=== Final Docker images ==="
        docker images | grep "${{ secrets.ALIYUN_NAMESPACE }}" || echo "No pushed images found"
