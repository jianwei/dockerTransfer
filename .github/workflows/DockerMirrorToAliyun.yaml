name: Sync Multi-Arch Docker Images to Alibaba Cloud

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *'

jobs:
  sync-images:
    # å¦‚æœéœ€è¦ä½¿ç”¨è‡ªæ‰˜ç®¡ runnerï¼Œå–æ¶ˆä¸‹é¢çš„æ³¨é‡Šå¹¶é…ç½® runner æ ‡ç­¾
    # ä¾‹å¦‚: runs-on: [self-hosted, large-disk]
    runs-on: ubuntu-latest
    # å¦‚æœéœ€è¦ä½¿ç”¨æ›´å¤§çš„ runnerï¼ˆGitHub Enterprise Cloudï¼‰ï¼Œå¯ä»¥ä½¿ç”¨ï¼š
    # runs-on: ubuntu-latest-4-cores  # ç¤ºä¾‹ï¼Œå®é™…æ ‡ç­¾å¯èƒ½ä¸åŒ
    
    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
      with:
        driver-opts: |
          image=moby/buildkit:latest

    - name: Login to Alibaba Cloud Container Registry
      uses: docker/login-action@v2
      with:
        registry: registry.cn-hangzhou.aliyuncs.com
        username: ${{ secrets.ALIYUN_USERNAME }}
        password: ${{ secrets.ALIYUN_PASSWORD }}

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y jq

    - name: Extend disk space (if possible)
      run: |
        echo "ğŸ’¾ Checking disk space..."
        df -h
        
        # æ£€æŸ¥æ˜¯å¦å·²æœ‰äº¤æ¢æ–‡ä»¶
        if [ -f /swapfile ]; then
          echo "ğŸ“‹ Swap file already exists, skipping creation"
          swapon -s || true
        else
          # æ£€æŸ¥å¯ç”¨ç£ç›˜ç©ºé—´ï¼ˆä»¥ GB ä¸ºå•ä½ï¼‰
          available_gb=$(df / | tail -1 | awk '{print int($4/1024/1024)}')
          echo "ğŸ“Š Available disk space: ${available_gb}GB"
          
          # åªæœ‰åœ¨å¯ç”¨ç©ºé—´å¤§äº 25GB æ—¶æ‰åˆ›å»ºäº¤æ¢æ–‡ä»¶ï¼ˆé¿å…å ç”¨è¿‡å¤šç©ºé—´ï¼‰
          if [ "$available_gb" -gt 25 ]; then
            echo "ğŸ”„ Creating swap file (20GB)..."
            # åˆ›å»ºäº¤æ¢æ–‡ä»¶ï¼ˆ20GBï¼‰
            sudo fallocate -l 20G /swapfile || {
              echo "âš ï¸  fallocate failed, trying dd method..."
              sudo dd if=/dev/zero of=/swapfile bs=1M count=20480 || {
                echo "âŒ Failed to create swap file"
                exit 0  # ä¸é˜»æ­¢å·¥ä½œæµç»§ç»­æ‰§è¡Œ
              }
            }
            
            # è®¾ç½®æƒé™
            sudo chmod 600 /swapfile
            
            # æ ¼å¼åŒ–ä¸ºäº¤æ¢æ–‡ä»¶ç³»ç»Ÿ
            sudo mkswap /swapfile || {
              echo "âš ï¸  Failed to format swap file"
              sudo rm -f /swapfile || true
              exit 0
            }
            
            # å¯ç”¨äº¤æ¢æ–‡ä»¶
            sudo swapon /swapfile || {
              echo "âš ï¸  Failed to enable swap file"
              sudo rm -f /swapfile || true
              exit 0
            }
            
            echo "âœ… Swap file created and enabled successfully (20GB)"
            echo "ğŸ“Š Current swap status:"
            swapon -s || true
            free -h || true
          else
            echo "âš ï¸  Insufficient disk space (${available_gb}GB < 25GB), skipping swap file creation"
            echo "â„¹ï¸  Swap file creation requires at least 25GB free space"
          fi
        fi
        
        echo "ğŸ’¾ Disk space after swap setup:"
        df -h

    - name: Clean Docker system before processing
      run: |
        echo "ğŸ§¹ Cleaning Docker system before processing..."
        docker system prune -af --volumes || true
        echo "ğŸ’¾ Disk space before processing:"
        df -h

    - name: Process images
      env:
        DOCKER_BUILDKIT: 1
        BUILDKIT_PROGRESS: plain
        DOCKER_CLI_EXPERIMENTAL: enabled
      run: |
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘          Job: sync-images                                    â•‘"
        echo "â•‘          Step: Process images                                 â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "=== Starting image processing ==="
        
        # å¯ç”¨ BuildKit å¹¶é…ç½®
        export DOCKER_BUILDKIT=1
        export BUILDKIT_PROGRESS=plain
        
        # é…ç½® Docker ä½¿ç”¨ä¸´æ—¶ç›®å½•ï¼ˆå¦‚æœ /tmp æŒ‚è½½äº†æ›´å¤§çš„ç£ç›˜ï¼‰
        # æ³¨é‡Šï¼šæŸäº› runner å¯èƒ½æŒ‚è½½äº†æ›´å¤§çš„ä¸´æ—¶ç£ç›˜
        export TMPDIR=${TMPDIR:-/tmp}
        echo "ğŸ“ Using temporary directory: $TMPDIR"
        
        # éªŒè¯ BuildKit å·²å¯ç”¨
        echo "ğŸ” Checking BuildKit status..."
        docker buildx version
        docker buildx ls
        
        # é…ç½® BuildKit builder ä»¥ä½¿ç”¨æ›´å¤šå¹¶å‘
        echo "âš™ï¸  Configuring BuildKit for optimal performance..."
        
        # åˆ›å»º BuildKit é…ç½®æ–‡ä»¶æ¥ä¼˜åŒ–æ€§èƒ½
        buildkit_config_dir="$HOME/.docker/buildkit"
        mkdir -p "$buildkit_config_dir"
        
        # BuildKit é…ç½®ï¼šå¯ç”¨æ›´å¤šå¹¶å‘å’Œä¼˜åŒ–çš„ç¼“å­˜
        cat > "$buildkit_config_dir/config.toml" << 'EOF'
[worker.oci]
  max-parallelism = 4
  gc = true
  gckeepduration = 3600s
EOF
        
        echo "âœ… BuildKit configuration applied"
        echo "ğŸ“Š BuildKit settings:"
        echo "   - Max parallelism: 4"
        echo "   - GC enabled: true"
        echo "   - GC keep duration: 1 hour"
        
        # å®šä¹‰æ¸…ç†å‡½æ•°ï¼Œç”¨äºå½»åº•æ¸…ç† Docker ç³»ç»Ÿ
        cleanup_docker() {
          echo "ğŸ§¹ Performing aggressive Docker cleanup..."
          # æ˜¾ç¤ºæ¸…ç†å‰çš„ç£ç›˜ä½¿ç”¨æƒ…å†µ
          echo "ğŸ“Š Disk space before cleanup:"
          df -h | grep -E "^/dev/root|Filesystem"
          echo "ğŸ“Š Docker disk usage before cleanup:"
          docker system df -v || true
          
          # ç§»é™¤æ‰€æœ‰åœæ­¢çš„å®¹å™¨ï¼ˆä¸ä½¿ç”¨ -aï¼Œå› ä¸º -a ä¸æ˜¯æœ‰æ•ˆå‚æ•°ï¼‰
          docker container prune -f || true
          # ç§»é™¤æ‰€æœ‰æœªä½¿ç”¨çš„é•œåƒï¼ˆåŒ…æ‹¬ danglingï¼‰
          docker image prune -af || true
          # ç§»é™¤æ‰€æœ‰æœªä½¿ç”¨çš„å·ï¼ˆä¸ä½¿ç”¨ -aï¼Œå› ä¸º -a ä¸æ˜¯æœ‰æ•ˆå‚æ•°ï¼‰
          docker volume prune -f || true
          # ç§»é™¤æ‰€æœ‰æœªä½¿ç”¨çš„ç½‘ç»œï¼ˆä¸ä½¿ç”¨ -aï¼Œå› ä¸º -a ä¸æ˜¯æœ‰æ•ˆå‚æ•°ï¼‰
          docker network prune -f || true
          # æ¸…ç†æ„å»ºç¼“å­˜ï¼ˆåŒ…æ‹¬ BuildKit ç¼“å­˜ï¼‰
          docker builder prune -af || true
          # æ¸…ç† BuildKit ç¼“å­˜
          docker buildx prune -af || true
          # ç³»ç»Ÿçº§æ¸…ç†ï¼Œç§»é™¤æ‰€æœ‰æœªä½¿ç”¨çš„èµ„æº
          docker system prune -af --volumes || true
          
          echo "ğŸ“Š Disk space after cleanup:"
          df -h | grep -E "^/dev/root|Filesystem"
          echo "ğŸ“Š Docker disk usage after cleanup:"
          docker system df -v || true
        }
        
        # æ£€æŸ¥ç£ç›˜ç©ºé—´å‡½æ•°ï¼Œå¦‚æœå¯ç”¨ç©ºé—´å°äºé˜ˆå€¼åˆ™æ¸…ç†
        check_and_cleanup_if_needed() {
          # è·å–æ ¹åˆ†åŒºä½¿ç”¨ç‡ç™¾åˆ†æ¯”ï¼ˆå»æ‰ç™¾åˆ†å·ï¼‰
          usage_percent=$(df / | tail -1 | awk '{print $5}' | sed 's/%//')
          # å¦‚æœä½¿ç”¨ç‡è¶…è¿‡ 65%ï¼Œæ‰§è¡Œå¼ºåˆ¶æ¸…ç†ï¼ˆé™ä½é˜ˆå€¼ä»¥æå‰æ¸…ç†ï¼‰
          if [ "$usage_percent" -gt 65 ]; then
            echo "âš ï¸  Disk usage is ${usage_percent}%, performing force cleanup..."
            force_cleanup
          elif [ "$usage_percent" -gt 60 ]; then
            echo "âš ï¸  Disk usage is ${usage_percent}%, performing cleanup..."
            cleanup_docker
          fi
        }
        
        # å¼ºåˆ¶æ¸…ç†å‡½æ•°ï¼Œåœ¨å¤„ç†å¤§é•œåƒå‰ä½¿ç”¨
        force_cleanup() {
          echo "ğŸ§¹ Force cleaning Docker system before large image..."
          # æ˜¾ç¤ºæ¸…ç†å‰çš„ç£ç›˜ä½¿ç”¨æƒ…å†µ
          echo "ğŸ“Š Disk space before force cleanup:"
          df -h | grep -E "^/dev/root|Filesystem"
          echo "ğŸ“Š Docker disk usage before force cleanup:"
          docker system df -v || true
          
          # åœæ­¢æ‰€æœ‰è¿è¡Œä¸­çš„å®¹å™¨ï¼ˆå…¼å®¹æ€§å¤„ç†ï¼‰
          running_containers=$(docker ps -q)
          if [ -n "$running_containers" ]; then
            container_count=$(echo "$running_containers" | wc -l)
            echo "ğŸ›‘ Stopping $container_count running containers..."
            echo "$running_containers" | xargs docker stop || true
          fi
          # åˆ é™¤æ‰€æœ‰å®¹å™¨ï¼ˆåŒ…æ‹¬è¿è¡Œä¸­çš„ï¼‰
          container_ids=$(docker ps -aq)
          if [ -n "$container_ids" ]; then
            container_count=$(echo "$container_ids" | wc -l)
            echo "ğŸ—‘ï¸  Removing $container_count containers..."
            echo "$container_ids" | xargs docker rm -f || true
          fi
          # åˆ é™¤æ‰€æœ‰é•œåƒï¼ˆåŒ…æ‹¬æ­£åœ¨ä½¿ç”¨çš„ï¼‰
          image_ids=$(docker images -q)
          if [ -n "$image_ids" ]; then
            image_count=$(echo "$image_ids" | wc -l)
            echo "ğŸ—‘ï¸  Removing $image_count images..."
            echo "$image_ids" | xargs docker rmi -f || true
          fi
          # æ¸…ç†æ‰€æœ‰å·
          docker volume prune -f || true
          # æ¸…ç†ç½‘ç»œ
          docker network prune -f || true
          # æ¸…ç†æ„å»ºç¼“å­˜
          docker builder prune -af || true
          # ç³»ç»Ÿçº§å½»åº•æ¸…ç†
          docker system prune -af --volumes || true
          
          # æ˜¾ç¤º Docker ç£ç›˜ä½¿ç”¨æƒ…å†µ
          echo "ğŸ“Š Disk space after force cleanup:"
          df -h | grep -E "^/dev/root|Filesystem"
          echo "ğŸ“Š Docker disk usage after force cleanup:"
          docker system df -v || true
        }
        
        # Read the JSON file directly in the shell
        count=$(jq 'length' images.json)
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ“¦ Found $count images to process"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        
        # æ£€æµ‹å¤§é•œåƒå¹¶ä¼˜å…ˆå¤„ç†ï¼Œé¿å…åŒæ—¶å¤„ç†å¤šä¸ªå¤§é•œåƒ
        large_images=()
        normal_images=()
        
        for i in $(seq 0 $((count-1))); do
          source=$(jq -r ".[$i].source" images.json)
          if echo "$source" | grep -qiE "(vllm|pytorch|tensorflow|large|big)"; then
            large_images+=($i)
          else
            normal_images+=($i)
          fi
        done
        
        echo "ğŸ“Š Found ${#large_images[@]} large images and ${#normal_images[@]} normal images"
        echo "ğŸ“‹ Processing large images first, then normal images..."
        echo ""
        
        # å…ˆå¤„ç†å¤§é•œåƒï¼ˆé€ä¸ªå¤„ç†ï¼Œé¿å…ç©ºé—´ä¸è¶³ï¼‰
        for idx in "${large_images[@]}"; do
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ”´ Processing LARGE image $((idx+1))/$count"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Extract values one by one with error checking
          source=$(jq -r ".[$idx].source" images.json)
          target=$(jq -r ".[$idx].target" images.json)
          
          if [ "$source" = "null" ] || [ "$target" = "null" ]; then
            echo "âŒ Invalid data at index $idx"
            continue
          fi
          
          # å¤§é•œåƒå¤„ç†å‰å¼ºåˆ¶æ¸…ç†
          echo "âš ï¸  Detected large image (~11GB+), performing aggressive cleanup..."
          force_cleanup
          # å¯¹äºå¤§é•œåƒï¼Œæ£€æŸ¥å¯ç”¨ç©ºé—´ï¼ˆè€Œä¸æ˜¯ä½¿ç”¨ç‡ï¼‰
          available_gb=$(df / | tail -1 | awk '{print int($4/1024/1024)}')
          usage_percent=$(df / | tail -1 | awk '{print $5}' | sed 's/%//')
          echo "ğŸ“Š Disk usage: ${usage_percent}%, Available: ${available_gb}GB"
          
          # å¦‚æœå¯ç”¨ç©ºé—´è¶³å¤Ÿï¼ˆ>=15GBï¼‰æˆ–è€…ä½¿ç”¨ç‡å·²ç»åˆç†ï¼ˆ<75%ï¼‰ï¼Œåˆ™ç»§ç»­
          if [ "$available_gb" -ge 15 ] || [ "$usage_percent" -lt 75 ]; then
            echo "âœ… Sufficient space available (${available_gb}GB free), proceeding with large image"
          else
            # å°è¯•æœ€å¤šæ¸…ç† 3 æ¬¡
            max_cleanup_attempts=3
            cleanup_attempt=0
            previous_usage=$usage_percent
            
            while [ "$cleanup_attempt" -lt "$max_cleanup_attempts" ] && [ "$usage_percent" -gt 75 ] && [ "$available_gb" -lt 15 ]; do
              cleanup_attempt=$((cleanup_attempt + 1))
              echo "âš ï¸  Attempt $cleanup_attempt/$max_cleanup_attempts: Disk usage ${usage_percent}% still high, cleaning again..."
              force_cleanup
              
              # æ£€æŸ¥æ¸…ç†åçš„çŠ¶æ€
              new_usage_percent=$(df / | tail -1 | awk '{print $5}' | sed 's/%//')
              new_available_gb=$(df / | tail -1 | awk '{print int($4/1024/1024)}')
              
              # å¦‚æœæ¸…ç†åæ²¡æœ‰æ”¹å–„ï¼Œåœæ­¢æ¸…ç†
              if [ "$new_usage_percent" -ge "$previous_usage" ] && [ "$new_available_gb" -le "$available_gb" ]; then
                echo "âš ï¸  No improvement after cleanup, stopping cleanup attempts"
                break
              fi
              
              usage_percent=$new_usage_percent
              available_gb=$new_available_gb
              previous_usage=$usage_percent
              sleep 2
            done
            
            echo "ğŸ“Š Final disk status: ${usage_percent}% used, ${available_gb}GB available"
          fi
          
          tag_count=$(jq ".[$idx].tags | length" images.json)
          
          # Get architectures (default to amd64,arm64)
          if jq -e ".[$idx].architectures | type == \"array\"" images.json > /dev/null; then
            arch_count=$(jq ".[$idx].architectures | length" images.json)
          else
            arch_count=2
          fi
          
          echo "Source: $source"
          echo "Target: $target"
          echo "Tag count: $tag_count"
          echo "Architecture count: $arch_count"
          
          # Extract base image name from source (remove tag)
          base_image=$(echo "$source" | cut -d: -f1)
          
          # Process tags - create separate images for each architecture
          for j in $(seq 0 $((tag_count-1))); do
            tag=$(jq -r ".[$idx].tags[$j]" images.json)
            echo "ğŸ·ï¸  Processing tag: $tag"
            
            # Build image reference with current tag
            image_ref="${base_image}:${tag}"
            
            # Process each architecture
            for k in $(seq 0 $((arch_count-1))); do
              if jq -e ".[$idx].architectures | type == \"array\"" images.json > /dev/null; then
                arch=$(jq -r ".[$idx].architectures[$k]" images.json)
              else
                # Default architectures
                case $k in
                  0) arch="amd64" ;;
                  1) arch="arm64" ;;
                  *) continue ;;
                esac
              fi
              
              # Map arch to platform
              case "$arch" in
                "amd64") platform="linux/amd64"; suffix="amd64" ;;
                "arm64") platform="linux/arm64"; suffix="arm64" ;;
                "arm") platform="linux/arm/v7"; suffix="arm" ;;
                *) platform="linux/$arch"; suffix="$arch" ;;
              esac
              
              final_target="registry.cn-hangzhou.aliyuncs.com/${{ secrets.ALIYUN_NAMESPACE }}/${target}-${suffix}:${tag}"
              echo "ğŸ–¥ï¸  Processing architecture: $arch ($platform)"
              
              # åœ¨æ‹‰å–å‰æ£€æŸ¥ç£ç›˜ç©ºé—´
              usage_percent=$(df / | tail -1 | awk '{print $5}' | sed 's/%//')
              available_gb=$(df / | tail -1 | awk '{print int($4/1024/1024)}')
              echo "ğŸ“Š Current disk usage: ${usage_percent}%, Available: ${available_gb}GB"
              
              # å¤§é•œåƒéœ€è¦æ›´å¤šç©ºé—´
              echo "âš ï¸  Large image detected, need at least 15GB free space"
              if [ "$usage_percent" -gt 50 ] || [ "$available_gb" -lt 15 ]; then
                echo "âš ï¸  Insufficient space for large image, performing force cleanup..."
                force_cleanup
                usage_percent=$(df / | tail -1 | awk '{print $5}' | sed 's/%//')
                available_gb=$(df / | tail -1 | awk '{print int($4/1024/1024)}')
                echo "ğŸ“Š Disk usage after cleanup: ${usage_percent}%, Available: ${available_gb}GB"
              fi
              
              echo "ğŸ“¥ Pulling $image_ref for $arch using BuildKit..."
              
              # ä½¿ç”¨ BuildKit ä¼˜åŒ–çš„æ‹‰å–æ–¹æ³•
              # BuildKit å¯ä»¥æ›´å¥½åœ°å¤„ç†å¹¶å‘ä¸‹è½½å’Œç¼“å­˜
              pull_success=false
              for retry in 1 2 3; do
                # ä½¿ç”¨ docker pull é…åˆ BuildKitï¼ˆå·²é€šè¿‡ç¯å¢ƒå˜é‡å¯ç”¨ï¼‰
                # BuildKit ä¼šè‡ªåŠ¨ä¼˜åŒ–ä¸‹è½½è¿‡ç¨‹ï¼Œæ”¯æŒå¹¶å‘ä¸‹è½½å±‚
                if DOCKER_BUILDKIT=1 docker pull --platform "$platform" "$image_ref"; then
                  pull_success=true
                  break
                else
                  if [ $retry -lt 3 ]; then
                    echo "âš ï¸  Pull failed (attempt $retry), performing force cleanup and retrying..."
                    force_cleanup
                    sleep 3
                  fi
                fi
              done
              
              if [ "$pull_success" = true ]; then
                echo "âœ… $arch pull successful"
                echo "ğŸ“¦ Tagging as $final_target"
                if docker tag "$image_ref" "$final_target"; then
                  echo "âœ… Tag successful"
                  echo "ğŸ“¤ Pushing to registry using BuildKit..."
                  
                  # ä½¿ç”¨ BuildKit ä¼˜åŒ–çš„æ¨é€æ–¹æ³•
                  # BuildKit å¯ä»¥æ›´å¥½åœ°å¤„ç†å±‚å‹ç¼©å’Œå¹¶å‘ä¸Šä¼ 
                  if DOCKER_BUILDKIT=1 docker push "$final_target"; then
                    echo "âœ… $arch version pushed successfully: $final_target"
                  else
                    echo "âŒ Failed to push $arch version"
                  fi
                  
                  # ç«‹å³åˆ é™¤ç›®æ ‡é•œåƒæ ‡ç­¾
                  echo "ğŸ—‘ï¸  Removing tagged image: $final_target"
                  docker rmi "$final_target" || true
                else
                  echo "âŒ Failed to tag $arch version"
                fi
                # ç«‹å³åˆ é™¤æºé•œåƒ
                echo "ğŸ—‘ï¸  Removing source image: $image_ref"
                docker rmi "$image_ref" || true
              else
                echo "â­ï¸  $arch not available after 3 attempts, skipping"
              fi
              
              # æ¯ä¸ªæ¶æ„å¤„ç†å®Œåæ£€æŸ¥å¹¶æ¸…ç†æœªä½¿ç”¨çš„é•œåƒï¼ˆé•œåƒå·²æ‰‹åŠ¨åˆ é™¤ï¼Œè¿™é‡Œåªæ¸…ç† danglingï¼‰
              echo "ğŸ§¹ Cleaning up dangling images after architecture processing..."
              docker image prune -f || true
            done
            
            # æ¯ä¸ªæ ‡ç­¾å¤„ç†å®Œåæ£€æŸ¥ç£ç›˜ç©ºé—´ï¼Œä»…åœ¨å¿…è¦æ—¶æ¸…ç†
            echo "ğŸ“Š Checking disk space after tag processing..."
            usage_percent=$(df / | tail -1 | awk '{print $5}' | sed 's/%//')
            available_gb=$(df / | tail -1 | awk '{print int($4/1024/1024)}')
            echo "ğŸ“Š Current disk usage: ${usage_percent}%, Available: ${available_gb}GB"
            
            # å¤§é•œåƒå¤„ç†å®Œåæ€»æ˜¯æ¸…ç†
            echo "âš ï¸  Large image processed, performing cleanup..."
            cleanup_docker
          done
          
          # æ¯ä¸ªå¤§é•œåƒå¤„ç†å®Œåå¼ºåˆ¶æ¸…ç†
          echo "ğŸ“Š Checking disk space after large image processing..."
          usage_percent=$(df / | tail -1 | awk '{print $5}' | sed 's/%//')
          available_gb=$(df / | tail -1 | awk '{print int($4/1024/1024)}')
          echo "ğŸ“Š Current disk usage: ${usage_percent}%, Available: ${available_gb}GB"
          echo "âš ï¸  Large image processed, performing aggressive cleanup..."
          force_cleanup
        done
        
        # å†å¤„ç†æ™®é€šé•œåƒ
        for idx in "${normal_images[@]}"; do
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸŸ¢ Processing image $((idx+1))/$count"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Extract values one by one with error checking
          source=$(jq -r ".[$idx].source" images.json)
          target=$(jq -r ".[$idx].target" images.json)
          
          if [ "$source" = "null" ] || [ "$target" = "null" ]; then
            echo "âŒ Invalid data at index $idx"
            continue
          fi
          
          # åœ¨å¤„ç†æ¯ä¸ªé•œåƒä¹‹å‰æ£€æŸ¥å¹¶æ¸…ç†
          check_and_cleanup_if_needed
          
          tag_count=$(jq ".[$idx].tags | length" images.json)
          
          # Get architectures (default to amd64,arm64)
          if jq -e ".[$idx].architectures | type == \"array\"" images.json > /dev/null; then
            arch_count=$(jq ".[$idx].architectures | length" images.json)
          else
            arch_count=2
          fi
          
          echo "Source: $source"
          echo "Target: $target"
          echo "Tag count: $tag_count"
          echo "Architecture count: $arch_count"
          
          # Extract base image name from source (remove tag)
          base_image=$(echo "$source" | cut -d: -f1)
          
          # Process tags - create separate images for each architecture
          for j in $(seq 0 $((tag_count-1))); do
            tag=$(jq -r ".[$idx].tags[$j]" images.json)
            echo "ğŸ·ï¸  Processing tag: $tag"
            
            # Build image reference with current tag
            image_ref="${base_image}:${tag}"
            
            # Process each architecture
            for k in $(seq 0 $((arch_count-1))); do
              if jq -e ".[$idx].architectures | type == \"array\"" images.json > /dev/null; then
                arch=$(jq -r ".[$idx].architectures[$k]" images.json)
              else
                # Default architectures
                case $k in
                  0) arch="amd64" ;;
                  1) arch="arm64" ;;
                  *) continue ;;
                esac
              fi
              
              # Map arch to platform
              case "$arch" in
                "amd64") platform="linux/amd64"; suffix="amd64" ;;
                "arm64") platform="linux/arm64"; suffix="arm64" ;;
                "arm") platform="linux/arm/v7"; suffix="arm" ;;
                *) platform="linux/$arch"; suffix="$arch" ;;
              esac
              
              final_target="registry.cn-hangzhou.aliyuncs.com/${{ secrets.ALIYUN_NAMESPACE }}/${target}-${suffix}:${tag}"
              echo "ğŸ–¥ï¸  Processing architecture: $arch ($platform)"
              
              # åœ¨æ‹‰å–å‰æ£€æŸ¥ç£ç›˜ç©ºé—´
              usage_percent=$(df / | tail -1 | awk '{print $5}' | sed 's/%//')
              available_gb=$(df / | tail -1 | awk '{print int($4/1024/1024)}')
              echo "ğŸ“Š Current disk usage: ${usage_percent}%, Available: ${available_gb}GB"
              
              # æ™®é€šé•œåƒï¼Œä½¿ç”¨ç‡è¶…è¿‡ 60% åˆ™æ¸…ç†
              if [ "$usage_percent" -gt 60 ]; then
                echo "âš ï¸  Disk usage is ${usage_percent}%, performing cleanup before pull..."
                force_cleanup
                usage_percent=$(df / | tail -1 | awk '{print $5}' | sed 's/%//')
                available_gb=$(df / | tail -1 | awk '{print int($4/1024/1024)}')
                echo "ğŸ“Š Disk usage after cleanup: ${usage_percent}%, Available: ${available_gb}GB"
              fi
              
              echo "ğŸ“¥ Pulling $image_ref for $arch using BuildKit..."
              
              # ä½¿ç”¨ BuildKit ä¼˜åŒ–çš„æ‹‰å–æ–¹æ³•
              # BuildKit å¯ä»¥æ›´å¥½åœ°å¤„ç†å¹¶å‘ä¸‹è½½å’Œç¼“å­˜
              pull_success=false
              for retry in 1 2 3; do
                # ä½¿ç”¨ docker pull é…åˆ BuildKitï¼ˆå·²é€šè¿‡ç¯å¢ƒå˜é‡å¯ç”¨ï¼‰
                # BuildKit ä¼šè‡ªåŠ¨ä¼˜åŒ–ä¸‹è½½è¿‡ç¨‹ï¼Œæ”¯æŒå¹¶å‘ä¸‹è½½å±‚
                if DOCKER_BUILDKIT=1 docker pull --platform "$platform" "$image_ref"; then
                  pull_success=true
                  break
                else
                  if [ $retry -lt 3 ]; then
                    echo "âš ï¸  Pull failed (attempt $retry), performing force cleanup and retrying..."
                    force_cleanup
                    sleep 3
                  fi
                fi
              done
              
              if [ "$pull_success" = true ]; then
                echo "âœ… $arch pull successful"
                echo "ğŸ“¦ Tagging as $final_target"
                if docker tag "$image_ref" "$final_target"; then
                  echo "âœ… Tag successful"
                  echo "ğŸ“¤ Pushing to registry using BuildKit..."
                  
                  # ä½¿ç”¨ BuildKit ä¼˜åŒ–çš„æ¨é€æ–¹æ³•
                  # BuildKit å¯ä»¥æ›´å¥½åœ°å¤„ç†å±‚å‹ç¼©å’Œå¹¶å‘ä¸Šä¼ 
                  if DOCKER_BUILDKIT=1 docker push "$final_target"; then
                    echo "âœ… $arch version pushed successfully: $final_target"
                  else
                    echo "âŒ Failed to push $arch version"
                  fi
                  
                  # ç«‹å³åˆ é™¤ç›®æ ‡é•œåƒæ ‡ç­¾
                  echo "ğŸ—‘ï¸  Removing tagged image: $final_target"
                  docker rmi "$final_target" || true
                else
                  echo "âŒ Failed to tag $arch version"
                fi
                # ç«‹å³åˆ é™¤æºé•œåƒ
                echo "ğŸ—‘ï¸  Removing source image: $image_ref"
                docker rmi "$image_ref" || true
              else
                echo "â­ï¸  $arch not available after 3 attempts, skipping"
              fi
              
              # æ¯ä¸ªæ¶æ„å¤„ç†å®Œåæ£€æŸ¥å¹¶æ¸…ç†æœªä½¿ç”¨çš„é•œåƒï¼ˆé•œåƒå·²æ‰‹åŠ¨åˆ é™¤ï¼Œè¿™é‡Œåªæ¸…ç† danglingï¼‰
              echo "ğŸ§¹ Cleaning up dangling images after architecture processing..."
              docker image prune -f || true
            done
            
            # æ¯ä¸ªæ ‡ç­¾å¤„ç†å®Œåæ£€æŸ¥ç£ç›˜ç©ºé—´ï¼Œä»…åœ¨å¿…è¦æ—¶æ¸…ç†
            echo "ğŸ“Š Checking disk space after tag processing..."
            usage_percent=$(df / | tail -1 | awk '{print $5}' | sed 's/%//')
            available_gb=$(df / | tail -1 | awk '{print int($4/1024/1024)}')
            echo "ğŸ“Š Current disk usage: ${usage_percent}%, Available: ${available_gb}GB"
            
            # åªæœ‰åœ¨ç£ç›˜ä½¿ç”¨ç‡è¶…è¿‡é˜ˆå€¼æ—¶æ‰æ‰§è¡Œæ¸…ç†
            if [ "$usage_percent" -gt 70 ]; then
              echo "âš ï¸  Disk usage is ${usage_percent}%, performing cleanup after tag..."
              cleanup_docker
            else
              echo "âœ… Disk usage OK (${usage_percent}%), skipping cleanup"
            fi
          done
          
          # æ¯ä¸ªé•œåƒå¤„ç†å®Œåæ£€æŸ¥ç£ç›˜ç©ºé—´ï¼Œä»…åœ¨å¿…è¦æ—¶æ¸…ç†
          echo "ğŸ“Š Checking disk space after image processing..."
          usage_percent=$(df / | tail -1 | awk '{print $5}' | sed 's/%//')
          available_gb=$(df / | tail -1 | awk '{print int($4/1024/1024)}')
          echo "ğŸ“Š Current disk usage: ${usage_percent}%, Available: ${available_gb}GB"
          
          # åªæœ‰åœ¨ç£ç›˜ä½¿ç”¨ç‡è¶…è¿‡é˜ˆå€¼æ—¶æ‰æ‰§è¡Œæ¸…ç†
          if [ "$usage_percent" -gt 70 ]; then
            echo "âš ï¸  Disk usage is ${usage_percent}%, performing cleanup after image..."
            cleanup_docker
          else
            echo "âœ… Disk usage OK (${usage_percent}%), skipping cleanup"
          fi
        done

    - name: Summary
      if: always()
      run: |
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘          Job: sync-images                                    â•‘"
        echo "â•‘          Step: Summary                                        â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "ğŸ Processing completed"
        echo "=== Final Docker images ==="
        docker images | grep "${{ secrets.ALIYUN_NAMESPACE }}" || echo "No pushed images found"
        
        # æ¸…ç†äº¤æ¢æ–‡ä»¶ï¼ˆå¦‚æœåœ¨æ­¥éª¤ä¸­åˆ›å»ºäº†ï¼‰
        if [ -f /swapfile ]; then
          echo "ğŸ§¹ Cleaning up swap file..."
          sudo swapoff /swapfile 2>/dev/null || true
          sudo rm -f /swapfile || true
          echo "âœ… Swap file cleaned up"
        fi
        
        echo "ğŸ’¾ Final disk space:"
        df -h
        echo ""
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘          Job: sync-images - COMPLETED                       â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
