name: Sync Image to Aliyun Simple

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *'

jobs:
  sync-images:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    
    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Setup and install dependencies
      run: |
        echo "=== Initial disk space ==="
        df -h
        
        sudo apt-get update
        sudo apt-get install -y skopeo jq
        
        echo "=== Disk space after install ==="
        df -h

    - name: Login to Alibaba Cloud Container Registry
      run: |
        skopeo login \
          --username "${{ secrets.ALIYUN_USERNAME }}" \
          --password "${{ secrets.ALIYUN_PASSWORD }}" \
          registry.cn-hangzhou.aliyuncs.com

    - name: Process images
      run: |
        set +e
        set -x
        
        count=$(jq 'length' images-small.json)
        echo "Found $count images to process"
        
        for i in $(seq 0 $((count-1))); do
          echo "=== Processing image $((i+1))/$count ==="
          
          source=$(jq -r ".[$i].source" images-small.json)
          target=$(jq -r ".[$i].target" images-small.json)
          tag_count=$(jq ".[$i].tags | length" images-small.json)
          arch_count=$(jq ".[$i].architectures | length" images-small.json)
          
          if [ "$source" = "null" ] || [ "$target" = "null" ]; then
            echo "âŒ Invalid data at index $i"
            continue
          fi
          
          for j in $(seq 0 $((tag_count-1))); do
            tag=$(jq -r ".[$i].tags[$j]" images-small.json)
            
            # æ„å»ºæºé•œåƒåç§°
            if echo "$source" | grep -q ":"; then
              source_image="$source"
            else
              source_image="${source}:${tag}"
            fi
            
            # å¤„ç†æ¯ä¸ªæ¶æ„
            for k in $(seq 0 $((arch_count-1))); do
              arch=$(jq -r ".[$i].architectures[$k]" images-small.json)
              final_target="registry.cn-hangzhou.aliyuncs.com/${{ secrets.ALIYUN_NAMESPACE }}/${target}:${tag}-${arch}"
              
              echo "ğŸ“¥ Copying $source_image ($arch) to $final_target"
              
              # æ£€æŸ¥æºé•œåƒçš„ manifest
              source_manifest=$(skopeo inspect --raw "docker://$source_image" 2>/dev/null || echo "")
              copied=false
              
              # å¦‚æœæ˜¯å¤šæ¶æ„é•œåƒï¼Œè·å–ç‰¹å®šæ¶æ„çš„ digest
              if echo "$source_manifest" | jq -e '.manifests' > /dev/null 2>&1; then
                arch_digest=$(echo "$source_manifest" | jq -r ".manifests[] | select(.platform.architecture == \"$arch\" and .platform.os == \"linux\") | .digest" | head -n1)
                if [ -n "$arch_digest" ] && [ "$arch_digest" != "null" ] && echo "$arch_digest" | grep -q "^sha256:"; then
                  # æå–é•œåƒåç§°ï¼ˆå»æ‰æ ‡ç­¾ï¼Œä¿ç•™ä»“åº“åœ°å€ï¼‰
                  if echo "$source_image" | grep -q ":"; then
                    image_name=$(echo "$source_image" | sed 's/:[^@]*$//')
                  else
                    image_name="$source_image"
                  fi
                  
                  # ç¡®ä¿é•œåƒåç§°åŒ…å«å®Œæ•´è·¯å¾„ï¼ˆå¯¹äº dockerhub é•œåƒï¼‰
                  if ! echo "$image_name" | grep -q "/"; then
                    image_name="docker.io/library/$image_name"
                  elif ! echo "$image_name" | grep -q "^docker.io"; then
                    image_name="docker.io/$image_name"
                  fi
                  
                  echo "   Multi-arch image detected"
                  echo "   Image name: $image_name"
                  echo "   Architecture digest: $arch_digest"
                  echo "   Source: docker://${image_name}@${arch_digest}"
                  echo "   Target: docker://$final_target"
                  
                  if timeout 3600 skopeo copy \
                    --src-tls-verify=false \
                    --dest-tls-verify=false \
                    --retry-times 5 \
                    "docker://${image_name}@${arch_digest}" \
                    "docker://$final_target" 2>&1; then
                    # éªŒè¯å¤åˆ¶ç»“æœ
                    if skopeo inspect "docker://$final_target" >/dev/null 2>&1; then
                      copied_size=$(skopeo inspect "docker://$final_target" 2>/dev/null | jq -r '.Size // 0')
                      echo "âœ… Successfully copied $arch version (size: $copied_size bytes)"
                      if [ "$copied_size" = "0" ] || [ -z "$copied_size" ]; then
                        echo "âš ï¸  Warning: Copied image size is 0, may be invalid"
                        copied=false
                      else
                        copied=true
                      fi
                    else
                      echo "âŒ Failed to verify copied image"
                      copied=false
                    fi
                  else
                    copy_exit_code=$?
                    echo "âŒ Failed to copy $arch version using digest (exit code: $copy_exit_code)"
                    copied=false
                  fi
                else
                  echo "âš ï¸  No valid $arch digest found in multi-arch manifest"
                fi
              fi
              
              # å¦‚æœä¸æ˜¯å¤šæ¶æ„é•œåƒæˆ–ä¸Šè¿°æ–¹æ³•å¤±è´¥ï¼Œå°è¯•ç›´æ¥å¤åˆ¶
              if [ "$copied" = "false" ]; then
                echo "   Attempting direct copy..."
                echo "   Source: docker://$source_image"
                echo "   Target: docker://$final_target"
                
                timeout 3600 skopeo copy \
                  --src-tls-verify=false \
                  --dest-tls-verify=false \
                  --retry-times 5 \
                  "docker://$source_image" \
                  "docker://$final_target" 2>&1
                copy_exit_code=$?
                
                if [ $copy_exit_code -eq 0 ]; then
                  # éªŒè¯æ¶æ„å’Œå¤§å°
                  copied_info=$(skopeo inspect "docker://$final_target" 2>/dev/null)
                  if [ -n "$copied_info" ]; then
                    copied_arch=$(echo "$copied_info" | jq -r '.Architecture // "unknown"')
                    copied_size=$(echo "$copied_info" | jq -r '.Size // 0')
                    echo "ğŸ“Š Copied image - Architecture: $copied_arch, Size: $copied_size bytes"
                    
                    if [ "$copied_size" = "0" ] || [ -z "$copied_size" ]; then
                      echo "âŒ Copied image size is 0, copy may have failed"
                      copied=false
                    elif [ "$copied_arch" = "$arch" ] || [ "$copied_arch" = "unknown" ]; then
                      copied=true
                      echo "âœ… Successfully copied $arch version"
                    else
                      echo "âš ï¸  Warning: Copied architecture is $copied_arch, expected $arch"
                      copied=true
                    fi
                  else
                    echo "âŒ Failed to inspect copied image"
                    copied=false
                  fi
                else
                  echo "âŒ Failed to copy $arch version (exit code: $copy_exit_code)"
                  copied=false
                fi
              fi
              
              # æ¨é€å®Œæˆåæ¸…ç†æœ¬åœ°ç¼“å­˜
              if [ "$copied" = "true" ]; then
                echo "ğŸ§¹ Cleaning up local cache..."
                docker system prune -af >/dev/null 2>&1 || true
              fi
            done
          done
          
          # æ¯ä¸ªé•œåƒå¤„ç†å®Œåæ¸…ç†
          echo "ğŸ§¹ Cleaning up after image $((i+1))..."
          docker system prune -af >/dev/null 2>&1 || true
          echo "=== Disk space after cleanup ==="
          df -h
        done

    - name: Summary
      if: always()
      run: |
        echo "ğŸ Processing completed"
        echo "=== Final disk space ==="
        df -h

