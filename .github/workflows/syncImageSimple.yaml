name: Sync Image to Aliyun Simple

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *'

jobs:
  sync-images:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    
    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Setup Docker and dependencies
      run: |
        echo "=== Initial disk space ==="
        df -h
        
        sudo apt-get update
        sudo apt-get install -y jq
        
        echo "=== Disk space after install ==="
        df -h

    - name: Login to Alibaba Cloud Container Registry
      run: |
        echo "${{ secrets.ALIYUN_PASSWORD }}" | docker login \
          --username "${{ secrets.ALIYUN_USERNAME }}" \
          --password-stdin \
          registry.cn-hangzhou.aliyuncs.com

    - name: Process images
      run: |
        set +e
        set -x
        
        count=$(jq 'length' images-small.json)
        echo "Found $count images to process"
        
        for i in $(seq 0 $((count-1))); do
          echo "=== Processing image $((i+1))/$count ==="
          
          source=$(jq -r ".[$i].source" images-small.json)
          target=$(jq -r ".[$i].target" images-small.json)
          tag_count=$(jq ".[$i].tags | length" images-small.json)
          arch_count=$(jq ".[$i].architectures | length" images-small.json)
          
          if [ "$source" = "null" ] || [ "$target" = "null" ]; then
            echo "âŒ Invalid data at index $i"
            continue
          fi
          
          for j in $(seq 0 $((tag_count-1))); do
            tag=$(jq -r ".[$i].tags[$j]" images-small.json)
            
            # æ„å»ºæºé•œåƒåç§°
            if echo "$source" | grep -q ":"; then
              source_image="$source"
            else
              source_image="${source}:${tag}"
            fi
            
            # å­˜å‚¨æˆåŠŸæ¨é€çš„æ¶æ„é•œåƒåˆ—è¡¨
            pushed_manifests=()
            
            # å¤„ç†æ¯ä¸ªæ¶æ„
            for k in $(seq 0 $((arch_count-1))); do
              arch=$(jq -r ".[$i].architectures[$k]" images-small.json)
              arch_target="registry.cn-hangzhou.aliyuncs.com/${{ secrets.ALIYUN_NAMESPACE }}/${target}:${tag}-${arch}"
              
              echo "ğŸ“¥ Pulling $source_image ($arch) to $arch_target"
              
              # æ‹‰å–æŒ‡å®šæ¶æ„çš„é•œåƒ
              if timeout 3600 docker pull --platform linux/$arch "$source_image" 2>&1; then
                # æ‰“æ ‡ç­¾
                docker tag "$source_image" "$arch_target"
                
                # æ¨é€
                if timeout 1800 docker push "$arch_target" 2>&1; then
                  echo "âœ… Successfully pushed $arch version"
                  pushed_manifests+=("$arch_target")
                  
                  # æ¸…ç†æœ¬åœ°é•œåƒ
                  echo "ğŸ§¹ Cleaning up local images..."
                  docker rmi "$source_image" "$arch_target" 2>/dev/null || true
                  docker system prune -af >/dev/null 2>&1 || true
                else
                  echo "âŒ Failed to push $arch version"
                  docker rmi "$source_image" "$arch_target" 2>/dev/null || true
                fi
              else
                echo "âŒ Failed to pull $arch version"
              fi
            done
            
            # å¦‚æœæ‰€æœ‰æ¶æ„éƒ½æˆåŠŸæ¨é€ï¼Œåˆ›å»ºåˆå¹¶çš„ manifest
            if [ ${#pushed_manifests[@]} -eq $arch_count ] && [ $arch_count -gt 1 ]; then
              merged_target="registry.cn-hangzhou.aliyuncs.com/${{ secrets.ALIYUN_NAMESPACE }}/${target}:${tag}"
              echo "ğŸ”— Creating merged manifest $merged_target"
              
              # åˆ›å»º manifest
              docker manifest create "$merged_target" "${pushed_manifests[@]}" 2>&1
              
              # æ¨é€åˆå¹¶çš„ manifest
              if timeout 300 docker manifest push "$merged_target" 2>&1; then
                echo "âœ… Successfully pushed merged manifest $merged_target"
              else
                echo "âŒ Failed to push merged manifest"
              fi
            fi
          done
          
          # æ¯ä¸ªé•œåƒå¤„ç†å®Œåæ¸…ç†
          echo "ğŸ§¹ Cleaning up after image $((i+1))..."
          docker system prune -af >/dev/null 2>&1 || true
          echo "=== Disk space after cleanup ==="
          df -h
        done

    - name: Summary
      if: always()
      run: |
        echo "ğŸ Processing completed"
        echo "=== Final disk space ==="
        df -h
