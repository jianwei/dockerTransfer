name: Sync Image to Aliyun With skopeo

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *'

jobs:
  sync-images:
    runs-on: ubuntu-latest
    timeout-minutes: 120  # ËÆæÁΩÆ 2 Â∞èÊó∂Ë∂ÖÊó∂
    
    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Setup and install dependencies
      run: |
        echo "=== Initial disk space ==="
        df -h
        
        # ÂÆâË£ÖÂøÖË¶ÅÂ∑•ÂÖ∑
        sudo apt-get update
        sudo apt-get install -y skopeo jq wget curl
        
        # Ê≥®ÊÑèÔºö‰ΩøÁî® skopeo Êú¨Ë∫´Êù•ÂàõÂª∫Â§öÊû∂ÊûÑ manifestÔºå‰∏çÈúÄË¶Å manifest-tool
        
        # Ê∏ÖÁêÜÁ©∫Èó¥
        echo "üßπ Cleaning up disk space..."
        sudo docker system prune -af || true
        
        echo "=== Disk space after cleanup ==="
        df -h

    - name: Login to Alibaba Cloud Container Registry
      run: |
        skopeo login \
          --username "${{ secrets.ALIYUN_USERNAME }}" \
          --password "${{ secrets.ALIYUN_PASSWORD }}" \
          registry.cn-hangzhou.aliyuncs.com

    - name: Process images
      run: |
        set +e  # ‰∏çË¶ÅÂõ†‰∏∫ÈîôËØØËÄåÈÄÄÂá∫ÔºåÊàë‰ª¨ÈúÄË¶ÅÂ§ÑÁêÜÈîôËØØ
        set -x  # ÊòæÁ§∫ÊâÄÊúâÊâßË°åÁöÑÂëΩ‰ª§ÔºàÁî®‰∫éË∞ÉËØïÔºâ
        echo "=== Starting image processing ==="
        echo "Current time: $(date)"
        echo "Working directory: $(pwd)"
        
        # Read the JSON file directly in the shell
        count=$(jq 'length' images.json)
        echo "Found $count images to process"
        
        # Simple loop with proper error handling
        for i in $(seq 0 $((count-1))); do
          echo "=== Processing image $((i+1)) ==="
          
          # Extract values one by one with error checking
          source=$(jq -r ".[$i].source" images.json)
          target=$(jq -r ".[$i].target" images.json)
          tag_count=$(jq ".[$i].tags | length" images.json)
          
          echo "Source: $source"
          echo "Target: $target"
          echo "Tag count: $tag_count"
          
          if [ "$source" = "null" ] || [ "$target" = "null" ]; then
            echo "‚ùå Invalid data at index $i"
            continue
          fi
          
          # Process tags - create multi-arch manifest
          for j in $(seq 0 $((tag_count-1))); do
            tag=$(jq -r ".[$i].tags[$j]" images.json)
            echo "üè∑Ô∏è  Processing tag: $tag"
            
            # ÊûÑÂª∫ÊúÄÁªàÁõÆÊ†áÈïúÂÉèÂêçÁß∞
            final_target="registry.cn-hangzhou.aliyuncs.com/${{ secrets.ALIYUN_NAMESPACE }}/${target}:${tag}"
            
            # ‰∏¥Êó∂ÈïúÂÉèÊ†áÁ≠æÔºåÁî®‰∫éÊûÑÂª∫Â§öÊû∂ÊûÑ manifest
            temp_amd64="registry.cn-hangzhou.aliyuncs.com/${{ secrets.ALIYUN_NAMESPACE }}/${target}:${tag}-amd64-temp"
            temp_arm64="registry.cn-hangzhou.aliyuncs.com/${{ secrets.ALIYUN_NAMESPACE }}/${target}:${tag}-arm64-temp"
            
            # Á°ÆÂÆöÊ∫êÈïúÂÉèÂêçÁß∞ÔºöÂ¶ÇÊûú source Â∑≤ÂåÖÂê´Ê†áÁ≠æÂàôÁõ¥Êé•‰ΩøÁî®ÔºåÂê¶ÂàôÊ∑ªÂä† tag
            if echo "$source" | grep -q ":"; then
              source_image="$source"
            else
              source_image="${source}:${tag}"
            fi
            
            # Ê£ÄÊü•Ê∫êÈïúÂÉèÁöÑ manifestÔºåÂà§Êñ≠ÊòØÂê¶ÊòØÂ§öÊû∂ÊûÑÈïúÂÉè
            source_manifest=$(skopeo inspect --raw "docker://$source_image" 2>/dev/null || echo "")
            
            # ‰ΩøÁî® skopeo Â§çÂà∂ amd64 ÁâàÊú¨Âà∞‰∏¥Êó∂Ê†áÁ≠æ
            echo "üì• Copying $source_image for amd64..."
            amd64_copied=false
            
            # Ê£ÄÊü•ÊòØÂê¶ÊòØÂ§öÊû∂ÊûÑÈïúÂÉè
            if echo "$source_manifest" | jq -e '.manifests' > /dev/null 2>&1; then
              # ÊòØÂ§öÊû∂ÊûÑÈïúÂÉèÔºåËé∑Âèñ amd64 Êû∂ÊûÑÁöÑ digest
              amd64_digest=$(echo "$source_manifest" | jq -r '.manifests[] | select(.platform.architecture == "amd64" and .platform.os == "linux") | .digest' | head -n1)
              if [ -n "$amd64_digest" ] && [ "$amd64_digest" != "null" ]; then
                # ÊèêÂèñÈïúÂÉèÂêçÁß∞ÔºàÂéªÊéâÊ†áÁ≠æÔºå‰øùÁïô‰ªìÂ∫ìÂú∞ÂùÄÔºâ
                # Â¶ÇÊûú source_image ÂåÖÂê´Ê†áÁ≠æÔºåÂéªÊéâÊ†áÁ≠æÈÉ®ÂàÜ
                if echo "$source_image" | grep -q ":"; then
                  image_name=$(echo "$source_image" | sed 's/:[^@]*$//')
                else
                  image_name="$source_image"
                fi
                # ‰ΩøÁî® digest Â§çÂà∂ÁâπÂÆöÊû∂ÊûÑ
                echo "   Source: docker://${image_name}@${amd64_digest}"
                echo "   Target: docker://$temp_amd64"
                echo "   Starting copy (this may take a while for large images)..."
                
                if timeout 3600 skopeo copy \
                  --src-tls-verify=false \
                  --dest-tls-verify=false \
                  --retry-times 5 \
                  "docker://${image_name}@${amd64_digest}" \
                  "docker://$temp_amd64" 2>&1; then
                  amd64_copied=true
                  echo "‚úÖ amd64 version copied successfully (from multi-arch manifest)"
                else
                  copy_exit_code=$?
                  if [ $copy_exit_code -eq 124 ]; then
                    echo "‚è±Ô∏è  amd64 copy timed out after 60 minutes"
                  else
                    echo "‚ùå amd64 copy failed with exit code: $copy_exit_code"
                  fi
                  amd64_copied=false
                fi
              fi
            fi
            
            # Â¶ÇÊûú‰∏çÊòØÂ§öÊû∂ÊûÑÈïúÂÉèÊàñ‰∏äËø∞ÊñπÊ≥ïÂ§±Ë¥•ÔºåÂ∞ùËØïÁõ¥Êé•Â§çÂà∂
            if [ "$amd64_copied" = "false" ]; then
              echo "üì• Attempting direct copy for amd64..."
              echo "   Source: docker://$source_image"
              echo "   Target: docker://$temp_amd64"
              echo "   Starting copy (this may take a while for large images)..."
              
              timeout 3600 skopeo copy \
                --src-tls-verify=false \
                --dest-tls-verify=false \
                --retry-times 5 \
                "docker://$source_image" \
                "docker://$temp_amd64" 2>&1
              copy_exit_code=$?
              
              echo "üìã Copy command exit code: $copy_exit_code"
              
              if [ $copy_exit_code -eq 124 ]; then
                echo "‚è±Ô∏è  Copy timed out after 60 minutes"
                amd64_copied=false
              elif [ $copy_exit_code -eq 0 ]; then
                echo "üìã Copy command completed, verifying architecture..."
                # È™åËØÅÊû∂ÊûÑ
                copied_arch=$(skopeo inspect "docker://$temp_amd64" 2>/dev/null | jq -r '.Architecture // "unknown"')
                echo "üìä Detected architecture: $copied_arch"
                if [ "$copied_arch" = "amd64" ]; then
                  amd64_copied=true
                  echo "‚úÖ amd64 version copied successfully"
                else
                  echo "‚ö†Ô∏è  Warning: Copied image architecture is $copied_arch, not amd64"
                  echo "‚ö†Ô∏è  This might be a single-arch image. Continuing anyway..."
                  # ÂØπ‰∫éÂçïÊû∂ÊûÑÈïúÂÉèÔºåÊàë‰ª¨‰ªçÁÑ∂ÁªßÁª≠Ôºå‰ΩÜÊ†áËÆ∞‰∏∫Â∑≤Â§çÂà∂
                  amd64_copied=true
                fi
              else
                echo "‚ùå Failed to copy amd64 version (exit code: $copy_exit_code)"
                amd64_copied=false
              fi
            fi
            
            # ‰ΩøÁî® skopeo Â§çÂà∂ arm64 ÁâàÊú¨Âà∞‰∏¥Êó∂Ê†áÁ≠æ
            echo "üì• Copying $source_image for arm64..."
            arm64_copied=false
            
            # Ê£ÄÊü•ÊòØÂê¶ÊòØÂ§öÊû∂ÊûÑÈïúÂÉè
            if echo "$source_manifest" | jq -e '.manifests' > /dev/null 2>&1; then
              # ÊòØÂ§öÊû∂ÊûÑÈïúÂÉèÔºåËé∑Âèñ arm64 Êû∂ÊûÑÁöÑ digest
              arm64_digest=$(echo "$source_manifest" | jq -r '.manifests[] | select(.platform.architecture == "arm64" and .platform.os == "linux") | .digest' | head -n1)
              if [ -n "$arm64_digest" ] && [ "$arm64_digest" != "null" ]; then
                # ÊèêÂèñÈïúÂÉèÂêçÁß∞ÔºàÂéªÊéâÊ†áÁ≠æÔºå‰øùÁïô‰ªìÂ∫ìÂú∞ÂùÄÔºâ
                # Â¶ÇÊûú source_image ÂåÖÂê´Ê†áÁ≠æÔºåÂéªÊéâÊ†áÁ≠æÈÉ®ÂàÜ
                if echo "$source_image" | grep -q ":"; then
                  image_name=$(echo "$source_image" | sed 's/:[^@]*$//')
                else
                  image_name="$source_image"
                fi
                # ‰ΩøÁî® digest Â§çÂà∂ÁâπÂÆöÊû∂ÊûÑÔºàÊ∑ªÂä†Ë∂ÖÊó∂Â§ÑÁêÜÔºâ
                echo "   Source: docker://${image_name}@${arm64_digest}"
                echo "   Target: docker://$temp_arm64"
                echo "   Starting copy with timeout (this may take a while for large images)..."
                
                # ‰ΩøÁî® timeout ÂëΩ‰ª§ËÆæÁΩÆË∂ÖÊó∂Ôºà30ÂàÜÈíüÔºâ
                if timeout 1800 skopeo copy \
                  --src-tls-verify=false \
                  --dest-tls-verify=false \
                  --retry-times 5 \
                  "docker://${image_name}@${arm64_digest}" \
                  "docker://$temp_arm64" 2>&1; then
                  arm64_copied=true
                  echo "‚úÖ arm64 version copied successfully (from multi-arch manifest)"
                else
                  copy_exit_code=$?
                  if [ $copy_exit_code -eq 124 ]; then
                    echo "‚è±Ô∏è  arm64 copy timed out after 30 minutes"
                  else
                    echo "‚ùå arm64 copy failed with exit code: $copy_exit_code"
                  fi
                  arm64_copied=false
                fi
              else
                echo "‚ö†Ô∏è  No arm64 architecture found in multi-arch manifest"
                arm64_copied=false
              fi
            fi
            
            # Â¶ÇÊûú‰∏çÊòØÂ§öÊû∂ÊûÑÈïúÂÉèÊàñ‰∏äËø∞ÊñπÊ≥ïÂ§±Ë¥•ÔºåÂ∞ùËØïÁõ¥Êé•Â§çÂà∂
            if [ "$arm64_copied" = "false" ]; then
              echo "üì• Attempting direct copy for arm64..."
              echo "   Source: docker://$source_image"
              echo "   Target: docker://$temp_arm64"
              
              # ÊâßË°åÂ§çÂà∂Âπ∂ÊçïËé∑ÈÄÄÂá∫Á†ÅÔºàÊ∑ªÂä†Ë∂ÖÊó∂Â§ÑÁêÜÔºâ
              echo "   Starting copy with timeout (this may take a while for large images)..."
              timeout 1800 skopeo copy \
                --src-tls-verify=false \
                --dest-tls-verify=false \
                --retry-times 5 \
                "docker://$source_image" \
                "docker://$temp_arm64" 2>&1
              copy_exit_code=$?
              
              echo "üìã Copy command exit code: $copy_exit_code"
              
              if [ $copy_exit_code -eq 124 ]; then
                echo "‚è±Ô∏è  Copy timed out after 30 minutes"
                arm64_copied=false
              elif [ $copy_exit_code -eq 0 ]; then
                echo "üìã Copy command completed successfully, verifying architecture..."
                # È™åËØÅÊû∂ÊûÑ
                copied_arch=$(skopeo inspect "docker://$temp_arm64" 2>/dev/null | jq -r '.Architecture // "unknown"')
                echo "üìä Detected architecture: $copied_arch"
                if [ "$copied_arch" = "arm64" ]; then
                  arm64_copied=true
                  echo "‚úÖ arm64 version copied successfully"
                else
                  echo "‚ö†Ô∏è  Warning: Copied image architecture is $copied_arch, not arm64"
                  echo "‚ö†Ô∏è  This might be a single-arch image. Continuing anyway..."
                  # ÂØπ‰∫éÂçïÊû∂ÊûÑÈïúÂÉèÔºåÊàë‰ª¨‰ªçÁÑ∂ÁªßÁª≠Ôºå‰ΩÜÊ†áËÆ∞‰∏∫Â∑≤Â§çÂà∂
                  arm64_copied=true
                fi
              else
                echo "‚ùå Failed to copy arm64 version (exit code: $copy_exit_code)"
                echo "‚ö†Ô∏è  Will continue with amd64 only if available"
                arm64_copied=false
              fi
            fi
            
            # Ê£ÄÊü•Âì™‰∫õÊû∂ÊûÑÊàêÂäüÂ§çÂà∂
            echo ""
            echo "=========================================="
            echo "üìä Copy status summary:"
            echo "   amd64: $amd64_copied"
            echo "   arm64: $arm64_copied"
            echo "=========================================="
            echo ""
            
            # Âº∫Âà∂Ê£ÄÊü•ÔºöÁ°Æ‰øùËá≥Â∞ë amd64 Â∑≤Â§çÂà∂ÔºàÂõ†‰∏∫ÂÆÉÊòØÂøÖÈúÄÁöÑÔºâ
            if [ "$amd64_copied" = "false" ]; then
              echo "‚ùå CRITICAL: amd64 copy failed, cannot proceed"
              echo "‚ö†Ô∏è  Checking if amd64 image exists at temporary location..."
              if skopeo inspect "docker://$temp_amd64" >/dev/null 2>&1; then
                echo "‚úÖ amd64 image exists at $temp_amd64, marking as copied"
                amd64_copied=true
              else
                echo "‚ùå amd64 image does not exist, skipping this image"
                continue
              fi
            fi
            
            # Â¶ÇÊûú‰∏§‰∏™Êû∂ÊûÑÈÉΩÊ≤°ÊúâÊàêÂäüÔºåË∑≥Ëøá
            if [ "$amd64_copied" = "false" ] && [ "$arm64_copied" = "false" ]; then
              echo "‚ùå Both architectures failed to copy, skipping..."
              continue
            fi
            
            # Â¶ÇÊûúÂè™Êúâ‰∏Ä‰∏™Êû∂ÊûÑÊàêÂäüÔºåÁõ¥Êé•Â§çÂà∂Âà∞ÊúÄÁªàÁõÆÊ†áÔºà‰∏çÈúÄË¶Å manifest listÔºâ
            if [ "$amd64_copied" = "true" ] && [ "$arm64_copied" = "false" ]; then
              echo "‚ö†Ô∏è  Only amd64 architecture available, copying directly to final target..."
              echo "   Source: docker://$temp_amd64"
              echo "   Target: docker://$final_target"
              echo "   Current time: $(date)"
              
              echo "üì§ Pushing amd64 image to final target..."
              if timeout 1800 skopeo copy \
                --src-tls-verify=false \
                --dest-tls-verify=false \
                --retry-times 5 \
                "docker://$temp_amd64" \
                "docker://$final_target" 2>&1; then
                echo "‚úÖ Single-arch (amd64) image pushed successfully: $final_target"
                
                # È™åËØÅÊúÄÁªàÈïúÂÉè
                echo "üîç Verifying final image..."
                if skopeo inspect "docker://$final_target" >/dev/null 2>&1; then
                  echo "‚úÖ Final image verified successfully"
                else
                  echo "‚ö†Ô∏è  Warning: Final image verification failed"
                fi
                
                # Ê∏ÖÁêÜ‰∏¥Êó∂Ê†áÁ≠æ
                skopeo delete "docker://$temp_amd64" 2>/dev/null || true
                continue
              else
                echo "‚ùå Failed to copy single-arch image to final target"
                echo "‚ö†Ô∏è  Temporary image still available at: $temp_amd64"
                continue
              fi
            fi
            
            if [ "$amd64_copied" = "false" ] && [ "$arm64_copied" = "true" ]; then
              echo "‚ö†Ô∏è  Only arm64 architecture available, copying directly to final target..."
              echo "   Source: docker://$temp_arm64"
              echo "   Target: docker://$final_target"
              
              if skopeo copy \
                --src-tls-verify=false \
                --dest-tls-verify=false \
                --retry-times 5 \
                "docker://$temp_arm64" \
                "docker://$final_target"; then
                echo "‚úÖ Single-arch (arm64) image pushed successfully: $final_target"
                
                # È™åËØÅÊúÄÁªàÈïúÂÉè
                echo "üîç Verifying final image..."
                if skopeo inspect "docker://$final_target" >/dev/null 2>&1; then
                  echo "‚úÖ Final image verified successfully"
                else
                  echo "‚ö†Ô∏è  Warning: Final image verification failed"
                fi
                
                # Ê∏ÖÁêÜ‰∏¥Êó∂Ê†áÁ≠æ
                skopeo delete "docker://$temp_arm64" 2>/dev/null || true
                continue
              else
                echo "‚ùå Failed to copy single-arch image to final target"
                echo "‚ö†Ô∏è  Temporary image still available at: $temp_arm64"
                continue
              fi
            fi
            
            # Â¶ÇÊûú‰∏§‰∏™Êû∂ÊûÑÈÉΩÊàêÂäüÔºåÂàõÂª∫Â§öÊû∂ÊûÑ manifest
            echo "üîó Creating multi-arch manifest for $final_target"
            
            # Ëé∑Âèñ‰∏§‰∏™Êû∂ÊûÑÁöÑ manifest ËØ¶ÁªÜ‰ø°ÊÅØ
            echo "üìã Getting manifest information for amd64..."
            amd64_info=$(skopeo inspect "docker://$temp_amd64" 2>/dev/null)
            if [ -z "$amd64_info" ]; then
              echo "‚ùå Failed to inspect amd64 image"
              continue
            fi
            amd64_digest=$(echo "$amd64_info" | jq -r '.Digest')
            amd64_manifest=$(skopeo inspect --raw "docker://$temp_amd64" 2>/dev/null)
            # manifest Â§ßÂ∞èÊòØ JSON ÁöÑÂ≠óËäÇÊï∞
            amd64_size=$(echo -n "$amd64_manifest" | wc -c)
            
            echo "üìã Getting manifest information for arm64..."
            arm64_info=$(skopeo inspect "docker://$temp_arm64" 2>/dev/null)
            if [ -z "$arm64_info" ]; then
              echo "‚ùå Failed to inspect arm64 image"
              continue
            fi
            arm64_digest=$(echo "$arm64_info" | jq -r '.Digest')
            arm64_manifest=$(skopeo inspect --raw "docker://$temp_arm64" 2>/dev/null)
            # manifest Â§ßÂ∞èÊòØ JSON ÁöÑÂ≠óËäÇÊï∞
            arm64_size=$(echo -n "$arm64_manifest" | wc -c)
            
            echo "üìä Manifest digests:"
            echo "   amd64: $amd64_digest (size: $amd64_size bytes)"
            echo "   arm64: $arm64_digest (size: $arm64_size bytes)"
            
            # È™åËØÅ digest Ê†ºÂºè
            if [ -z "$amd64_digest" ] || [ "$amd64_digest" = "null" ] || ! echo "$amd64_digest" | grep -q "^sha256:"; then
              echo "‚ùå Invalid amd64 digest: $amd64_digest"
              continue
            fi
            if [ -z "$arm64_digest" ] || [ "$arm64_digest" = "null" ] || ! echo "$arm64_digest" | grep -q "^sha256:"; then
              echo "‚ùå Invalid arm64 digest: $arm64_digest"
              continue
            fi
            
            # ÂàõÂª∫ manifest list
            manifest_list=$(jq -n \
              --arg amd64_digest "$amd64_digest" \
              --arg arm64_digest "$arm64_digest" \
              --argjson amd64_size "$amd64_size" \
              --argjson arm64_size "$arm64_size" \
              '{
                "schemaVersion": 2,
                "mediaType": "application/vnd.docker.distribution.manifest.list.v2+json",
                "manifests": [
                  {
                    "mediaType": "application/vnd.docker.distribution.manifest.v2+json",
                    "size": $amd64_size,
                    "digest": $amd64_digest,
                    "platform": {
                      "architecture": "amd64",
                      "os": "linux"
                    }
                  },
                  {
                    "mediaType": "application/vnd.docker.distribution.manifest.v2+json",
                    "size": $arm64_size,
                    "digest": $arm64_digest,
                    "platform": {
                      "architecture": "arm64",
                      "os": "linux"
                    }
                  }
                ]
              }')
            
            # Â∞Ü manifest list ‰øùÂ≠òÂà∞‰∏¥Êó∂Êñá‰ª∂
            echo "$manifest_list" > /tmp/manifest-list.json
            
            # ‰ΩøÁî® Docker Registry API Êé®ÈÄÅ manifest list
            # ÊèêÂèñ registry ÂíåÈïúÂÉèË∑ØÂæÑ
            registry_host=$(echo "$final_target" | sed 's|/.*||')
            image_path=$(echo "$final_target" | sed "s|^${registry_host}/||" | sed 's|:.*||')
            image_tag=$(echo "$final_target" | sed 's|.*:||')
            
            # Ëé∑ÂèñËÆ§ËØÅ tokenÔºà‰ΩøÁî® skopeo ÁöÑËÆ§ËØÅ‰ø°ÊÅØÔºâ
            echo "üîê Getting authentication token..."
            auth_response=$(curl -s -u "${{ secrets.ALIYUN_USERNAME }}:${{ secrets.ALIYUN_PASSWORD }}" \
              "https://${registry_host}/v2/token?service=${registry_host}&scope=repository:${image_path}:pull,push")
            
            # Â¶ÇÊûú‰∏äÈù¢ÁöÑ API ‰∏çÂ≠òÂú®ÔºåÂ∞ùËØï‰ΩøÁî®Ê†áÂáÜÁöÑ Docker registry ËÆ§ËØÅ
            # Â§ßÂ§öÊï∞ registry ‰ΩøÁî® /v2/ Á´ØÁÇπ
            token=""
            if [ -n "$auth_response" ] && echo "$auth_response" | jq -e '.token' >/dev/null 2>&1; then
              token=$(echo "$auth_response" | jq -r '.token')
            else
              # Â∞ùËØïÊ†áÂáÜ Docker registry ËÆ§ËØÅÊµÅÁ®ã
              auth_url="https://${registry_host}/v2/"
              www_auth=$(curl -s -I "$auth_url" | grep -i "www-authenticate" | cut -d' ' -f2-)
              if [ -n "$www_auth" ]; then
                # Ëß£Êûê WWW-Authenticate header Ëé∑ÂèñËÆ§ËØÅÊúçÂä°
                realm=$(echo "$www_auth" | grep -oP 'realm="[^"]+"' | cut -d'"' -f2)
                service=$(echo "$www_auth" | grep -oP 'service="[^"]+"' | cut -d'"' -f2)
                scope="repository:${image_path}:pull,push"
                
                if [ -n "$realm" ] && [ -n "$service" ]; then
                  token_url="${realm}?service=${service}&scope=${scope}"
                  auth_response=$(curl -s -u "${{ secrets.ALIYUN_USERNAME }}:${{ secrets.ALIYUN_PASSWORD }}" "$token_url")
                  if echo "$auth_response" | jq -e '.token' >/dev/null 2>&1; then
                    token=$(echo "$auth_response" | jq -r '.token')
                  fi
                fi
              fi
            fi
            
            # Â¶ÇÊûúËé∑ÂèñÂà∞ tokenÔºåÊé®ÈÄÅ manifest list
            manifest_created=false
            if [ -n "$token" ] && [ "$token" != "null" ]; then
              echo "üì§ Pushing multi-arch manifest list..."
              manifest_size=$(echo "$manifest_list" | wc -c)
              put_url="https://${registry_host}/v2/${image_path}/manifests/${image_tag}"
              
              http_response=$(curl -s -X PUT "$put_url" \
                -H "Authorization: Bearer $token" \
                -H "Content-Type: application/vnd.docker.distribution.manifest.list.v2+json" \
                -H "Content-Length: $manifest_size" \
                --data-binary @/tmp/manifest-list.json \
                -w "\nHTTP_STATUS:%{http_code}")
              
              http_code=$(echo "$http_response" | grep -oP 'HTTP_STATUS:\K\d+')
              
              if [ "$http_code" = "201" ] || [ "$http_code" = "200" ]; then
                echo "‚úÖ Multi-arch manifest created successfully: $final_target"
                manifest_created=true
                
                # È™åËØÅ manifest list ÊòØÂê¶ÂàõÂª∫ÊàêÂäü
                echo "üîç Verifying manifest list..."
                if skopeo inspect "docker://$final_target" >/dev/null 2>&1; then
                  echo "‚úÖ Manifest list verified successfully"
                else
                  echo "‚ö†Ô∏è  Warning: Manifest list verification failed"
                fi
              else
                echo "‚ùå Failed to push manifest list via API (HTTP $http_code)"
                echo "   Response: $(echo "$http_response" | head -n -1)"
                echo "‚ö†Ô∏è  Individual architecture images are still available at:"
                echo "   - $temp_amd64"
                echo "   - $temp_arm64"
              fi
            else
              echo "‚ö†Ô∏è  Could not obtain authentication token"
              echo "üìù Individual architecture images are available at:"
              echo "   - $temp_amd64"
              echo "   - $temp_arm64"
              echo "üí° You can create the multi-arch manifest manually using:"
              echo "   docker buildx imagetools create -t $final_target $temp_amd64 $temp_arm64"
            fi
            
            # Ê∏ÖÁêÜ‰∏¥Êó∂Êñá‰ª∂
            rm -f /tmp/manifest-list.json
            
            # Ê≥®ÊÑèÔºömanifest list ÂºïÁî®ÁöÑÊòØ manifest ÁöÑ digestÔºåËÄå‰∏çÊòØÊ†áÁ≠æ
            # Âè™Ë¶Å manifest ÂíåÁõ∏ÂÖ≥ÁöÑ blob ËøòÂú®ÔºåÂç≥‰ΩøÂà†Èô§Ê†áÁ≠æÔºåmanifest list ‰πüËÉΩÊ≠£Â∏∏Â∑•‰Ωú
            # ‰ΩÜÊòØÔºå‰∏∫‰∫ÜÂÆâÂÖ®Ëµ∑ËßÅÔºåÊàë‰ª¨‰øùÁïô‰∏¥Êó∂Ê†áÁ≠æÔºåÂõ†‰∏∫ÂÆÉ‰ª¨Âç†Áî®ÁöÑÁ©∫Èó¥ÂæàÂ∞èÔºàÂè™ÊòØÊ†áÁ≠æÂºïÁî®Ôºâ
            # Â¶ÇÊûúÁ°ÆÂÆûÈúÄË¶ÅÊ∏ÖÁêÜÔºåÂèØ‰ª•‰ΩøÁî® registry ÁöÑÂûÉÂúæÂõûÊî∂ÂäüËÉΩ
            if [ "$manifest_created" = "true" ]; then
              echo "‚úÖ Multi-arch manifest list created successfully"
              echo "üìù Note: Temporary tags are kept to ensure manifest list references remain valid"
              echo "   - $temp_amd64"
              echo "   - $temp_arm64"
              echo "üí° These tags can be manually deleted later if needed, but keeping them is safe"
              
              # ÂèØÈÄâÔºöÂ¶ÇÊûúÁ°ÆÂÆûÈúÄË¶ÅÊ∏ÖÁêÜ‰∏¥Êó∂Ê†áÁ≠æÔºåÂèñÊ∂à‰∏ãÈù¢ÁöÑÊ≥®Èáä
              # echo "üßπ Cleaning up temporary tags..."
              # sleep 5  # Á≠âÂæÖÁ°Æ‰øù manifest list Â∑≤ÂÆåÂÖ®ÂàõÂª∫
              # skopeo delete "docker://$temp_amd64" 2>/dev/null || echo "‚ö†Ô∏è  Failed to delete $temp_amd64"
              # skopeo delete "docker://$temp_arm64" 2>/dev/null || echo "‚ö†Ô∏è  Failed to delete $temp_arm64"
            else
              echo "‚ö†Ô∏è  Keeping temporary tags for manual manifest list creation:"
              echo "   - $temp_amd64"
              echo "   - $temp_arm64"
            fi
          done
        done

    - name: Summary
      if: always()
      run: |
        echo "üèÅ Processing completed"
        echo "=== Final disk space ==="
        df -h
