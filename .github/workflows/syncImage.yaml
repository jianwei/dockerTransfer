name: Sync Image to Aliyun With skopeo

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *'

jobs:
  sync-images:
    runs-on: ubuntu-latest
    timeout-minutes: 120  # è®¾ç½® 2 å°æ—¶è¶…æ—¶
    
    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Setup and install dependencies
      run: |
        echo "=== Initial disk space ==="
        df -h
        
        # å®‰è£…å¿…è¦å·¥å…·
        sudo apt-get update
        sudo apt-get install -y skopeo jq wget curl
        
        # æ³¨æ„ï¼šä½¿ç”¨ skopeo æœ¬èº«æ¥åˆ›å»ºå¤šæ¶æ„ manifestï¼Œä¸éœ€è¦ manifest-tool
        
        # æ¸…ç†ç©ºé—´
        echo "ğŸ§¹ Cleaning up disk space..."
        sudo docker system prune -af || true
        
        echo "=== Disk space after cleanup ==="
        df -h

    - name: Login to Alibaba Cloud Container Registry
      run: |
        skopeo login \
          --username "${{ secrets.ALIYUN_USERNAME }}" \
          --password "${{ secrets.ALIYUN_PASSWORD }}" \
          registry.cn-hangzhou.aliyuncs.com

    - name: Process images
      run: |
        set +e  # ä¸è¦å› ä¸ºé”™è¯¯è€Œé€€å‡ºï¼Œæˆ‘ä»¬éœ€è¦å¤„ç†é”™è¯¯
        set -x  # æ˜¾ç¤ºæ‰€æœ‰æ‰§è¡Œçš„å‘½ä»¤ï¼ˆç”¨äºè°ƒè¯•ï¼‰
        echo "=== Starting image processing ==="
        echo "Current time: $(date)"
        echo "Working directory: $(pwd)"
        
        # Read the JSON file directly in the shell
        count=$(jq 'length' images.json)
        echo "Found $count images to process"
        
        # Simple loop with proper error handling
        for i in $(seq 0 $((count-1))); do
          echo "=== Processing image $((i+1)) ==="
          
          # Extract values one by one with error checking
          source=$(jq -r ".[$i].source" images.json)
          target=$(jq -r ".[$i].target" images.json)
          tag_count=$(jq ".[$i].tags | length" images.json)
          
          echo "Source: $source"
          echo "Target: $target"
          echo "Tag count: $tag_count"
          
          if [ "$source" = "null" ] || [ "$target" = "null" ]; then
            echo "âŒ Invalid data at index $i"
            continue
          fi
          
          # Process tags - create multi-arch manifest
          for j in $(seq 0 $((tag_count-1))); do
            tag=$(jq -r ".[$i].tags[$j]" images.json)
            echo "ğŸ·ï¸  Processing tag: $tag"
            
            # æ„å»ºæœ€ç»ˆç›®æ ‡é•œåƒåç§°
            final_target="registry.cn-hangzhou.aliyuncs.com/${{ secrets.ALIYUN_NAMESPACE }}/${target}:${tag}"
            
            # ä¸´æ—¶é•œåƒæ ‡ç­¾ï¼Œç”¨äºæ„å»ºå¤šæ¶æ„ manifest
            temp_amd64="registry.cn-hangzhou.aliyuncs.com/${{ secrets.ALIYUN_NAMESPACE }}/${target}:${tag}-amd64-temp"
            temp_arm64="registry.cn-hangzhou.aliyuncs.com/${{ secrets.ALIYUN_NAMESPACE }}/${target}:${tag}-arm64-temp"
            
            # ç¡®å®šæºé•œåƒåç§°ï¼šå¦‚æœ source å·²åŒ…å«æ ‡ç­¾åˆ™ç›´æ¥ä½¿ç”¨ï¼Œå¦åˆ™æ·»åŠ  tag
            if echo "$source" | grep -q ":"; then
              source_image="$source"
            else
              source_image="${source}:${tag}"
            fi
            
            # æ£€æŸ¥æºé•œåƒçš„ manifestï¼Œåˆ¤æ–­æ˜¯å¦æ˜¯å¤šæ¶æ„é•œåƒ
            source_manifest=$(skopeo inspect --raw "docker://$source_image" 2>/dev/null || echo "")
            
            # ä½¿ç”¨ skopeo å¤åˆ¶ amd64 ç‰ˆæœ¬åˆ°ä¸´æ—¶æ ‡ç­¾
            echo "ğŸ“¥ Copying $source_image for amd64..."
            amd64_copied=false
            
            # æ£€æŸ¥æ˜¯å¦æ˜¯å¤šæ¶æ„é•œåƒ
            if echo "$source_manifest" | jq -e '.manifests' > /dev/null 2>&1; then
              # æ˜¯å¤šæ¶æ„é•œåƒï¼Œè·å– amd64 æ¶æ„çš„ digest
              amd64_digest=$(echo "$source_manifest" | jq -r '.manifests[] | select(.platform.architecture == "amd64" and .platform.os == "linux") | .digest' | head -n1)
              if [ -n "$amd64_digest" ] && [ "$amd64_digest" != "null" ]; then
                # æå–é•œåƒåç§°ï¼ˆå»æ‰æ ‡ç­¾ï¼Œä¿ç•™ä»“åº“åœ°å€ï¼‰
                # å¦‚æœ source_image åŒ…å«æ ‡ç­¾ï¼Œå»æ‰æ ‡ç­¾éƒ¨åˆ†
                if echo "$source_image" | grep -q ":"; then
                  image_name=$(echo "$source_image" | sed 's/:[^@]*$//')
                else
                  image_name="$source_image"
                fi
                # ä½¿ç”¨ digest å¤åˆ¶ç‰¹å®šæ¶æ„
                echo "   Source: docker://${image_name}@${amd64_digest}"
                echo "   Target: docker://$temp_amd64"
                echo "   Starting copy (this may take a while for large images)..."
                
                if timeout 3600 skopeo copy \
                  --src-tls-verify=false \
                  --dest-tls-verify=false \
                  --retry-times 5 \
                  "docker://${image_name}@${amd64_digest}" \
                  "docker://$temp_amd64" 2>&1; then
                  amd64_copied=true
                  echo "âœ… amd64 version copied successfully (from multi-arch manifest)"
                else
                  copy_exit_code=$?
                  if [ $copy_exit_code -eq 124 ]; then
                    echo "â±ï¸  amd64 copy timed out after 60 minutes"
                  else
                    echo "âŒ amd64 copy failed with exit code: $copy_exit_code"
                  fi
                  amd64_copied=false
                fi
              fi
            fi
            
            # å¦‚æœä¸æ˜¯å¤šæ¶æ„é•œåƒæˆ–ä¸Šè¿°æ–¹æ³•å¤±è´¥ï¼Œå°è¯•ç›´æ¥å¤åˆ¶
            if [ "$amd64_copied" = "false" ]; then
              echo "ğŸ“¥ Attempting direct copy for amd64..."
              echo "   Source: docker://$source_image"
              echo "   Target: docker://$temp_amd64"
              echo "   Starting copy (this may take a while for large images)..."
              
              timeout 3600 skopeo copy \
                --src-tls-verify=false \
                --dest-tls-verify=false \
                --retry-times 5 \
                "docker://$source_image" \
                "docker://$temp_amd64" 2>&1
              copy_exit_code=$?
              
              echo "ğŸ“‹ Copy command exit code: $copy_exit_code"
              
              if [ $copy_exit_code -eq 124 ]; then
                echo "â±ï¸  Copy timed out after 60 minutes"
                amd64_copied=false
              elif [ $copy_exit_code -eq 0 ]; then
                echo "ğŸ“‹ Copy command completed, verifying architecture..."
                # éªŒè¯æ¶æ„
                copied_arch=$(skopeo inspect "docker://$temp_amd64" 2>/dev/null | jq -r '.Architecture // "unknown"')
                echo "ğŸ“Š Detected architecture: $copied_arch"
                if [ "$copied_arch" = "amd64" ]; then
                  amd64_copied=true
                  echo "âœ… amd64 version copied successfully"
                else
                  echo "âš ï¸  Warning: Copied image architecture is $copied_arch, not amd64"
                  echo "âš ï¸  This might be a single-arch image. Continuing anyway..."
                  # å¯¹äºå•æ¶æ„é•œåƒï¼Œæˆ‘ä»¬ä»ç„¶ç»§ç»­ï¼Œä½†æ ‡è®°ä¸ºå·²å¤åˆ¶
                  amd64_copied=true
                fi
              else
                echo "âŒ Failed to copy amd64 version (exit code: $copy_exit_code)"
                amd64_copied=false
              fi
            fi
            
            # ä½¿ç”¨ skopeo å¤åˆ¶ arm64 ç‰ˆæœ¬åˆ°ä¸´æ—¶æ ‡ç­¾
            echo "ğŸ“¥ Copying $source_image for arm64..."
            arm64_copied=false
            
            # æ£€æŸ¥æ˜¯å¦æ˜¯å¤šæ¶æ„é•œåƒ
            if echo "$source_manifest" | jq -e '.manifests' > /dev/null 2>&1; then
              # æ˜¯å¤šæ¶æ„é•œåƒï¼Œè·å– arm64 æ¶æ„çš„ digest
              arm64_digest=$(echo "$source_manifest" | jq -r '.manifests[] | select(.platform.architecture == "arm64" and .platform.os == "linux") | .digest' | head -n1)
              if [ -n "$arm64_digest" ] && [ "$arm64_digest" != "null" ]; then
                # æå–é•œåƒåç§°ï¼ˆå»æ‰æ ‡ç­¾ï¼Œä¿ç•™ä»“åº“åœ°å€ï¼‰
                # å¦‚æœ source_image åŒ…å«æ ‡ç­¾ï¼Œå»æ‰æ ‡ç­¾éƒ¨åˆ†
                if echo "$source_image" | grep -q ":"; then
                  image_name=$(echo "$source_image" | sed 's/:[^@]*$//')
                else
                  image_name="$source_image"
                fi
                # ä½¿ç”¨ digest å¤åˆ¶ç‰¹å®šæ¶æ„ï¼ˆæ·»åŠ è¶…æ—¶å¤„ç†ï¼‰
                echo "   Source: docker://${image_name}@${arm64_digest}"
                echo "   Target: docker://$temp_arm64"
                echo "   Starting copy with timeout (this may take a while for large images)..."
                
                # ä½¿ç”¨ timeout å‘½ä»¤è®¾ç½®è¶…æ—¶ï¼ˆ30åˆ†é’Ÿï¼‰
                if timeout 1800 skopeo copy \
                  --src-tls-verify=false \
                  --dest-tls-verify=false \
                  --retry-times 5 \
                  "docker://${image_name}@${arm64_digest}" \
                  "docker://$temp_arm64" 2>&1; then
                  arm64_copied=true
                  echo "âœ… arm64 version copied successfully (from multi-arch manifest)"
                else
                  copy_exit_code=$?
                  if [ $copy_exit_code -eq 124 ]; then
                    echo "â±ï¸  arm64 copy timed out after 30 minutes"
                  else
                    echo "âŒ arm64 copy failed with exit code: $copy_exit_code"
                  fi
                  arm64_copied=false
                fi
              else
                echo "âš ï¸  No arm64 architecture found in multi-arch manifest"
                arm64_copied=false
              fi
            fi
            
            # å¦‚æœä¸æ˜¯å¤šæ¶æ„é•œåƒæˆ–ä¸Šè¿°æ–¹æ³•å¤±è´¥ï¼Œå°è¯•ç›´æ¥å¤åˆ¶
            if [ "$arm64_copied" = "false" ]; then
              echo "ğŸ“¥ Attempting direct copy for arm64..."
              echo "   Source: docker://$source_image"
              echo "   Target: docker://$temp_arm64"
              
              # æ‰§è¡Œå¤åˆ¶å¹¶æ•è·é€€å‡ºç ï¼ˆæ·»åŠ è¶…æ—¶å¤„ç†ï¼‰
              echo "   Starting copy with timeout (this may take a while for large images)..."
              timeout 1800 skopeo copy \
                --src-tls-verify=false \
                --dest-tls-verify=false \
                --retry-times 5 \
                "docker://$source_image" \
                "docker://$temp_arm64" 2>&1
              copy_exit_code=$?
              
              echo "ğŸ“‹ Copy command exit code: $copy_exit_code"
              
              if [ $copy_exit_code -eq 124 ]; then
                echo "â±ï¸  Copy timed out after 30 minutes"
                arm64_copied=false
              elif [ $copy_exit_code -eq 0 ]; then
                echo "ğŸ“‹ Copy command completed successfully, verifying architecture..."
                # éªŒè¯æ¶æ„
                copied_arch=$(skopeo inspect "docker://$temp_arm64" 2>/dev/null | jq -r '.Architecture // "unknown"')
                echo "ğŸ“Š Detected architecture: $copied_arch"
                if [ "$copied_arch" = "arm64" ]; then
                  arm64_copied=true
                  echo "âœ… arm64 version copied successfully"
                else
                  echo "âš ï¸  Warning: Copied image architecture is $copied_arch, not arm64"
                  echo "âš ï¸  This might be a single-arch image. Continuing anyway..."
                  # å¯¹äºå•æ¶æ„é•œåƒï¼Œæˆ‘ä»¬ä»ç„¶ç»§ç»­ï¼Œä½†æ ‡è®°ä¸ºå·²å¤åˆ¶
                  arm64_copied=true
                fi
              else
                echo "âŒ Failed to copy arm64 version (exit code: $copy_exit_code)"
                echo "âš ï¸  Will continue with amd64 only if available"
                arm64_copied=false
              fi
            fi
            
            # æ£€æŸ¥å“ªäº›æ¶æ„æˆåŠŸå¤åˆ¶
            echo ""
            echo "=========================================="
            echo "ğŸ“Š Copy status summary:"
            echo "   amd64: $amd64_copied"
            echo "   arm64: $arm64_copied"
            echo "=========================================="
            echo ""
            
            # å¼ºåˆ¶æ£€æŸ¥ï¼šç¡®ä¿è‡³å°‘ amd64 å·²å¤åˆ¶ï¼ˆå› ä¸ºå®ƒæ˜¯å¿…éœ€çš„ï¼‰
            if [ "$amd64_copied" = "false" ]; then
              echo "âŒ CRITICAL: amd64 copy failed, cannot proceed"
              echo "âš ï¸  Checking if amd64 image exists at temporary location..."
              if skopeo inspect "docker://$temp_amd64" >/dev/null 2>&1; then
                echo "âœ… amd64 image exists at $temp_amd64, marking as copied"
                amd64_copied=true
              else
                echo "âŒ amd64 image does not exist, skipping this image"
                continue
              fi
            fi
            
            # å¦‚æœä¸¤ä¸ªæ¶æ„éƒ½æ²¡æœ‰æˆåŠŸï¼Œè·³è¿‡
            if [ "$amd64_copied" = "false" ] && [ "$arm64_copied" = "false" ]; then
              echo "âŒ Both architectures failed to copy, skipping..."
              continue
            fi
            
            # å¦‚æœåªæœ‰ä¸€ä¸ªæ¶æ„æˆåŠŸï¼Œç›´æ¥å¤åˆ¶åˆ°æœ€ç»ˆç›®æ ‡ï¼ˆä¸éœ€è¦ manifest listï¼‰
            if [ "$amd64_copied" = "true" ] && [ "$arm64_copied" = "false" ]; then
              echo "âš ï¸  Only amd64 architecture available, copying directly to final target..."
              echo "   Source: docker://$temp_amd64"
              echo "   Target: docker://$final_target"
              echo "   Current time: $(date)"
              
              echo "ğŸ“¤ Pushing amd64 image to final target..."
              if timeout 1800 skopeo copy \
                --src-tls-verify=false \
                --dest-tls-verify=false \
                --retry-times 5 \
                "docker://$temp_amd64" \
                "docker://$final_target" 2>&1; then
                echo "âœ… Single-arch (amd64) image pushed successfully: $final_target"
                
                # éªŒè¯æœ€ç»ˆé•œåƒ
                echo "ğŸ” Verifying final image..."
                if skopeo inspect "docker://$final_target" >/dev/null 2>&1; then
                  echo "âœ… Final image verified successfully"
                else
                  echo "âš ï¸  Warning: Final image verification failed"
                fi
                
                # æ¸…ç†ä¸´æ—¶æ ‡ç­¾
                skopeo delete "docker://$temp_amd64" 2>/dev/null || true
                continue
              else
                echo "âŒ Failed to copy single-arch image to final target"
                echo "âš ï¸  Temporary image still available at: $temp_amd64"
                continue
              fi
            fi
            
            if [ "$amd64_copied" = "false" ] && [ "$arm64_copied" = "true" ]; then
              echo "âš ï¸  Only arm64 architecture available, copying directly to final target..."
              echo "   Source: docker://$temp_arm64"
              echo "   Target: docker://$final_target"
              
              if skopeo copy \
                --src-tls-verify=false \
                --dest-tls-verify=false \
                --retry-times 5 \
                "docker://$temp_arm64" \
                "docker://$final_target"; then
                echo "âœ… Single-arch (arm64) image pushed successfully: $final_target"
                
                # éªŒè¯æœ€ç»ˆé•œåƒ
                echo "ğŸ” Verifying final image..."
                if skopeo inspect "docker://$final_target" >/dev/null 2>&1; then
                  echo "âœ… Final image verified successfully"
                else
                  echo "âš ï¸  Warning: Final image verification failed"
                fi
                
                # æ¸…ç†ä¸´æ—¶æ ‡ç­¾
                skopeo delete "docker://$temp_arm64" 2>/dev/null || true
                continue
              else
                echo "âŒ Failed to copy single-arch image to final target"
                echo "âš ï¸  Temporary image still available at: $temp_arm64"
                continue
              fi
            fi
            
            # å¦‚æœä¸¤ä¸ªæ¶æ„éƒ½æˆåŠŸï¼Œå…ˆå¤åˆ¶åˆ°æœ€ç»ˆç›®æ ‡çš„ä¸´æ—¶ digest æ ‡ç­¾ï¼Œç„¶ååˆ›å»º manifest list
            echo "ğŸ”— Creating multi-arch manifest for $final_target"
            
            # æå– registry ä¿¡æ¯
            registry_host=$(echo "$final_target" | sed 's|/.*||')
            image_path=$(echo "$final_target" | sed "s|^${registry_host}/||" | sed 's|:.*||')
            image_tag=$(echo "$final_target" | sed 's|.*:||')
            
            # è·å–ä¸¤ä¸ªæ¶æ„çš„ manifest digestï¼ˆä»ä¸´æ—¶æ ‡ç­¾ï¼‰
            echo "ğŸ“‹ Getting manifest digests from temporary images..."
            amd64_inspect=$(skopeo inspect "docker://$temp_amd64" 2>/dev/null)
            arm64_inspect=$(skopeo inspect "docker://$temp_arm64" 2>/dev/null)
            
            if [ -z "$amd64_inspect" ] || [ -z "$arm64_inspect" ]; then
              echo "âŒ Failed to get manifest information"
              continue
            fi
            
            amd64_digest=$(echo "$amd64_inspect" | jq -r '.Digest')
            arm64_digest=$(echo "$arm64_inspect" | jq -r '.Digest')
            
            # éªŒè¯ digest æ ¼å¼
            if [ -z "$amd64_digest" ] || [ "$amd64_digest" = "null" ] || ! echo "$amd64_digest" | grep -q "^sha256:"; then
              echo "âŒ Invalid amd64 digest: $amd64_digest"
              continue
            fi
            if [ -z "$arm64_digest" ] || [ "$arm64_digest" = "null" ] || ! echo "$arm64_digest" | grep -q "^sha256:"; then
              echo "âŒ Invalid arm64 digest: $arm64_digest"
              continue
            fi
            
            echo "ğŸ“Š Manifest digests:"
            echo "   amd64: $amd64_digest"
            echo "   arm64: $arm64_digest"
            
            # åˆ›å»ºæœ€ç»ˆç›®æ ‡çš„ä¸´æ—¶ digest æ ‡ç­¾ï¼ˆç”¨äº manifest list å¼•ç”¨ï¼‰
            final_amd64_digest_tag="${final_target%:*}-amd64-digest-${amd64_digest#sha256:}"
            final_arm64_digest_tag="${final_target%:*}-arm64-digest-${arm64_digest#sha256:}"
            
            # å¤åˆ¶åˆ°æœ€ç»ˆç›®æ ‡çš„ä¸´æ—¶ digest æ ‡ç­¾ï¼ˆç¡®ä¿ manifest å’Œ blob éƒ½åœ¨æœ€ç»ˆ repository ä¸­ï¼‰
            echo "ğŸ“¥ Copying amd64 to final repository..."
            if ! timeout 1800 skopeo copy \
              --src-tls-verify=false \
              --dest-tls-verify=false \
              --retry-times 5 \
              "docker://$temp_amd64" \
              "docker://$final_amd64_digest_tag" 2>&1; then
              echo "âŒ Failed to copy amd64 to final repository"
              continue
            fi
            
            echo "ğŸ“¥ Copying arm64 to final repository..."
            if ! timeout 1800 skopeo copy \
              --src-tls-verify=false \
              --dest-tls-verify=false \
              --retry-times 5 \
              "docker://$temp_arm64" \
              "docker://$final_arm64_digest_tag" 2>&1; then
              echo "âŒ Failed to copy arm64 to final repository"
              continue
            fi
            
            # é‡æ–°è·å– digestï¼ˆä»æœ€ç»ˆ repository ä¸­çš„é•œåƒï¼‰
            echo "ğŸ“‹ Getting digests from final repository..."
            final_amd64_inspect=$(skopeo inspect "docker://$final_amd64_digest_tag" 2>/dev/null)
            final_arm64_inspect=$(skopeo inspect "docker://$final_arm64_digest_tag" 2>/dev/null)
            
            if [ -z "$final_amd64_inspect" ] || [ -z "$final_arm64_inspect" ]; then
              echo "âŒ Failed to inspect images in final repository"
              continue
            fi
            
            final_amd64_digest=$(echo "$final_amd64_inspect" | jq -r '.Digest')
            final_arm64_digest=$(echo "$final_arm64_inspect" | jq -r '.Digest')
            final_amd64_manifest=$(skopeo inspect --raw "docker://$final_amd64_digest_tag" 2>/dev/null)
            final_arm64_manifest=$(skopeo inspect --raw "docker://$final_arm64_digest_tag" 2>/dev/null)
            final_amd64_size=$(echo -n "$final_amd64_manifest" | wc -c)
            final_arm64_size=$(echo -n "$final_arm64_manifest" | wc -c)
            
            echo "ğŸ“Š Final repository digests:"
            echo "   amd64: $final_amd64_digest (size: $final_amd64_size bytes)"
            echo "   arm64: $final_arm64_digest (size: $final_arm64_size bytes)"
            
            # åˆ›å»º manifest list
            manifest_list=$(jq -n \
              --arg amd64_digest "$final_amd64_digest" \
              --arg arm64_digest "$final_arm64_digest" \
              --argjson amd64_size "$final_amd64_size" \
              --argjson arm64_size "$final_arm64_size" \
              '{
                "schemaVersion": 2,
                "mediaType": "application/vnd.docker.distribution.manifest.list.v2+json",
                "manifests": [
                  {
                    "mediaType": "application/vnd.docker.distribution.manifest.v2+json",
                    "size": $amd64_size,
                    "digest": $amd64_digest,
                    "platform": {
                      "architecture": "amd64",
                      "os": "linux"
                    }
                  },
                  {
                    "mediaType": "application/vnd.docker.distribution.manifest.v2+json",
                    "size": $arm64_size,
                    "digest": $arm64_digest,
                    "platform": {
                      "architecture": "arm64",
                      "os": "linux"
                    }
                  }
                ]
              }')
            
            # ä¿å­˜ manifest list åˆ°ä¸´æ—¶æ–‡ä»¶
            echo "$manifest_list" > /tmp/manifest-list.json
            
            # è·å–è®¤è¯ token
            echo "ğŸ” Getting authentication token..."
            token=""
            auth_response=$(curl -s -u "${{ secrets.ALIYUN_USERNAME }}:${{ secrets.ALIYUN_PASSWORD }}" \
              "https://${registry_host}/v2/token?service=${registry_host}&scope=repository:${image_path}:pull,push" 2>/dev/null)
            
            if [ -n "$auth_response" ] && echo "$auth_response" | jq -e '.token' >/dev/null 2>&1; then
              token=$(echo "$auth_response" | jq -r '.token')
            else
              # å°è¯•æ ‡å‡† Docker registry è®¤è¯
              auth_url="https://${registry_host}/v2/"
              www_auth=$(curl -s -I "$auth_url" 2>/dev/null | grep -i "www-authenticate" | cut -d' ' -f2-)
              if [ -n "$www_auth" ]; then
                realm=$(echo "$www_auth" | grep -oP 'realm="[^"]+"' | cut -d'"' -f2)
                service=$(echo "$www_auth" | grep -oP 'service="[^"]+"' | cut -d'"' -f2)
                scope="repository:${image_path}:pull,push"
                
                if [ -n "$realm" ] && [ -n "$service" ]; then
                  token_url="${realm}?service=${service}&scope=${scope}"
                  auth_response=$(curl -s -u "${{ secrets.ALIYUN_USERNAME }}:${{ secrets.ALIYUN_PASSWORD }}" "$token_url" 2>/dev/null)
                  if echo "$auth_response" | jq -e '.token' >/dev/null 2>&1; then
                    token=$(echo "$auth_response" | jq -r '.token')
                  fi
                fi
              fi
            fi
            
            # æ¨é€ manifest list
            manifest_created=false
            if [ -n "$token" ] && [ "$token" != "null" ]; then
              echo "ğŸ“¤ Pushing multi-arch manifest list..."
              put_url="https://${registry_host}/v2/${image_path}/manifests/${image_tag}"
              
              http_response=$(curl -s -X PUT "$put_url" \
                -H "Authorization: Bearer $token" \
                -H "Content-Type: application/vnd.docker.distribution.manifest.list.v2+json" \
                --data-binary @/tmp/manifest-list.json \
                -w "\nHTTP_STATUS:%{http_code}")
              
              http_code=$(echo "$http_response" | grep -oP 'HTTP_STATUS:\K\d+')
              
              if [ "$http_code" = "201" ] || [ "$http_code" = "200" ]; then
                echo "âœ… Multi-arch manifest created successfully: $final_target"
                manifest_created=true
                
                # éªŒè¯ manifest list
                echo "ğŸ” Verifying manifest list..."
                sleep 3
                if skopeo inspect "docker://$final_target" >/dev/null 2>&1; then
                  final_info=$(skopeo inspect "docker://$final_target" 2>/dev/null)
                  echo "âœ… Manifest list verified successfully"
                  echo "ğŸ“Š Final image info:"
                  echo "$final_info" | jq -r '.Architecture // "multi-arch", .Digest'
                else
                  echo "âš ï¸  Warning: Manifest list verification failed"
                fi
              else
                echo "âŒ Failed to push manifest list via API (HTTP $http_code)"
                echo "   Response: $(echo "$http_response" | head -n -1)"
              fi
            else
              echo "âš ï¸  Could not obtain authentication token"
            fi
            
            # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            rm -f /tmp/manifest-list.json
            
            # æ¸…ç†ä¸´æ—¶æ ‡ç­¾
            echo "ğŸ§¹ Cleaning up temporary tags..."
            skopeo delete "docker://$temp_amd64" 2>/dev/null || true
            skopeo delete "docker://$temp_arm64" 2>/dev/null || true
            skopeo delete "docker://$final_amd64_digest_tag" 2>/dev/null || true
            skopeo delete "docker://$final_arm64_digest_tag" 2>/dev/null || true
            
            if [ "$manifest_created" = "true" ]; then
              echo "âœ… Multi-arch manifest list created successfully"
            else
              echo "âš ï¸  Manifest list creation failed, but images are available at:"
              echo "   - $final_amd64_digest_tag"
              echo "   - $final_arm64_digest_tag"
            fi
          done
        done

    - name: Summary
      if: always()
      run: |
        echo "ğŸ Processing completed"
        echo "=== Final disk space ==="
        df -h
