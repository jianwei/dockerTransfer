name: Sync skopeo

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *'

jobs:
  sync-images:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Setup and install dependencies
      run: |
        echo "=== Initial disk space ==="
        df -h
        
        # å®‰è£…å¿…è¦å·¥å…·
        sudo apt-get update
        sudo apt-get install -y skopeo jq wget
        
        # å®‰è£… manifest-tool ç”¨äºåˆ›å»ºå¤šæ¶æ„ manifest
        echo "ğŸ“¥ Downloading manifest-tool..."
        # å°è¯•å¤šä¸ªå¯èƒ½çš„ä¸‹è½½é“¾æ¥
        MANIFEST_TOOL_URL="https://github.com/estesp/manifest-tool/releases/download/v2.0.8/manifest-tool-linux-amd64"
        echo "Download URL: $MANIFEST_TOOL_URL"
        if ! wget --timeout=30 --tries=3 "$MANIFEST_TOOL_URL" -O /tmp/manifest-tool; then
          echo "âŒ wget failed, trying with curl..."
          # å°è¯•ä½¿ç”¨ curl ä½œä¸ºå¤‡é€‰
          if command -v curl >/dev/null 2>&1; then
            if ! curl -L -f -o /tmp/manifest-tool "$MANIFEST_TOOL_URL"; then
              echo "âŒ Failed to download manifest-tool with curl"
              exit 1
            fi
          else
            echo "âŒ Neither wget nor curl available"
            exit 1
          fi
        fi
        
        # éªŒè¯æ–‡ä»¶æ˜¯å¦ä¸‹è½½æˆåŠŸ
        if [ ! -f /tmp/manifest-tool ] || [ ! -s /tmp/manifest-tool ]; then
          echo "âŒ Downloaded file is empty or missing"
          exit 1
        fi
        
        chmod +x /tmp/manifest-tool
        sudo mv /tmp/manifest-tool /usr/local/bin/manifest-tool
        
        # éªŒè¯å®‰è£…
        if command -v manifest-tool >/dev/null 2>&1; then
          echo "âœ… manifest-tool installed successfully"
          manifest-tool --version 2>&1 || echo "âš ï¸  manifest-tool version check failed (but binary exists)"
        else
          echo "âŒ manifest-tool not found in PATH after installation"
          exit 1
        fi
        
        # æ¸…ç†ç©ºé—´
        echo "ğŸ§¹ Cleaning up disk space..."
        sudo docker system prune -af || true
        
        echo "=== Disk space after cleanup ==="
        df -h

    - name: Login to Alibaba Cloud Container Registry
      run: |
        skopeo login \
          --username "${{ secrets.ALIYUN_USERNAME }}" \
          --password "${{ secrets.ALIYUN_PASSWORD }}" \
          registry.cn-hangzhou.aliyuncs.com

    - name: Process images
      run: |
        echo "=== Starting image processing ==="
        
        # Read the JSON file directly in the shell
        count=$(jq 'length' images.json)
        echo "Found $count images to process"
        
        # Simple loop with proper error handling
        for i in $(seq 0 $((count-1))); do
          echo "=== Processing image $((i+1)) ==="
          
          # Extract values one by one with error checking
          source=$(jq -r ".[$i].source" images.json)
          target=$(jq -r ".[$i].target" images.json)
          tag_count=$(jq ".[$i].tags | length" images.json)
          
          echo "Source: $source"
          echo "Target: $target"
          echo "Tag count: $tag_count"
          
          if [ "$source" = "null" ] || [ "$target" = "null" ]; then
            echo "âŒ Invalid data at index $i"
            continue
          fi
          
          # Process tags - create multi-arch manifest
          for j in $(seq 0 $((tag_count-1))); do
            tag=$(jq -r ".[$i].tags[$j]" images.json)
            echo "ğŸ·ï¸  Processing tag: $tag"
            
            # æ„å»ºæœ€ç»ˆç›®æ ‡é•œåƒåç§°
            final_target="registry.cn-hangzhou.aliyuncs.com/${{ secrets.ALIYUN_NAMESPACE }}/${target}:${tag}"
            
            # ä¸´æ—¶é•œåƒæ ‡ç­¾ï¼Œç”¨äºæ„å»ºå¤šæ¶æ„ manifest
            temp_amd64="registry.cn-hangzhou.aliyuncs.com/${{ secrets.ALIYUN_NAMESPACE }}/${target}:${tag}-amd64-temp"
            temp_arm64="registry.cn-hangzhou.aliyuncs.com/${{ secrets.ALIYUN_NAMESPACE }}/${target}:${tag}-arm64-temp"
            
            # ç¡®å®šæºé•œåƒåç§°ï¼šå¦‚æœ source å·²åŒ…å«æ ‡ç­¾åˆ™ç›´æ¥ä½¿ç”¨ï¼Œå¦åˆ™æ·»åŠ  tag
            if echo "$source" | grep -q ":"; then
              source_image="$source"
            else
              source_image="${source}:${tag}"
            fi
            
            # æ£€æŸ¥æºé•œåƒçš„ manifestï¼Œåˆ¤æ–­æ˜¯å¦æ˜¯å¤šæ¶æ„é•œåƒ
            source_manifest=$(skopeo inspect --raw "docker://$source_image" 2>/dev/null || echo "")
            
            # ä½¿ç”¨ skopeo å¤åˆ¶ amd64 ç‰ˆæœ¬åˆ°ä¸´æ—¶æ ‡ç­¾
            echo "ğŸ“¥ Copying $source_image for amd64..."
            amd64_copied=false
            
            # æ£€æŸ¥æ˜¯å¦æ˜¯å¤šæ¶æ„é•œåƒ
            if echo "$source_manifest" | jq -e '.manifests' > /dev/null 2>&1; then
              # æ˜¯å¤šæ¶æ„é•œåƒï¼Œè·å– amd64 æ¶æ„çš„ digest
              amd64_digest=$(echo "$source_manifest" | jq -r '.manifests[] | select(.platform.architecture == "amd64" and .platform.os == "linux") | .digest' | head -n1)
              if [ -n "$amd64_digest" ] && [ "$amd64_digest" != "null" ]; then
                # æå–é•œåƒåç§°ï¼ˆå»æ‰æ ‡ç­¾ï¼Œä¿ç•™ä»“åº“åœ°å€ï¼‰
                # å¦‚æœ source_image åŒ…å«æ ‡ç­¾ï¼Œå»æ‰æ ‡ç­¾éƒ¨åˆ†
                if echo "$source_image" | grep -q ":"; then
                  image_name=$(echo "$source_image" | sed 's/:[^@]*$//')
                else
                  image_name="$source_image"
                fi
                # ä½¿ç”¨ digest å¤åˆ¶ç‰¹å®šæ¶æ„
                if skopeo copy \
                  --src-tls-verify=false \
                  --dest-tls-verify=false \
                  --retry-times 5 \
                  "docker://${image_name}@${amd64_digest}" \
                  "docker://$temp_amd64"; then
                  amd64_copied=true
                  echo "âœ… amd64 version copied successfully (from multi-arch manifest)"
                fi
              fi
            fi
            
            # å¦‚æœä¸æ˜¯å¤šæ¶æ„é•œåƒæˆ–ä¸Šè¿°æ–¹æ³•å¤±è´¥ï¼Œå°è¯•ç›´æ¥å¤åˆ¶
            if [ "$amd64_copied" = "false" ]; then
              if skopeo copy \
                --src-tls-verify=false \
                --dest-tls-verify=false \
                --retry-times 5 \
                "docker://$source_image" \
                "docker://$temp_amd64"; then
                # éªŒè¯æ¶æ„
                copied_arch=$(skopeo inspect "docker://$temp_amd64" | jq -r '.Architecture // "unknown"')
                if [ "$copied_arch" = "amd64" ]; then
                  amd64_copied=true
                  echo "âœ… amd64 version copied successfully"
                else
                  echo "âš ï¸  Warning: Copied image architecture is $copied_arch, not amd64"
                  echo "âŒ Failed to copy amd64 version"
                  continue
                fi
              else
                echo "âŒ Failed to copy amd64 version"
                continue
              fi
            fi
            
            # ä½¿ç”¨ skopeo å¤åˆ¶ arm64 ç‰ˆæœ¬åˆ°ä¸´æ—¶æ ‡ç­¾
            echo "ğŸ“¥ Copying $source_image for arm64..."
            arm64_copied=false
            
            # æ£€æŸ¥æ˜¯å¦æ˜¯å¤šæ¶æ„é•œåƒ
            if echo "$source_manifest" | jq -e '.manifests' > /dev/null 2>&1; then
              # æ˜¯å¤šæ¶æ„é•œåƒï¼Œè·å– arm64 æ¶æ„çš„ digest
              arm64_digest=$(echo "$source_manifest" | jq -r '.manifests[] | select(.platform.architecture == "arm64" and .platform.os == "linux") | .digest' | head -n1)
              if [ -n "$arm64_digest" ] && [ "$arm64_digest" != "null" ]; then
                # æå–é•œåƒåç§°ï¼ˆå»æ‰æ ‡ç­¾ï¼Œä¿ç•™ä»“åº“åœ°å€ï¼‰
                # å¦‚æœ source_image åŒ…å«æ ‡ç­¾ï¼Œå»æ‰æ ‡ç­¾éƒ¨åˆ†
                if echo "$source_image" | grep -q ":"; then
                  image_name=$(echo "$source_image" | sed 's/:[^@]*$//')
                else
                  image_name="$source_image"
                fi
                # ä½¿ç”¨ digest å¤åˆ¶ç‰¹å®šæ¶æ„
                if skopeo copy \
                  --src-tls-verify=false \
                  --dest-tls-verify=false \
                  --retry-times 5 \
                  "docker://${image_name}@${arm64_digest}" \
                  "docker://$temp_arm64"; then
                  arm64_copied=true
                  echo "âœ… arm64 version copied successfully (from multi-arch manifest)"
                fi
              fi
            fi
            
            # å¦‚æœä¸æ˜¯å¤šæ¶æ„é•œåƒæˆ–ä¸Šè¿°æ–¹æ³•å¤±è´¥ï¼Œå°è¯•ç›´æ¥å¤åˆ¶
            if [ "$arm64_copied" = "false" ]; then
              if skopeo copy \
                --src-tls-verify=false \
                --dest-tls-verify=false \
                --retry-times 5 \
                "docker://$source_image" \
                "docker://$temp_arm64"; then
                # éªŒè¯æ¶æ„
                copied_arch=$(skopeo inspect "docker://$temp_arm64" | jq -r '.Architecture // "unknown"')
                if [ "$copied_arch" = "arm64" ]; then
                  arm64_copied=true
                  echo "âœ… arm64 version copied successfully"
                else
                  echo "âš ï¸  Warning: Copied image architecture is $copied_arch, not arm64"
                  echo "âŒ Failed to copy arm64 version"
                  continue
                fi
              else
                echo "âŒ Failed to copy arm64 version"
                continue
              fi
            fi
            
            # ä½¿ç”¨ manifest-tool åˆ›å»ºå¤šæ¶æ„ manifest
            echo "ğŸ”— Creating multi-arch manifest for $final_target"
            
            # åˆ›å»º manifest-tool é…ç½®æ–‡ä»¶ï¼ˆä½¿ç”¨ echo é€è¡Œå†™å…¥ï¼Œé¿å… heredoc é—®é¢˜ï¼‰
            {
              echo "image: $final_target"
              echo "manifests:"
              echo "  - image: $temp_amd64"
              echo "    platform:"
              echo "      architecture: amd64"
              echo "      os: linux"
              echo "  - image: $temp_arm64"
              echo "    platform:"
              echo "      architecture: arm64"
              echo "      os: linux"
            } > /tmp/manifest.yaml
            
            # ä½¿ç”¨ manifest-tool æ¨é€å¤šæ¶æ„ manifest
            # manifest-tool ä¼šä½¿ç”¨ skopeo login è®¾ç½®çš„è®¤è¯ä¿¡æ¯
            if manifest-tool push from-spec /tmp/manifest.yaml \
              --username "${{ secrets.ALIYUN_USERNAME }}" \
              --password "${{ secrets.ALIYUN_PASSWORD }}"; then
              echo "âœ… Multi-arch manifest created successfully: $final_target"
            else
              echo "âŒ Failed to create multi-arch manifest"
              continue
            fi
            
            # æ¸…ç†ä¸´æ—¶é…ç½®æ–‡ä»¶
            rm -f /tmp/manifest.yaml
            
            # æ¸…ç†ä¸´æ—¶é•œåƒæ ‡ç­¾ï¼ˆå¯é€‰ï¼Œä¿ç•™å®ƒä»¬ä¹Ÿä¸å½±å“ä½¿ç”¨ï¼‰
            echo "ğŸ§¹ Cleaning up temporary tags..."
            skopeo delete "docker://$temp_amd64" 2>/dev/null || true
            skopeo delete "docker://$temp_arm64" 2>/dev/null || true
          done
        done

    - name: Summary
      if: always()
      run: |
        echo "ğŸ Processing completed"
        echo "=== Final disk space ==="
        df -h
