name: Sync skopeo

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *'

jobs:
  sync-images:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Setup and install dependencies
      run: |
        echo "=== Initial disk space ==="
        df -h
        
        # å®‰è£…å¿…è¦å·¥å…·
        sudo apt-get update
        sudo apt-get install -y skopeo jq wget curl
        
        # æ³¨æ„ï¼šä½¿ç”¨ skopeo æœ¬èº«æ¥åˆ›å»ºå¤šæ¶æ„ manifestï¼Œä¸éœ€è¦ manifest-tool
        
        # æ¸…ç†ç©ºé—´
        echo "ğŸ§¹ Cleaning up disk space..."
        sudo docker system prune -af || true
        
        echo "=== Disk space after cleanup ==="
        df -h

    - name: Login to Alibaba Cloud Container Registry
      run: |
        skopeo login \
          --username "${{ secrets.ALIYUN_USERNAME }}" \
          --password "${{ secrets.ALIYUN_PASSWORD }}" \
          registry.cn-hangzhou.aliyuncs.com

    - name: Process images
      run: |
        echo "=== Starting image processing ==="
        
        # Read the JSON file directly in the shell
        count=$(jq 'length' images.json)
        echo "Found $count images to process"
        
        # Simple loop with proper error handling
        for i in $(seq 0 $((count-1))); do
          echo "=== Processing image $((i+1)) ==="
          
          # Extract values one by one with error checking
          source=$(jq -r ".[$i].source" images.json)
          target=$(jq -r ".[$i].target" images.json)
          tag_count=$(jq ".[$i].tags | length" images.json)
          
          echo "Source: $source"
          echo "Target: $target"
          echo "Tag count: $tag_count"
          
          if [ "$source" = "null" ] || [ "$target" = "null" ]; then
            echo "âŒ Invalid data at index $i"
            continue
          fi
          
          # Process tags - create multi-arch manifest
          for j in $(seq 0 $((tag_count-1))); do
            tag=$(jq -r ".[$i].tags[$j]" images.json)
            echo "ğŸ·ï¸  Processing tag: $tag"
            
            # æ„å»ºæœ€ç»ˆç›®æ ‡é•œåƒåç§°
            final_target="registry.cn-hangzhou.aliyuncs.com/${{ secrets.ALIYUN_NAMESPACE }}/${target}:${tag}"
            
            # ä¸´æ—¶é•œåƒæ ‡ç­¾ï¼Œç”¨äºæ„å»ºå¤šæ¶æ„ manifest
            temp_amd64="registry.cn-hangzhou.aliyuncs.com/${{ secrets.ALIYUN_NAMESPACE }}/${target}:${tag}-amd64-temp"
            temp_arm64="registry.cn-hangzhou.aliyuncs.com/${{ secrets.ALIYUN_NAMESPACE }}/${target}:${tag}-arm64-temp"
            
            # ç¡®å®šæºé•œåƒåç§°ï¼šå¦‚æœ source å·²åŒ…å«æ ‡ç­¾åˆ™ç›´æ¥ä½¿ç”¨ï¼Œå¦åˆ™æ·»åŠ  tag
            if echo "$source" | grep -q ":"; then
              source_image="$source"
            else
              source_image="${source}:${tag}"
            fi
            
            # æ£€æŸ¥æºé•œåƒçš„ manifestï¼Œåˆ¤æ–­æ˜¯å¦æ˜¯å¤šæ¶æ„é•œåƒ
            source_manifest=$(skopeo inspect --raw "docker://$source_image" 2>/dev/null || echo "")
            
            # ä½¿ç”¨ skopeo å¤åˆ¶ amd64 ç‰ˆæœ¬åˆ°ä¸´æ—¶æ ‡ç­¾
            echo "ğŸ“¥ Copying $source_image for amd64..."
            amd64_copied=false
            
            # æ£€æŸ¥æ˜¯å¦æ˜¯å¤šæ¶æ„é•œåƒ
            if echo "$source_manifest" | jq -e '.manifests' > /dev/null 2>&1; then
              # æ˜¯å¤šæ¶æ„é•œåƒï¼Œè·å– amd64 æ¶æ„çš„ digest
              amd64_digest=$(echo "$source_manifest" | jq -r '.manifests[] | select(.platform.architecture == "amd64" and .platform.os == "linux") | .digest' | head -n1)
              if [ -n "$amd64_digest" ] && [ "$amd64_digest" != "null" ]; then
                # æå–é•œåƒåç§°ï¼ˆå»æ‰æ ‡ç­¾ï¼Œä¿ç•™ä»“åº“åœ°å€ï¼‰
                # å¦‚æœ source_image åŒ…å«æ ‡ç­¾ï¼Œå»æ‰æ ‡ç­¾éƒ¨åˆ†
                if echo "$source_image" | grep -q ":"; then
                  image_name=$(echo "$source_image" | sed 's/:[^@]*$//')
                else
                  image_name="$source_image"
                fi
                # ä½¿ç”¨ digest å¤åˆ¶ç‰¹å®šæ¶æ„
                if skopeo copy \
                  --src-tls-verify=false \
                  --dest-tls-verify=false \
                  --retry-times 5 \
                  "docker://${image_name}@${amd64_digest}" \
                  "docker://$temp_amd64"; then
                  amd64_copied=true
                  echo "âœ… amd64 version copied successfully (from multi-arch manifest)"
                fi
              fi
            fi
            
            # å¦‚æœä¸æ˜¯å¤šæ¶æ„é•œåƒæˆ–ä¸Šè¿°æ–¹æ³•å¤±è´¥ï¼Œå°è¯•ç›´æ¥å¤åˆ¶
            if [ "$amd64_copied" = "false" ]; then
              if skopeo copy \
                --src-tls-verify=false \
                --dest-tls-verify=false \
                --retry-times 5 \
                "docker://$source_image" \
                "docker://$temp_amd64"; then
                # éªŒè¯æ¶æ„
                copied_arch=$(skopeo inspect "docker://$temp_amd64" | jq -r '.Architecture // "unknown"')
                if [ "$copied_arch" = "amd64" ]; then
                  amd64_copied=true
                  echo "âœ… amd64 version copied successfully"
                else
                  echo "âš ï¸  Warning: Copied image architecture is $copied_arch, not amd64"
                  echo "âŒ Failed to copy amd64 version"
                  continue
                fi
              else
                echo "âŒ Failed to copy amd64 version"
                continue
              fi
            fi
            
            # ä½¿ç”¨ skopeo å¤åˆ¶ arm64 ç‰ˆæœ¬åˆ°ä¸´æ—¶æ ‡ç­¾
            echo "ğŸ“¥ Copying $source_image for arm64..."
            arm64_copied=false
            
            # æ£€æŸ¥æ˜¯å¦æ˜¯å¤šæ¶æ„é•œåƒ
            if echo "$source_manifest" | jq -e '.manifests' > /dev/null 2>&1; then
              # æ˜¯å¤šæ¶æ„é•œåƒï¼Œè·å– arm64 æ¶æ„çš„ digest
              arm64_digest=$(echo "$source_manifest" | jq -r '.manifests[] | select(.platform.architecture == "arm64" and .platform.os == "linux") | .digest' | head -n1)
              if [ -n "$arm64_digest" ] && [ "$arm64_digest" != "null" ]; then
                # æå–é•œåƒåç§°ï¼ˆå»æ‰æ ‡ç­¾ï¼Œä¿ç•™ä»“åº“åœ°å€ï¼‰
                # å¦‚æœ source_image åŒ…å«æ ‡ç­¾ï¼Œå»æ‰æ ‡ç­¾éƒ¨åˆ†
                if echo "$source_image" | grep -q ":"; then
                  image_name=$(echo "$source_image" | sed 's/:[^@]*$//')
                else
                  image_name="$source_image"
                fi
                # ä½¿ç”¨ digest å¤åˆ¶ç‰¹å®šæ¶æ„
                if skopeo copy \
                  --src-tls-verify=false \
                  --dest-tls-verify=false \
                  --retry-times 5 \
                  "docker://${image_name}@${arm64_digest}" \
                  "docker://$temp_arm64"; then
                  arm64_copied=true
                  echo "âœ… arm64 version copied successfully (from multi-arch manifest)"
                fi
              fi
            fi
            
            # å¦‚æœä¸æ˜¯å¤šæ¶æ„é•œåƒæˆ–ä¸Šè¿°æ–¹æ³•å¤±è´¥ï¼Œå°è¯•ç›´æ¥å¤åˆ¶
            if [ "$arm64_copied" = "false" ]; then
              if skopeo copy \
                --src-tls-verify=false \
                --dest-tls-verify=false \
                --retry-times 5 \
                "docker://$source_image" \
                "docker://$temp_arm64"; then
                # éªŒè¯æ¶æ„
                copied_arch=$(skopeo inspect "docker://$temp_arm64" | jq -r '.Architecture // "unknown"')
                if [ "$copied_arch" = "arm64" ]; then
                  arm64_copied=true
                  echo "âœ… arm64 version copied successfully"
                else
                  echo "âš ï¸  Warning: Copied image architecture is $copied_arch, not arm64"
                  echo "âŒ Failed to copy arm64 version"
                  continue
                fi
              else
                echo "âŒ Failed to copy arm64 version"
                continue
              fi
            fi
            
            # ä½¿ç”¨ skopeo åˆ›å»ºå¤šæ¶æ„ manifest
            echo "ğŸ”— Creating multi-arch manifest for $final_target"
            
            # è·å–ä¸¤ä¸ªæ¶æ„çš„ manifest digest
            amd64_digest=$(skopeo inspect "docker://$temp_amd64" | jq -r '.Digest')
            arm64_digest=$(skopeo inspect "docker://$temp_arm64" | jq -r '.Digest')
            
            # è·å–ä¸¤ä¸ªæ¶æ„çš„ manifest è¯¦ç»†ä¿¡æ¯
            amd64_manifest=$(skopeo inspect --raw "docker://$temp_amd64")
            arm64_manifest=$(skopeo inspect --raw "docker://$temp_arm64")
            
            # è®¡ç®— manifest å¤§å°
            amd64_size=$(echo "$amd64_manifest" | jq -r '.config.size + ([.layers[].size] | add)')
            arm64_size=$(echo "$arm64_manifest" | jq -r '.config.size + ([.layers[].size] | add)')
            
            # åˆ›å»º manifest list
            manifest_list=$(jq -n \
              --arg amd64_digest "$amd64_digest" \
              --arg arm64_digest "$arm64_digest" \
              --argjson amd64_size "$amd64_size" \
              --argjson arm64_size "$arm64_size" \
              '{
                "schemaVersion": 2,
                "mediaType": "application/vnd.docker.distribution.manifest.list.v2+json",
                "manifests": [
                  {
                    "mediaType": "application/vnd.docker.distribution.manifest.v2+json",
                    "size": $amd64_size,
                    "digest": $amd64_digest,
                    "platform": {
                      "architecture": "amd64",
                      "os": "linux"
                    }
                  },
                  {
                    "mediaType": "application/vnd.docker.distribution.manifest.v2+json",
                    "size": $arm64_size,
                    "digest": $arm64_digest,
                    "platform": {
                      "architecture": "arm64",
                      "os": "linux"
                    }
                  }
                ]
              }')
            
            # å°† manifest list ä¿å­˜åˆ°ä¸´æ—¶æ–‡ä»¶
            echo "$manifest_list" > /tmp/manifest-list.json
            
            # ä½¿ç”¨ Docker Registry API æ¨é€ manifest list
            # æå– registry å’Œé•œåƒè·¯å¾„
            registry_host=$(echo "$final_target" | sed 's|/.*||')
            image_path=$(echo "$final_target" | sed "s|^${registry_host}/||" | sed 's|:.*||')
            image_tag=$(echo "$final_target" | sed 's|.*:||')
            
            # è·å–è®¤è¯ tokenï¼ˆä½¿ç”¨ skopeo çš„è®¤è¯ä¿¡æ¯ï¼‰
            echo "ğŸ” Getting authentication token..."
            auth_response=$(curl -s -u "${{ secrets.ALIYUN_USERNAME }}:${{ secrets.ALIYUN_PASSWORD }}" \
              "https://${registry_host}/v2/token?service=${registry_host}&scope=repository:${image_path}:pull,push")
            
            # å¦‚æœä¸Šé¢çš„ API ä¸å­˜åœ¨ï¼Œå°è¯•ä½¿ç”¨æ ‡å‡†çš„ Docker registry è®¤è¯
            # å¤§å¤šæ•° registry ä½¿ç”¨ /v2/ ç«¯ç‚¹
            token=""
            if [ -n "$auth_response" ] && echo "$auth_response" | jq -e '.token' >/dev/null 2>&1; then
              token=$(echo "$auth_response" | jq -r '.token')
            else
              # å°è¯•æ ‡å‡† Docker registry è®¤è¯æµç¨‹
              auth_url="https://${registry_host}/v2/"
              www_auth=$(curl -s -I "$auth_url" | grep -i "www-authenticate" | cut -d' ' -f2-)
              if [ -n "$www_auth" ]; then
                # è§£æ WWW-Authenticate header è·å–è®¤è¯æœåŠ¡
                realm=$(echo "$www_auth" | grep -oP 'realm="[^"]+"' | cut -d'"' -f2)
                service=$(echo "$www_auth" | grep -oP 'service="[^"]+"' | cut -d'"' -f2)
                scope="repository:${image_path}:pull,push"
                
                if [ -n "$realm" ] && [ -n "$service" ]; then
                  token_url="${realm}?service=${service}&scope=${scope}"
                  auth_response=$(curl -s -u "${{ secrets.ALIYUN_USERNAME }}:${{ secrets.ALIYUN_PASSWORD }}" "$token_url")
                  if echo "$auth_response" | jq -e '.token' >/dev/null 2>&1; then
                    token=$(echo "$auth_response" | jq -r '.token')
                  fi
                fi
              fi
            fi
            
            # å¦‚æœè·å–åˆ° tokenï¼Œæ¨é€ manifest list
            if [ -n "$token" ] && [ "$token" != "null" ]; then
              echo "ğŸ“¤ Pushing multi-arch manifest list..."
              manifest_size=$(echo "$manifest_list" | wc -c)
              put_url="https://${registry_host}/v2/${image_path}/manifests/${image_tag}"
              
              if curl -s -X PUT "$put_url" \
                -H "Authorization: Bearer $token" \
                -H "Content-Type: application/vnd.docker.distribution.manifest.list.v2+json" \
                -H "Content-Length: $manifest_size" \
                --data-binary @/tmp/manifest-list.json \
                -w "\nHTTP Status: %{http_code}\n" | grep -q "HTTP Status: 201\|HTTP Status: 200"; then
                echo "âœ… Multi-arch manifest created successfully: $final_target"
              else
                echo "âš ï¸  Failed to push manifest list via API, but individual images are available"
                echo "   You may need to use docker buildx imagetools create manually"
              fi
            else
              echo "âš ï¸  Could not obtain authentication token"
              echo "ğŸ“ Individual architecture images are available at:"
              echo "   - $temp_amd64"
              echo "   - $temp_arm64"
              echo "ğŸ’¡ You can create the multi-arch manifest manually using:"
              echo "   docker buildx imagetools create -t $final_target $temp_amd64 $temp_arm64"
            fi
            
            # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            rm -f /tmp/manifest-list.json
            
            # æ¸…ç†ä¸´æ—¶é•œåƒæ ‡ç­¾ï¼ˆå¯é€‰ï¼Œä¿ç•™å®ƒä»¬ä¹Ÿä¸å½±å“ä½¿ç”¨ï¼‰
            echo "ğŸ§¹ Cleaning up temporary tags..."
            skopeo delete "docker://$temp_amd64" 2>/dev/null || true
            skopeo delete "docker://$temp_arm64" 2>/dev/null || true
          done
        done

    - name: Summary
      if: always()
      run: |
        echo "ğŸ Processing completed"
        echo "=== Final disk space ==="
        df -h
