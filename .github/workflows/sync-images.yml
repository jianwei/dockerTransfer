name: Sync Multi-Arch Docker Images to Alibaba Cloud

on:
  workflow_dispatch:
    inputs:
      image_name:
        description: 'Specific image to sync (e.g., centos, nginx). Leave empty for all images.'
        required: false
        type: string
  schedule:
    - cron: '0 2 * * *'

jobs:
  sync-images:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Login to Alibaba Cloud Container Registry
      uses: docker/login-action@v2
      with:
        registry: ${{ secrets.ALIYUN_REGISTRY }}
        username: ${{ secrets.ALIYUN_USERNAME }}
        password: ${{ secrets.ALIYUN_PASSWORD }}

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y jq curl

    - name: Debug - Show resp.json content
      run: |
        echo "=== Check if resp.json exists ==="
        ls -la
        echo ""
        
        echo "=== resp.json content ==="
        if [ -f "resp.json" ]; then
          cat resp.json
          echo ""
          echo "=== Validate JSON ==="
          jq '.' resp.json
        else
          echo "‚ùå resp.json not found"
          exit 1
        fi

    - name: Get latest tags from Docker Hub and merge with config
      id: get_tags
      run: |
        echo "=== Creating updated images config ==="
        echo "[" > images_updated.json
        
        count=$(jq 'length' resp.json)
        echo "Found $count images in resp.json"
        
        for i in $(seq 0 $((count-1))); do
          target=$(jq -r ".[$i].target" resp.json)
          
          # If source exists in config, use it, otherwise use target as source
          source_exists=$(jq ".[$i] | has(\"source\")" resp.json)
          if [ "$source_exists" = "true" ]; then
            source_base=$(jq -r ".[$i].source" resp.json)
          else
            source_base="$target"
          fi
          
          # Get architectures from config, default to amd64 and arm64
          arch_exists=$(jq ".[$i] | has(\"architectures\")" resp.json)
          if [ "$arch_exists" = "true" ]; then
            architectures_array=$(jq ".[$i].architectures" resp.json)
          else
            architectures_array='["amd64", "arm64"]'
          fi
          
          echo "Processing $source_base -> $target"
          echo "Architectures: $(echo "$architectures_array" | jq -r '.[]')"
          
          # Get tags from config
          config_tags_array=$(jq ".[$i].tags | if type == \"array\" then . else [] end" resp.json)
          config_tags_count=$(echo "$config_tags_array" | jq 'length')
          echo "Config tags count: $config_tags_count"
          echo "Config tags: $(echo "$config_tags_array" | jq -r '.[]')"
          
          # Get latest 10 tags from Docker Hub API
          echo "Fetching latest tags for $source_base..."
          
          # Try library/ prefix first (for official images)
          tags_data=$(curl -s "https://hub.docker.com/v2/repositories/library/${source_base}/tags/?page_size=10&page=1" 2>/dev/null || echo '{"results":[]}')
          
          # Extract tag names
          latest_tags_array=$(echo "$tags_data" | jq -r '.results[].name' | head -10 | jq -R . | jq -s .)
          
          # If no tags found, try without library prefix
          if [ "$(echo "$latest_tags_array" | jq 'length')" -eq 0 ] || [ "$(echo "$tags_data" | jq -r '.results | length')" -eq 0 ]; then
            echo "Trying without library prefix..."
            tags_data=$(curl -s "https://hub.docker.com/v2/repositories/${source_base}/tags/?page_size=10&page=1" 2>/dev/null || echo '{"results":[]}')
            latest_tags_array=$(echo "$tags_data" | jq -r '.results[].name' | head -10 | jq -R . | jq -s .)
          fi
          
          echo "Latest tags count: $(echo "$latest_tags_array" | jq 'length')"
          echo "Latest tags: $(echo "$latest_tags_array" | jq -r '.[]')"
          
          # Merge config tags and latest tags, remove duplicates
          echo "Merging and deduplicating tags..."
          merged_tags_array=$(echo "{\"config\": $config_tags_array, \"latest\": $latest_tags_array}" | jq -c '[.config[], .latest[]] | unique')
          
          echo "Final merged tags count: $(echo "$merged_tags_array" | jq 'length')"
          echo "Final merged tags: $(echo "$merged_tags_array" | jq -r '.[]')"
          
          # Create new entry
          if [ $i -gt 0 ]; then
            echo "," >> images_updated.json
          fi
          
          echo "{" >> images_updated.json
          echo "  \"source_base\": \"$source_base\"," >> images_updated.json
          echo "  \"target\": \"$target\"," >> images_updated.json
          echo "  \"tags\": $(echo "$merged_tags_array" | jq -c .)," >> images_updated.json
          echo "  \"architectures\": $(echo "$architectures_array" | jq -c .)" >> images_updated.json
          echo "}" >> images_updated.json
        done
        
        echo "]" >> images_updated.json
        
        echo "=== Updated images config ==="
        cat images_updated.json
        echo ""

    - name: Process images with architecture validation
      run: |
        echo "=== Starting image processing ==="
        
        # Use updated config
        config_file="images_updated.json"
        
        # Check if specific image is requested
        specific_image="${{ github.event.inputs.image_name }}"
        if [ -n "$specific_image" ]; then
          echo "Filtering for specific image: $specific_image"
          jq --arg target "$specific_image" 'map(select(.target == $target))' "$config_file" > temp_config.json
          if [ "$(jq 'length' temp_config.json)" -gt 0 ]; then
            config_file="temp_config.json"
            echo "Filtered config:"
            cat temp_config.json
          else
            echo "No matching image found for $specific_image"
            exit 0
          fi
        fi
        
        # Read the JSON file
        count=$(jq 'length' "$config_file")
        echo "Found $count images to process"
        
        if [ "$count" -eq 0 ]; then
          echo "No images to process"
          exit 0
        fi
        
        # Process images
        success_count=0
        for i in $(seq 0 $((count-1))); do
          echo "=== Processing image $((i+1))/$count ==="
          
          # Extract values
          source_base=$(jq -r ".[$i].source_base" "$config_file")
          target=$(jq -r ".[$i].target" "$config_file")
          tag_count=$(jq ".[$i].tags | length" "$config_file")
          arch_count=$(jq ".[$i].architectures | length" "$config_file")
          
          echo "Source base: $source_base"
          echo "Target: $target"
          echo "Tag count: $tag_count"
          echo "Architecture count: $arch_count"
          
          if [ "$target" = "null" ] || [ "$tag_count" -eq 0 ] || [ "$arch_count" -eq 0 ]; then
            echo "‚ùå No data for index $i"
            continue
          fi
          
          # Get architectures array
          architectures_json=$(jq -c ".[$i].architectures" "$config_file")
          echo "Architectures: $(echo "$architectures_json" | jq -r '.[]')"
          
          # Process each tag
          for j in $(seq 0 $((tag_count-1))); do
            tag=$(jq -r ".[$i].tags[$j]" "$config_file")
            if [ "$tag" = "null" ] || [ -z "$tag" ]; then
              echo "‚ùå Invalid tag at index $j"
              continue
            fi
            
            source="${source_base}:${tag}"
            echo "üè∑Ô∏è  Processing tag: $tag ($source)"
            
            # Process each architecture
            for k in $(seq 0 $((arch_count-1))); do
              arch=$(echo "$architectures_json" | jq -r ".[$k]")
              if [ "$arch" = "null" ] || [ -z "$arch" ]; then
                echo "‚ùå Invalid architecture at index $k"
                continue
              fi
              
              echo "üñ•Ô∏è  Processing architecture: $arch"
              
              # Map short architecture names to full platform names
              case "$arch" in
                "amd64")
                  platform="linux/amd64"
                  arch_suffix="amd64"
                  ;;
                "arm64")
                  platform="linux/arm64"
                  arch_suffix="arm64"
                  ;;
                "arm")
                  platform="linux/arm/v7"
                  arch_suffix="arm"
                  ;;
                "arm/v7")
                  platform="linux/arm/v7"
                  arch_suffix="arm"
                  ;;
                "arm/v6")
                  platform="linux/arm/v6"
                  arch_suffix="arm-v6"
                  ;;
                "ppc64le")
                  platform="linux/ppc64le"
                  arch_suffix="ppc64le"
                  ;;
                "s390x")
                  platform="linux/s390x"
                  arch_suffix="s390x"
                  ;;
                *)
                  platform="linux/$arch"
                  arch_suffix="$arch"
                  ;;
              esac
              
              # Check if the specific architecture exists for this image:tag on Docker Hub
              echo "üîç Checking if $arch architecture exists for $source..."
              
              # Get manifest list to check available architectures
              arch_exists=false
              echo "Fetching manifest info for $source..."
              
              # Try to get manifest info using docker manifest inspect
              if manifest_info=$(docker manifest inspect "$source" 2>/dev/null); then
                echo "‚úÖ Successfully fetched manifest info"
                # Check if the specific platform exists in the manifest
                if echo "$manifest_info" | jq -e --arg platform "$platform" '.[] | select(.platform.os == "linux" and .platform.architecture == ($platform | split("/")[1]))' > /dev/null 2>&1; then
                  arch_exists=true
                  echo "‚úÖ Architecture $arch found in manifest"
                elif echo "$manifest_info" | jq -e --arg arch "$arch" '.[] | select(.platform.architecture == $arch)' > /dev/null 2>&1; then
                  arch_exists=true
                  echo "‚úÖ Architecture $arch found in manifest (alternative check)"
                else
                  echo "‚ö†Ô∏è  Architecture $arch NOT found in manifest, checking with platform $platform"
                  # Try pulling with specific platform to verify
                  if docker pull --platform "$platform" --quiet "$source" 2>/dev/null; then
                    arch_exists=true
                    echo "‚úÖ Architecture $arch verified by successful pull"
                    # Remove the pulled image to save space
                    docker rmi "$source" || true
                  else
                    echo "‚ùå Architecture $arch NOT available for $source"
                  fi
                fi
              else
                echo "‚ö†Ô∏è  Could not fetch manifest info, trying direct pull..."
                # Fallback: try direct pull to verify architecture existence
                if docker pull --platform "$platform" --quiet "$source" 2>/dev/null; then
                  arch_exists=true
                  echo "‚úÖ Architecture $arch verified by successful pull"
                  # Remove the pulled image to save space
                  docker rmi "$source" || true
                else
                  echo "‚ùå Architecture $arch NOT available for $source"
                fi
              fi
              
              # Skip this architecture if it doesn't exist
              if [ "$arch_exists" = false ]; then
                echo "‚è≠Ô∏è  Skipping $arch for $source - not available"
                continue
              fi
              
              # Process this architecture since it exists
              echo "üì• Architecture $arch is available, proceeding with download..."
              arch_success=false
              arch_target="${{ secrets.ALIYUN_REGISTRY }}/${{ secrets.ALIYUN_NAMESPACE }}/${target}-${arch_suffix}:$tag"
              echo "üì• Pulling $source for $platform..."
              if docker pull --platform "$platform" "$source"; then
                echo "‚úÖ $arch pull successful"
                echo "üì¶ Tagging as $arch_target"
                if docker tag "$source" "$arch_target"; then
                  echo "‚úÖ Tag successful"
                  echo "üì§ Pushing to registry..."
                  if docker push "$arch_target"; then
                    echo "‚úÖ $arch version pushed successfully: $arch_target"
                    arch_success=true
                  else
                    echo "‚ùå Failed to push $arch version"
                  fi
                  docker rmi "$source" || true
                else
                  echo "‚ùå Failed to tag $arch version"
                  docker rmi "$source" || true
                fi
                docker rmi "$arch_target" || true
              else
                echo "‚ùå Failed to pull $arch version of $source"
              fi
              
              # Count success
              if [ "$arch_success" = true ]; then
                success_count=$((success_count + 1))
              fi
            done
          done
        done
        
        echo "=== Processing Summary ==="
        echo "Total successful uploads: $success_count"

    - name: Summary
      if: always()
      run: |
        echo "üèÅ Sync process completed"
        echo "Repository: ${{ github.repository }}"
        echo "Run ID: ${{ github.run_id }}"
        echo "Registry: ${{ secrets.ALIYUN_REGISTRY }}/${{ secrets.ALIYUN_NAMESPACE }}"
        echo "=== Recent Docker images in registry ==="
        docker images | grep "${{ secrets.ALIYUN_NAMESPACE }}" | head -20 || echo "No images found"
