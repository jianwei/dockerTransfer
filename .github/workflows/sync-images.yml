name: Sync2

on:
  workflow_dispatch:
    inputs:
      image_name:
        description: 'Specific image to sync (e.g., centos, nginx). Leave empty for all images.'
        required: false
        type: string
  schedule:
    - cron: '0 2 * * *'

jobs:
  sync-images:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Login to Alibaba Cloud Container Registry
      uses: docker/login-action@v2
      with:
        registry: ${{ secrets.ALIYUN_REGISTRY }}
        username: ${{ secrets.ALIYUN_USERNAME }}
        password: ${{ secrets.ALIYUN_PASSWORD }}

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y jq curl

    - name: Validate and process config
      run: |
        echo "=== Validating images.json ==="
        
        # Check if file exists
        if [ ! -f "images.json" ]; then
          echo "‚ùå images.json not found"
          exit 1
        fi
        
        # Show content
        echo "File content:"
        cat images.json
        echo ""
        
        # Validate JSON
        if ! jq empty images.json; then
          echo "‚ùå Invalid JSON format"
          exit 1
        fi
        
        # Check if it's an array
        if ! jq -e 'type == "array"' images.json > /dev/null; then
          echo "‚ùå JSON must be an array"
          exit 1
        fi
        
        # Process each item
        count=$(jq 'length' images.json)
        echo "Found $count images to process"
        echo "[" > images_processed.json
        
        for i in $(seq 0 $((count-1))); do
          echo "Processing item $i..."
          
          # Get source (required)
          source=$(jq -r ".[$i].source // empty" images.json)
          if [ -z "$source" ]; then
            echo "‚ö†Ô∏è  Skipping item $i - no source"
            continue
          fi
          
          # Get target (default to extracted name from source)
          target=$(jq -r ".[$i].target // empty" images.json)
          if [ -z "$target" ]; then
            # Extract image name from source (remove tag part)
            target=$(echo "$source" | cut -d: -f1 | awk -F'/' '{print $NF}')
            echo "‚ö†Ô∏è  No target specified, using extracted name: $target"
          fi
          
          # Get architectures (default to amd64,arm64)
          if jq -e ".[$i].architectures | type == \"array\"" images.json > /dev/null; then
            archs=$(jq -c ".[$i].architectures" images.json)
          else
            archs='["amd64","arm64"]'
          fi
          
          # Get tags (must exist)
          if jq -e ".[$i].tags | type == \"array\"" images.json > /dev/null; then
            tags=$(jq -c ".[$i].tags" images.json)
          else
            echo "‚ö†Ô∏è  Skipping $target - no valid tags"
            continue
          fi
          
          # Extract base image name from source (remove tag)
          base_image=$(echo "$source" | cut -d: -f1)
          
          # Add to processed file
          if [ $i -gt 0 ]; then
            echo "," >> images_processed.json
          fi
          
          jq -n --arg source "$base_image" --arg target "$target" --argjson tags "$tags" --argjson archs "$archs" '{
            source: $source,
            target: $target,
            tags: $tags,
            architectures: $archs
          }' >> images_processed.json
        done
        
        echo "]" >> images_processed.json
        echo "=== Processed config ==="
        cat images_processed.json

    - name: Sync images
      run: |
        echo "=== Starting sync process ==="
        
        if [ ! -f "images_processed.json" ]; then
          echo "‚ùå Processed config not found"
          exit 1
        fi
        
        count=$(jq 'length' images_processed.json)
        echo "Processing $count images"
        
        if [ "$count" -eq 0 ]; then
          echo "No images to process"
          exit 0
        fi
        
        success_total=0
        
        for i in $(seq 0 $((count-1))); do
          source=$(jq -r ".[$i].source" images_processed.json)
          target=$(jq -r ".[$i].target" images_processed.json)
          tags_json=$(jq -c ".[$i].tags" images_processed.json)
          archs_json=$(jq -c ".[$i].architectures" images_processed.json)
          
          tag_count=$(echo "$tags_json" | jq 'length')
          arch_count=$(echo "$archs_json" | jq 'length')
          
          echo "=== Processing $source ‚Üí $target ($tag_count tags, $arch_count architectures) ==="
          
          # Process each tag
          for j in $(seq 0 $((tag_count-1))); do
            tag=$(echo "$tags_json" | jq -r ".[$j]")
            image_ref="${source}:${tag}"
            echo "üè∑Ô∏è  Tag: $tag"
            
            # Process each architecture
            for k in $(seq 0 $((arch_count-1))); do
              arch=$(echo "$archs_json" | jq -r ".[$k]")
              echo "üñ•Ô∏è  Architecture: $arch"
              
              # Map arch to platform
              case "$arch" in
                "amd64") platform="linux/amd64"; suffix="amd64" ;;
                "arm64") platform="linux/arm64"; suffix="arm64" ;;
                "arm") platform="linux/arm/v7"; suffix="arm" ;;
                *) platform="linux/$arch"; suffix="$arch" ;;
              esac
              
              # Check if arch exists (simple check)
              echo "üîç Checking $arch availability..."
              if timeout 30s docker pull --platform "$platform" --quiet "$image_ref" 2>/dev/null; then
                echo "‚úÖ $arch available"
                docker rmi "$image_ref" || true
                
                # Actually pull and push
                final_name="${{ secrets.ALIYUN_REGISTRY }}/${{ secrets.ALIYUN_NAMESPACE }}/${target}-${suffix}:${tag}"
                echo "üì• Pulling $image_ref ($arch)..."
                if docker pull --platform "$platform" "$image_ref"; then
                  echo "üì¶ Tagging as $final_name"
                  if docker tag "$image_ref" "$final_name"; then
                    echo "üì§ Pushing to registry..."
                    if docker push "$final_name"; then
                      echo "‚úÖ Pushed successfully"
                      success_total=$((success_total + 1))
                    fi
                    docker rmi "$final_name" || true
                  fi
                  docker rmi "$image_ref" || true
                fi
              else
                echo "‚è≠Ô∏è  $arch not available, skipping"
              fi
            done
          done
        done
        
        echo "=== Summary ==="
        echo "Successfully processed: $success_total images"

    - name: Cleanup
      if: always()
      run: |
        echo "üßπ Cleaning up..."
        docker system prune -f || true
