name: Sync  Docker Images to Alibaba Cloud

on:
  workflow_dispatch:
    inputs:
      image_name:
        description: 'Specific image to sync (e.g., centos, nginx). Leave empty for all images.'
        required: false
        type: string
  schedule:
    - cron: '0 2 * * *'

jobs:
  sync-images:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Login to Alibaba Cloud Container Registry
      uses: docker/login-action@v2
      with:
        registry: ${{ secrets.ALIYUN_REGISTRY }}
        username: ${{ secrets.ALIYUN_USERNAME }}
        password: ${{ secrets.ALIYUN_PASSWORD }}

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y jq curl

    - name: Debug - Show resp.json content
      run: |
        echo "=== Check if resp.json exists ==="
        ls -la
        echo ""
        
        echo "=== resp.json content ==="
        if [ -f "resp.json" ]; then
          cat resp.json
          echo ""
          echo "=== Validate JSON ==="
          jq '.' resp.json
        else
          echo "‚ùå resp.json not found"
          exit 1
        fi

    - name: Get latest tags from Docker Hub
      id: get_tags
      run: |
        echo "=== Creating updated images config ==="
        echo "[" > images_updated.json
        
        count=$(jq 'length' resp.json)
        echo "Found $count images in resp.json"
        
        for i in $(seq 0 $((count-1))); do
          target=$(jq -r ".[$i].target" resp.json)
          
          # If source exists in config, use it, otherwise use target as source
          source_exists=$(jq ".[$i] | has(\"source\")" resp.json)
          if [ "$source_exists" = "true" ]; then
            source_base=$(jq -r ".[$i].source" resp.json)
          else
            source_base="$target"
          fi
          
          echo "Processing $source_base -> $target"
          
          # Get latest 10 tags from Docker Hub API
          echo "Fetching tags for $source_base..."
          
          # Try library/ prefix first (for official images)
          tags_data=$(curl -s "https://hub.docker.com/v2/repositories/library/${source_base}/tags/?page_size=10&page=1" 2>/dev/null || echo '{"results":[]}')
          
          # Extract tag names
          tags_array=$(echo "$tags_data" | jq -r '.results[].name' | head -10 | jq -R . | jq -s .)
          
          # If no tags found, try without library prefix
          if [ "$(echo "$tags_array" | jq 'length')" -eq 0 ] || [ "$(echo "$tags_data" | jq -r '.results | length')" -eq 0 ]; then
            echo "Trying without library prefix..."
            tags_data=$(curl -s "https://hub.docker.com/v2/repositories/${source_base}/tags/?page_size=10&page=1" 2>/dev/null || echo '{"results":[]}')
            tags_array=$(echo "$tags_data" | jq -r '.results[].name' | head -10 | jq -R . | jq -s .)
          fi
          
          echo "Found $(echo "$tags_array" | jq 'length') tags"
          
          # Show found tags for debugging
          echo "Tags: $(echo "$tags_array" | jq -r '.[]')"
          
          # Create new entry
          if [ $i -gt 0 ]; then
            echo "," >> images_updated.json
          fi
          
          echo "{" >> images_updated.json
          echo "  \"source_base\": \"$source_base\"," >> images_updated.json
          echo "  \"target\": \"$target\"," >> images_updated.json
          echo "  \"tags\": $(echo "$tags_array" | jq -c .)" >> images_updated.json
          echo "}" >> images_updated.json
        done
        
        echo "]" >> images_updated.json
        
        echo "=== Updated images config ==="
        cat images_updated.json
        echo ""

    - name: Process images with latest tags
      run: |
        echo "=== Starting image processing ==="
        
        # Use updated config
        config_file="images_updated.json"
        
        # Check if specific image is requested
        specific_image="${{ github.event.inputs.image_name }}"
        if [ -n "$specific_image" ]; then
          echo "Filtering for specific image: $specific_image"
          jq --arg target "$specific_image" 'map(select(.target == $target))' "$config_file" > temp_config.json
          if [ "$(jq 'length' temp_config.json)" -gt 0 ]; then
            config_file="temp_config.json"
            echo "Filtered config:"
            cat temp_config.json
          else
            echo "No matching image found for $specific_image"
            exit 0
          fi
        fi
        
        # Read the JSON file
        count=$(jq 'length' "$config_file")
        echo "Found $count images to process"
        
        if [ "$count" -eq 0 ]; then
          echo "No images to process"
          exit 0
        fi
        
        # Process images
        success_count=0
        for i in $(seq 0 $((count-1))); do
          echo "=== Processing image $((i+1))/$count ==="
          
          # Extract values
          source_base=$(jq -r ".[$i].source_base" "$config_file")
          target=$(jq -r ".[$i].target" "$config_file")
          tag_count=$(jq ".[$i].tags | length" "$config_file")
          
          echo "Source base: $source_base"
          echo "Target: $target"
          echo "Tag count: $tag_count"
          
          if [ "$target" = "null" ] || [ "$tag_count" -eq 0 ]; then
            echo "‚ùå No data for index $i"
            continue
          fi
          
          # Process each tag
          for j in $(seq 0 $((tag_count-1))); do
            tag=$(jq -r ".[$i].tags[$j]" "$config_file")
            if [ "$tag" = "null" ] || [ -z "$tag" ]; then
              echo "‚ùå Invalid tag at index $j"
              continue
            fi
            
            source="${source_base}:${tag}"
            echo "üè∑Ô∏è  Processing tag: $tag ($source)"
            
            # Process amd64 version
            amd64_success=false
            amd64_target="${{ secrets.ALIYUN_REGISTRY }}/${{ secrets.ALIYUN_NAMESPACE }}/${target}-amd64:$tag"
            echo "üì• Pulling $source for amd64..."
            if docker pull --platform linux/amd64 "$source"; then
              echo "‚úÖ amd64 pull successful"
              echo "üì¶ Tagging as $amd64_target"
              if docker tag "$source" "$amd64_target"; then
                echo "‚úÖ Tag successful"
                echo "üì§ Pushing to registry..."
                if docker push "$amd64_target"; then
                  echo "‚úÖ amd64 version pushed successfully: $amd64_target"
                  amd64_success=true
                else
                  echo "‚ùå Failed to push amd64 version"
                fi
                docker rmi "$source" || true
              else
                echo "‚ùå Failed to tag amd64 version"
                docker rmi "$source" || true
              fi
              docker rmi "$amd64_target" || true
            else
              echo "‚ùå Failed to pull amd64 version of $source"
            fi
            
            # Process arm64 version
            arm64_success=false
            arm64_target="${{ secrets.ALIYUN_REGISTRY }}/${{ secrets.ALIYUN_NAMESPACE }}/${target}-arm64:$tag"
            echo "üì• Pulling $source for arm64..."
            if docker pull --platform linux/arm64 "$source"; then
              echo "‚úÖ arm64 pull successful"
              echo "üì¶ Tagging as $arm64_target"
              if docker tag "$source" "$arm64_target"; then
                echo "‚úÖ Tag successful"
                echo "üì§ Pushing to registry..."
                if docker push "$arm64_target"; then
                  echo "‚úÖ arm64 version pushed successfully: $arm64_target"
                  arm64_success=true
                else
                  echo "‚ùå Failed to push arm64 version"
                fi
                docker rmi "$source" || true
              else
                echo "‚ùå Failed to tag arm64 version"
                docker rmi "$source" || true
              fi
              docker rmi "$arm64_target" || true
            else
              echo "‚ùå Failed to pull arm64 version of $source"
            fi
            
            # Count success
            if [ "$amd64_success" = true ] || [ "$arm64_success" = true ]; then
              success_count=$((success_count + 1))
            fi
          done
        done
        
        echo "=== Processing Summary ==="
        echo "Total successful uploads: $success_count"

    - name: Summary
      if: always()
      run: |
        echo "üèÅ Sync process completed"
        echo "Repository: ${{ github.repository }}"
        echo "Run ID: ${{ github.run_id }}"
        echo "Registry: ${{ secrets.ALIYUN_REGISTRY }}/${{ secrets.ALIYUN_NAMESPACE }}"
        echo "=== Recent Docker images in registry ==="
        docker images | grep "${{ secrets.ALIYUN_NAMESPACE }}" | head -20 || echo "No images found"
