name: Fix Image Sync to Aliyun

on:
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Login to Aliyun
      uses: docker/login-action@v3
      with:
        registry: registry.cn-hangzhou.aliyuncs.com
        username: ${{ secrets.ALIYUN_USERNAME }}
        password: ${{ secrets.ALIYUN_PASSWORD }}

    - name: Sync vllm image
      run: |
        echo "=== Starting sync ==="
        
        SOURCE="vllm/vllm-openai:v0.11.0"
        TARGET="registry.cn-hangzhou.aliyuncs.com/${{ secrets.ALIYUN_NAMESPACE }}/vllm-openai:v0.11.0"
        
        echo "Source: $SOURCE"
        echo "Target: $TARGET"
        
        # æ¸…ç†ç©ºé—´
        docker system prune -f
        
        # æ‹‰å–é•œåƒ
        echo "ğŸ“¥ Pulling source image..."
        docker pull "$SOURCE"
        
        # æ ‡è®°é•œåƒ
        echo "ğŸ·ï¸ Tagging image..."
        docker tag "$SOURCE" "$TARGET"
        
        # æ¨é€é•œåƒ
        echo "ğŸ“¤ Pushing to Aliyun..."
        docker push "$TARGET"
        
        echo "âœ… Push command completed"
        
    - name: Verify sync
      run: |
        echo "=== Verification ==="
        TARGET="registry.cn-hangzhou.aliyuncs.com/${{ secrets.ALIYUN_NAMESPACE }}/vllm-openai:v0.11.0"
        
        echo "Checking: $TARGET"
        if docker pull "$TARGET"; then
          echo "ğŸ‰ SUCCESS: Image is now in Aliyun!"
          echo "Image details:"
          docker images "$TARGET"
        else
          echo "âŒ FAILED: Image not found in Aliyun"
        fi