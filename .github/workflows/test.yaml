name: Debug Image Sync

on:
  workflow_dispatch:

jobs:
  debug-sync:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Login to Aliyun
      uses: docker/login-action@v3
      with:
        registry: registry.cn-hangzhou.aliyuncs.com
        username: ${{ secrets.ALIYUN_USERNAME }}
        password: ${{ secrets.ALIYUN_PASSWORD }}

    - name: Debug info
      run: |
        echo "=== System Info ==="
        echo "Disk space:"
        df -h
        echo "Docker info:"
        docker system df
        
    - name: Method 1 - Skopeo with auth
      run: |
        echo "=== Method 1: Skopeo with authentication ==="
        SOURCE="vllm/vllm-openai:v0.11.0"
        TARGET="registry.cn-hangzhou.aliyuncs.com/${{ secrets.ALIYUN_NAMESPACE }}/vllm-openai:v0.11.0"
        
        # 使用认证信息
        skopeo copy \
          --dest-creds="${{ secrets.ALIYUN_USERNAME }}:${{ secrets.ALIYUN_PASSWORD }}" \
          --src-tls-verify=false \
          --dest-tls-verify=false \
          --retry-times 2 \
          "docker://$SOURCE" \
          "docker://$TARGET"
          
    - name: Method 2 - Docker buildx
      if: failure()
      run: |
        echo "=== Method 2: Docker Buildx ==="
        docker buildx create --use
        docker buildx imagetools create \
          --tag registry.cn-hangzhou.aliyuncs.com/${{ secrets.ALIYUN_NAMESPACE }}/vllm-openai:v0.11.0 \
          vllm/vllm-openai:v0.11.0

    - name: Final verification
      run: |
        echo "=== Final Check ==="
        # 列出阿里云仓库中的所有镜像
        echo "Images in namespace:"
        curl -s -u "${{ secrets.ALIYUN_USERNAME }}:${{ secrets.ALIYUN_PASSWORD }}" \
          "https://registry.cn-hangzhou.aliyuncs.com/v2/${{ secrets.ALIYUN_NAMESPACE }}/vllm-openai/tags/list" | jq .