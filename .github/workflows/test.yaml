name: Sync Large Image to Aliyun

on:
  workflow_dispatch:

jobs:
  sync-large-image:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup and cleanup
      run: |
        echo "=== Initial disk space ==="
        df -h
        
        # ÂÆâË£ÖÂøÖË¶ÅÂ∑•ÂÖ∑
        sudo apt-get update
        sudo apt-get install -y skopeo jq
        
        # ÊúÄÂ§ßÁ®ãÂ∫¶Ê∏ÖÁêÜÁ©∫Èó¥
        echo "üßπ Cleaning up disk space..."
        sudo docker system prune -af || true
        sudo rm -rf /usr/local/lib/android/sdk/extras || true
        sudo rm -rf /usr/share/dotnet/sdk/NuGetFallbackFolder || true
        
        echo "=== Disk space after cleanup ==="
        df -h

    - name: Login to Aliyun
      run: |
        skopeo login \
          --username "${{ secrets.ALIYUN_USERNAME }}" \
          --password "${{ secrets.ALIYUN_PASSWORD }}" \
          registry.cn-hangzhou.aliyuncs.com

    - name: Sync image with skopeo
      run: |
        echo "=== Starting image sync ==="
        
        SOURCE="vllm/vllm-openai:v0.11.0"
        TARGET="registry.cn-hangzhou.aliyuncs.com/${{ secrets.ALIYUN_NAMESPACE }}/vllm-openai:v0.11.0"
        
        echo "Source: $SOURCE"
        echo "Target: $TARGET"
        
        # ‰ΩøÁî® skopeo Áõ¥Êé•Â§çÂà∂Ôºà‰∏çÂç†Áî®Êú¨Âú∞Á£ÅÁõòÔºâ
        if skopeo copy \
          --src-tls-verify=false \
          --dest-tls-verify=false \
          --retry-times 5 \
          --debug \
          "docker://$SOURCE" \
          "docker://$TARGET"; then
          
          echo "üéâ SUCCESS: Image synced to Aliyun!"
        else
          echo "‚ùå FAILED: Sync failed"
          exit 1
        fi

    - name: Verify sync
      run: |
        echo "=== Verifying sync ==="
        TARGET="registry.cn-hangzhou.aliyuncs.com/${{ secrets.ALIYUN_NAMESPACE }}/vllm-openai:v0.11.0"
        
        if skopeo inspect "docker://$TARGET" > /dev/null 2>&1; then
          echo "‚úÖ VERIFIED: Image exists in Aliyun"
          skopeo inspect "docker://$TARGET" | jq '.Name, .Digest'
        else
          echo "‚ùå Image not found in Aliyun"
        fi