name: Sync images

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *'

jobs:
  sync-images:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup and cleanup
      run: |
        echo "=== Initial disk space ==="
        df -h
        
        # å®‰è£…å¿…è¦å·¥å…·
        sudo apt-get update
        sudo apt-get install -y jq
        
        # æœ€å¤§ç¨‹åº¦æ¸…ç†ç©ºé—´
        echo "ğŸ§¹ Cleaning up disk space..."
        sudo docker system prune -af || true
        sudo rm -rf /usr/local/lib/android/sdk/extras || true
        sudo rm -rf /usr/share/dotnet/sdk/NuGetFallbackFolder || true
        
        echo "=== Disk space after cleanup ==="
        df -h

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Login to Alibaba Cloud Container Registry
      uses: docker/login-action@v2
      with:
        registry: registry.cn-hangzhou.aliyuncs.com
        username: ${{ secrets.ALIYUN_USERNAME }}
        password: ${{ secrets.ALIYUN_PASSWORD }}

    - name: Process images
      run: |
        echo "=== Starting image processing ==="
        
        # Read the JSON file directly in the shell
        count=$(jq 'length' images.json)
        echo "Found $count images to process"
        
        # Simple loop with proper error handling
        for i in $(seq 0 $((count-1))); do
          echo "=== Processing image $((i+1)) ==="
          
          # Extract values one by one with error checking
          source=$(jq -r ".[$i].source" images.json)
          target=$(jq -r ".[$i].target" images.json)
          tag_count=$(jq ".[$i].tags | length" images.json)
          
          echo "Source: $source"
          echo "Target: $target"
          echo "Tag count: $tag_count"
          
          if [ "$source" = "null" ] || [ "$target" = "null" ]; then
            echo "âŒ Invalid data at index $i"
            continue
          fi
          
          # Process tags - create multi-arch manifest
          for j in $(seq 0 $((tag_count-1))); do
            tag=$(jq -r ".[$i].tags[$j]" images.json)
            echo "ğŸ·ï¸  Processing tag: $tag"
            
            # æ„å»ºæœ€ç»ˆç›®æ ‡é•œåƒåç§°
            final_target="registry.cn-hangzhou.aliyuncs.com/${{ secrets.ALIYUN_NAMESPACE }}/${target}:${tag}"
            
            # ä¸´æ—¶é•œåƒæ ‡ç­¾ï¼Œç”¨äºæ„å»ºå¤šæ¶æ„ manifest
            temp_amd64="registry.cn-hangzhou.aliyuncs.com/${{ secrets.ALIYUN_NAMESPACE }}/${target}:${tag}-amd64-temp"
            temp_arm64="registry.cn-hangzhou.aliyuncs.com/${{ secrets.ALIYUN_NAMESPACE }}/${target}:${tag}-arm64-temp"
            
            # ç¡®å®šæºé•œåƒåç§°ï¼šå¦‚æœ source å·²åŒ…å«æ ‡ç­¾åˆ™ç›´æ¥ä½¿ç”¨ï¼Œå¦åˆ™æ·»åŠ  tag
            if echo "$source" | grep -q ":"; then
              source_image="$source"
            else
              source_image="${source}:${tag}"
            fi
            
            # æ‹‰å–å¹¶æ¨é€ amd64 ç‰ˆæœ¬åˆ°ä¸´æ—¶æ ‡ç­¾
            echo "ğŸ“¥ Pulling $source_image for amd64..."
            pulled_amd64_image=""
            if docker pull --platform linux/amd64 "$source_image"; then
              echo "âœ… amd64 pull successful"
              # è·å–æ‹‰å–åçš„é•œåƒIDæˆ–åç§°
              pulled_amd64_image=$(docker images --format "{{.Repository}}:{{.Tag}}" --filter "reference=$source_image" | head -n1)
              if [ -z "$pulled_amd64_image" ]; then
                pulled_amd64_image="$source_image"
              fi
              echo "ğŸ“¦ Tagging as $temp_amd64"
              if docker tag "$pulled_amd64_image" "$temp_amd64"; then
                echo "ğŸ“¤ Pushing amd64 to temporary tag..."
                if docker push "$temp_amd64"; then
                  echo "âœ… amd64 version pushed successfully"
                else
                  echo "âŒ Failed to push amd64 version"
                  docker rmi "$pulled_amd64_image" "$temp_amd64" 2>/dev/null || true
                  continue
                fi
              else
                echo "âŒ Failed to tag amd64 version"
                docker rmi "$pulled_amd64_image" 2>/dev/null || true
                continue
              fi
              # Clean up local amd64 image
              docker rmi "$pulled_amd64_image" 2>/dev/null || true
            else
              echo "âŒ Failed to pull amd64 version"
              continue
            fi
            
            # æ‹‰å–å¹¶æ¨é€ arm64 ç‰ˆæœ¬åˆ°ä¸´æ—¶æ ‡ç­¾
            echo "ğŸ“¥ Pulling $source_image for arm64..."
            pulled_arm64_image=""
            if docker pull --platform linux/arm64 "$source_image"; then
              echo "âœ… arm64 pull successful"
              # è·å–æ‹‰å–åçš„é•œåƒIDæˆ–åç§°
              pulled_arm64_image=$(docker images --format "{{.Repository}}:{{.Tag}}" --filter "reference=$source_image" | head -n1)
              if [ -z "$pulled_arm64_image" ]; then
                pulled_arm64_image="$source_image"
              fi
              echo "ğŸ“¦ Tagging as $temp_arm64"
              if docker tag "$pulled_arm64_image" "$temp_arm64"; then
                echo "ğŸ“¤ Pushing arm64 to temporary tag..."
                if docker push "$temp_arm64"; then
                  echo "âœ… arm64 version pushed successfully"
                else
                  echo "âŒ Failed to push arm64 version"
                  docker rmi "$pulled_arm64_image" "$temp_arm64" 2>/dev/null || true
                  continue
                fi
              else
                echo "âŒ Failed to tag arm64 version"
                docker rmi "$pulled_arm64_image" 2>/dev/null || true
                continue
              fi
              # Clean up local arm64 image
              docker rmi "$pulled_arm64_image" 2>/dev/null || true
            else
              echo "âŒ Failed to pull arm64 version"
              continue
            fi
            
            # ä½¿ç”¨ buildx imagetools åˆ›å»ºå¤šæ¶æ„ manifest
            echo "ğŸ”— Creating multi-arch manifest for $final_target"
            if docker buildx imagetools create -t "$final_target" "$temp_amd64" "$temp_arm64"; then
              echo "âœ… Multi-arch manifest created successfully: $final_target"
            else
              echo "âŒ Failed to create multi-arch manifest"
            fi
            
            # æ¸…ç†ä¸´æ—¶é•œåƒæ ‡ç­¾ï¼ˆå¯é€‰ï¼Œä¿ç•™å®ƒä»¬ä¹Ÿä¸å½±å“ä½¿ç”¨ï¼‰
            echo "ğŸ§¹ Cleaning up temporary tags..."
            docker buildx imagetools rm "$temp_amd64" 2>/dev/null || true
            docker buildx imagetools rm "$temp_arm64" 2>/dev/null || true
          done
        done

    - name: Summary
      if: always()
      run: |
        echo "ğŸ Processing completed"
        echo "=== Final Docker images ==="
        docker images | grep "${{ secrets.ALIYUN_NAMESPACE }}" || echo "No pushed images found"